<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è´¦å·ç»‘å®š</title>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Microsoft YaHei", "PingFang SC", "Helvetica Neue", Arial,
        sans-serif;
    }

    body {
      background: #f5f7fa;
      display: flex;
    }

    .hub-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .hub-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding: 20px;
      background: white;
      border-bottom: 1px solid #e9ecef;
      flex-shrink: 0;
    }

    .hub-header h1 {
      font-size: 24px;
      font-weight: 600;
      color: #333;
    }

    .hub-header p {
      font-size: 14px;
      color: #666;
    }

    .accounts-section {
      flex: 1;
      padding: 20px;
      background: #f5f7fa;
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow: hidden;
    }

    .accounts-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      row-gap: 16px;
      column-gap: 16px;
      width: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      padding-top: 10px;
    }

    @media (max-width: 1200px) {
      .accounts-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 900px) {
      .accounts-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .accounts-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .accounts-grid::-webkit-scrollbar {
      width: 6px;
    }

    .accounts-grid::-webkit-scrollbar-track {
      background: transparent;
    }

    .accounts-grid::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
    }

    .accounts-grid::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.3);
    }

    .account-card {
      border: 1px solid #dee2e6;
      border-radius: 20px;
      padding: 17px 16px;
      height: 252px;
      min-width: 0;
      max-width: 100%;
      transition: all 0.3s ease;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      position: relative;
    }

    .account-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
      border-color: #667eea;
    }

    .account-card-header {
      display: flex;
      align-items: flex-start;
    }

    .account-icon {
      font-size: 32px;
      width: 63px;
      height: 63px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 8px;
      flex-shrink: 0;
    }

    .account-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .account-platform {
      font-weight: bold;
      font-size: 15px;
      color: #2c2c36;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%;
      margin-top: 40px;
      margin-left: 15px;
    }

    .account-name {
      font-weight: 400;
      font-size: 14px;
      color: #585a73;
      margin-top: 17px;
    }

    .account-status-default {
      width: 63px;
      height: 16px;
      border-radius: 3px;
      display: flex;
      justify-content: center;
      font-weight: 400;
      font-size: 11px;
      color: #ffffff;
      background: #418dff;
    }

    .account-status-active {
      display: flex;
      justify-content: center;
      width: 63px;
      height: 16px;
      background: #00c433;
      border-radius: 3px;
      font-weight: 400;
      font-size: 11px;
      color: #ffffff;
    }

    .account-btn {
      width: 100px;
      height: 25px;
      border-radius: 3px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      /* ç§»é™¤è¾¹æ¡† */
      outline: none;
      /* ç§»é™¤ç„¦ç‚¹è½®å»“ */
      transition: all 0.3s ease;
      /* å¦‚æœéœ€è¦è¿‡æ¸¡æ•ˆæœ */
    }

    .enter-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .delete-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-left: 24px;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 40px 20px;
      text-align: center;
      background: white;
      border-radius: 12px;
      margin: 20px;
    }

    .empty-icon {
      font-size: 48px;
      opacity: 0.5;
    }

    .empty-text {
      font-size: 16px;
      color: #666;
    }

    .empty-subtext {
      font-size: 13px;
      color: #999;
    }

    @media (max-width: 768px) {
      .hub-header {
        padding: 16px;
      }

      .hub-header h1 {
        font-size: 20px;
      }

      .accounts-section {
        padding: 16px;
      }

      .accounts-grid {
        grid-template-columns: 1fr;
      }
    }

    /* ä¸»è´¦å·å¡ç‰‡æ ·å¼ */
    .main-account-card {
      border: 2px solid #0066cc;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 102, 204, 0.2);
    }

    /* çŠ¶æ€æ˜¾ç¤º */
    .account-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #28a745;
    }

    /* æ“ä½œæŒ‰é’® */
    .account-actions {
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      bottom: 23px;
      width: 100%;
    }

    /* æ–°å¢çš„ä¸»è´¦å·æ ‡è¯† */
    .main-account-badge {
      position: absolute;
      top: 24px;
      left: 94px;
      width: 20px;
      height: 20px;
      background: #D80000;
      border-radius: 3px;
      font-weight: normal;
      font-size: 11px;
      color: #FFFFFF;
      display: flex;
      /* align-items: center; */
      justify-content: center;
      padding-top: 2px;
    }

    /* è´¦å·ä¿¡æ¯å±•ç¤º */
    .account-details {
      display: flex;
      justify-content: space-between;
      margin: 17px 0 20px 0;
      padding: 0 5px;
    }

    .account-detail-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      min-width: 0;
    }

    .account-detail-label {
      font-weight: 400;
      font-size: 14px;
      color: #585A73;
      margin-bottom: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%;
      text-align: center;
    }

    .account-detail-value {
      font-weight: bold;
      font-size: 21px;
      color: #585A73;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%;
      text-align: center;
    }

    /* å¹³å°ä¸“å±æŒ‰é’®é¢œè‰² - ä¸¥æ ¼æŒ‰è¦æ±‚è®¾ç½® */
      .btn-color-baijia {
        background: #418dff !important;
      }
      .btn-color-sohu {
        background: #fb843f !important;
      }
      .btn-color-tencent {
        background: #fbc13f !important; /* è…¾è®¯å›ºå®šé¢œè‰² */
      }
      .btn-color-163 {
        background: #fb3b3b !important; /* ç½‘æ˜“å›ºå®šé¢œè‰² */
      }
      .btn-color-wechat {
        background: #6fd169 !important; /* å¾®ä¿¡å…¬ä¼—å·å›ºå®šé¢œè‰² */
      }
      .btn-color-wenxin{
        background: #3c43ff !important;
      }
      /* å¹³å°ä¸“å±å¡ç‰‡èƒŒæ™¯ */
      .card-bg-baijia {
        background: url("./images/baibg.png");
        background-repeat: no-repeat;
        background-size: 100% 100%;
      }
      .card-bg-sohu {
        background: url("./images/soubg.png");
        background-repeat: no-repeat;
        background-size: 100% 100%;
      }
      .card-bg-wechat {
        background: url("./images/weibg.png");
        background-repeat: no-repeat;
        background-size: 100% 100%;
      }
      .card-bg-163 {
        background: url("./images/wangbg.png");
        background-repeat: no-repeat;
        background-size: 100% 100%;
      }
      .card-bg-tencent {
        background: url("./images/tengbg.png");
        background-repeat: no-repeat;
        background-size: 100% 100%;
      }
      .card-bg-default {
        background: white;
      }
      /* æ–°å¢æ–‡å¿ƒæ™ºèƒ½ä½“èƒŒæ™¯å›¾ */
      .card-bg-wenxin {
          background: url("./images/wenbg.png");
          background-repeat: no-repeat;
          background-size: 100% 100%;
      }
  </style>
</head>

<body>
  <div class="hub-container">
    <div class="hub-header">
      <div>
        <h1 id="hubTitle">è´¦å·ç®¡ç†</h1>
        <!-- <p id="hubSubtitle">ç‚¹å‡»ä¸‹æ–¹å¡ç‰‡è¿›å…¥å¯¹åº”è´¦å·å¹³å°</p> -->
      </div>
    </div>
    <div class="accounts-section">
      <div class="accounts-grid" id="accountsGrid"></div>
    </div>
  </div>

  <script>
    // é˜²æŠ–å‡½æ•°
    function debounce(func, delay) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    let currentMenuId = null;
    let actualType = null; // å®é™…ç±»å‹ï¼Œç”¨äºæ¥å£è°ƒç”¨ï¼ˆç™¾å®¶å·å’Œæ–‡å¿ƒæ™ºèƒ½ä½“éƒ½ä¼ menuId:1ï¼Œä½†actualTypeä¸åŒï¼‰
    let navItems = [];
    let accounts = {};
    let showMultipleAccounts = false; // æ˜¯å¦æ˜¾ç¤ºå¤šä¸ªè´¦å·ï¼Œä¸»è¦ç”¨äºç™¾å®¶å·å’Œæ–‡å¿ƒæ™ºèƒ½ä½“
    let currentUserData = null; //ä½œä¸ºç”¨æˆ·æ•°æ®éš”ç¦»

    // å¹³å°é¢œè‰²æ˜ å°„è¡¨ - ä¸¥æ ¼æŒ‰è¦æ±‚é…ç½®
    const platformColorMap = {
      1: "btn-color-baijia", // ç™¾å®¶å· - #418DFF ï¼ˆå›ºå®šï¼‰
      2: "btn-color-sohu", // æœç‹ - #FB843F ï¼ˆå›ºå®šï¼‰
      6: "btn-color-tencent", // è…¾è®¯ - #FBC13Fï¼ˆå›ºå®šï¼‰
      8: "btn-color-163", // ç½‘æ˜“ - #FB3B3Bï¼ˆå›ºå®šï¼‰
      4: "btn-color-wechat", // å¾®ä¿¡å…¬ä¼—å· - #6FD169ï¼ˆå›ºå®šï¼‰
      9: 'btn-color-wenxin',// æ–‡å¿ƒæ™ºèƒ½ä½“ - #3c43ff ï¼ˆå›ºå®šï¼‰
    };

      // å¹³å°å¡ç‰‡èƒŒæ™¯æ˜ å°„è¡¨
      const platformCardBgMap = {
        1: "card-bg-baijia", // ç™¾å®¶å· - baibg.png
        2: "card-bg-sohu", // æœç‹ - soubg.png
        4: "card-bg-wechat", // å¾®ä¿¡å…¬ä¼—å· - weibg.png
        8: "card-bg-163", // ç½‘æ˜“ - wangbg.png
        6: "card-bg-tencent", // è…¾è®¯ - tengbg.png
        9: "card-bg-wenxin",
      };

    window.addEventListener("message", async (event) => {
      console.log("æ¥æ”¶åˆ°æ¶ˆæ¯", event.data);
      if (event.data.type === "selectMenu") {
        currentMenuId = event.data.menuId;
        // ä¿å­˜å®é™…ç±»å‹ï¼Œå¦‚æœæœ‰actualTypeåˆ™ä½¿ç”¨actualTypeï¼Œå¦åˆ™ä½¿ç”¨menuId
        actualType = event.data.actualType !== undefined ? event.data.actualType : event.data.menuId;
        navItems = event.data.navItems || [];
        if (event.data.userData) {
          currentUserData = event.data.userData;

          // ç¡®ä¿ accounts ç»“æ„å­˜åœ¨
          if (!accounts[currentUserData.sendId]) {
            accounts[currentUserData.sendId] = {};
          }
          // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºè“Vå¥—é¤ç”¨æˆ·
        //   showMultipleAccounts =  checkBlueVPackage(currentUserData.sendId);
        // }
            // å®‰å…¨åœ°è®¿é—® electronAPIï¼ˆå…¼å®¹ iframe ç¯å¢ƒï¼‰
            const electronAPI = window.electronAPI || (window.parent && window.parent.electronAPI);
            if (electronAPI && typeof electronAPI.checkBlueVPackage === "function") {
              blue_ensure = await electronAPI.checkBlueVPackage(currentUserData.sendId);
              showMultipleAccounts = blue_ensure.isBlueVPackage;
            } else {
              showMultipleAccounts = false; // é»˜è®¤éè“Vç”¨æˆ·
            }
          }
        console.log("å½“å‰ç”¨æˆ·æ˜¯å¦è“V", showMultipleAccounts);
        console.log("é€‰æ‹©èœå•", currentMenuId, "å®é™…ç±»å‹", actualType, "å¯¼èˆªé¡¹æ•°é‡", navItems.length);
        renderAccounts();
        setTimeout(debouncedUpdateAccountStatus, 100);
      } else if (event.data.type === "accountAuthorized") {
        // è´¦å·æˆæƒæˆåŠŸï¼Œåˆ·æ–°è´¦å·çŠ¶æ€
        console.log("æ”¶åˆ°è´¦å·æˆæƒæˆåŠŸæ¶ˆæ¯ï¼Œåˆ·æ–°è´¦å·çŠ¶æ€");
        debouncedUpdateAccountStatus();
      }
    });

    // è·å–è´¦å·çŠ¶æ€å¹¶æ›´æ–°æ˜¾ç¤º
    async function updateAccountStatus() {
      console.log("è°ƒç”¨äº†updateAccountStatusï¼Œå½“å‰æ•°æ®ä¸º:", currentUserData);
      console.log("èœå•IDä¸ºï¼š", currentMenuId);

      if (!currentMenuId || !currentUserData || !currentUserData.sendId) {
        console.log("æ›´æ–°è´¦æˆ·æ•°æ®æ—¶ç¼ºå°‘å¿…è¦æ•°æ®");
        return;
      }

      try {
        const electronAPI =
          window.electronAPI || (window.parent && window.parent.electronAPI);
        if (!electronAPI) {
          console.error("æ— æ³•è°ƒç”¨æ¥å£æ•°æ®");
          return;
        }

        // ä½¿ç”¨actualTypeä½œä¸ºæ¥å£è°ƒç”¨çš„typeå‚æ•°
        // å¦‚æœactualTypeå­˜åœ¨ï¼ˆå¦‚æ–‡å¿ƒæ™ºèƒ½ä½“ï¼‰ï¼Œä½¿ç”¨actualTypeï¼›å¦åˆ™ä½¿ç”¨menuId
        let platformType = actualType !== null ? actualType : currentMenuId;
        if (platformType === 9){
            platformType = 1
        }
        console.log(
          "æ­£åœ¨è°ƒç”¨ getAccountStatus å½“å‰ userId:",
          currentUserData.sendId,
          "menuId:",
          currentMenuId,
          "actualType:",
          actualType,
          "è°ƒç”¨æ¥å£type:",
          platformType,
        );
        const result = await electronAPI.getAccountStatus({
          userId: currentUserData.sendId,
          type: platformType,
        });

        console.log("%cè°ƒç”¨getAccountStatus ç»“æœä¸º:",'color: red; font-weight: bold;', result);
        console.log("æœåŠ¡å™¨è¿”å›çš„è´¦å·åˆ—è¡¨:", result.accounts);

        if (result.success) {
          if (!accounts[currentUserData.sendId]) {
            accounts[currentUserData.sendId] = {};
          }

          if (accounts[currentUserData.sendId][currentMenuId]) {
            let hasChanges = false;

            // åˆ›å»ºä¸€ä¸ªæ˜ å°„æ¥è·Ÿè¸ªå·²ç»ä½¿ç”¨çš„æœåŠ¡å™¨è´¦å·ï¼ˆä½¿ç”¨ acc_id ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼‰
            const usedServerAccountIds = new Set();

            // å…ˆæŒ‰ position æ’åºæœåŠ¡å™¨è´¦å·ï¼Œç¡®ä¿åŒ¹é…é¡ºåºæ­£ç¡®
            const sortedServerAccounts = [...result.accounts].sort((a, b) => {
              const posA = a.position || 0;
              const posB = b.position || 0;
              return posA - posB;
            });
            console.log("sortedServerAccounts:", sortedServerAccounts)
            console.log("currentMenuId:", currentMenuId)
            console.log("accounts[currentUserData.sendId][currentMenuId]: ", accounts[currentUserData.sendId][currentMenuId])
            accounts[currentUserData.sendId][currentMenuId].forEach(
              (account, index) => {
                console.log("accounts[currentUserData.sendId][currentMenuId] account:", account)
                const localPosition = account.position;
                let serverAccount = null;

                // å®šä¹‰è´¦å·çŠ¶æ€ï¼š
                // - ä»æœªç»‘å®šè¿‡ï¼šstatusä¸ºpendingï¼Œä¸”æ²¡æœ‰serverData
                // - å·²ç»‘å®šï¼šstatusä¸ºactiveï¼Œæœ‰serverData
                // - å·²è§£ç»‘ï¼šstatusä¸ºpendingï¼Œä½†æœ‰è¿‡ç»‘å®šå†å²ï¼ˆæˆ‘ä»¬éœ€è¦è¿½è¸ªè¿™ä¸ªçŠ¶æ€ï¼‰
                
                // æ·»åŠ ä¸€ä¸ªæ–°å±æ€§æ¥è¿½è¸ªè´¦å·æ˜¯å¦æ›¾ç»ç»‘å®šè¿‡
                if (!account.hasEverBound) {
                  account.hasEverBound = account.serverData && account.serverData.acc_id ? true : false;
                }
                
                // 1. ä¼˜å…ˆä½¿ç”¨ acc_id è¿›è¡Œç²¾ç¡®åŒ¹é…ï¼ˆå¦‚æœæœ¬åœ°è´¦å·å·²ç»‘å®šï¼‰
                if (account.serverData && account.serverData.acc_id) {
                  serverAccount = sortedServerAccounts.find(acc => 
                    acc.acc_id === account.serverData.acc_id && 
                    !usedServerAccountIds.has(acc.acc_id)
                  );
                }

                // 2. å¦‚æœæ²¡æœ‰é€šè¿‡ acc_id åŒ¹é…åˆ°ï¼Œå†æ£€æŸ¥æ˜¯å¦å¯ä»¥æŒ‰ position åŒ¹é…
                if (!serverAccount) {
                  // æ£€æŸ¥æœåŠ¡å™¨è¿”å›çš„æ‰€æœ‰acc_idï¼Œç”¨äºåç»­åˆ¤æ–­
                  const allServerAccIds = new Set();
                  sortedServerAccounts.forEach(acc => {
                    if (acc.acc_id) {
                      allServerAccIds.add(acc.acc_id);
                    }
                  });

                  // æ ¸å¿ƒé€»è¾‘ï¼šç¡®ä¿æ‰€æœ‰è´¦å·è§£ç»‘åä½ç½®éƒ½ä¸ä¼šè¢«å…¶ä»–è´¦å·å¡«å……
                  // å…è®¸åŒ¹é…çš„æƒ…å†µï¼š
                  // 1. ä»æœªç»‘å®šè¿‡çš„è´¦å·ï¼ˆé¦–æ¬¡åŠ è½½ï¼‰ hasEverBound ä¸ºfalse
                  // 2. å·²ç»‘å®šè´¦å·ï¼šacc_idåœ¨æœåŠ¡å™¨ä¸Šå­˜åœ¨
                  const hasBoundAccId = account.serverData && account.serverData.acc_id;
                  const accIdExistsOnServer = hasBoundAccId ? allServerAccIds.has(account.serverData.acc_id) : false;
                  
                  // åªæœ‰ä»æœªç»‘å®šè¿‡çš„è´¦å·ï¼Œæˆ–è€…å·²ç»‘å®šä¸”acc_idå­˜åœ¨çš„è´¦å·ï¼Œæ‰å…è®¸åŒ¹é…
                  // ä¸€æ—¦æ›¾ç»ç»‘å®šè¿‡åˆè§£ç»‘çš„è´¦å·ï¼ˆhasEverBoundä¸ºtrueä¸”æ²¡æœ‰serverDataï¼‰ï¼Œæ°¸è¿œä¸å†åŒ¹é…å…¶ä»–è´¦å·
                  console.log("%chasBoundAccId:",'color:red;',hasBoundAccId)
                  if ((!account.hasEverBound && !hasBoundAccId) || (hasBoundAccId)) {
                    // ä¸»è´¦å·ä½ç½®ï¼ˆposition=1ï¼‰åªèƒ½åŒ¹é…æœåŠ¡å™¨è¿”å›çš„is_main=1æˆ–trueçš„è´¦å·
                    console.log('%cå…¶ä»–ä½ç½®æŒ‰positionåŒ¹é…æœåŠ¡å™¨è´¦å·', 'color:blue;', localPosition,currentMenuId)
                    if (localPosition === 1 && currentMenuId === 1) {
                      serverAccount = sortedServerAccounts.find((acc) => {
                        const accId = acc.acc_id;
                        return (
                          (acc.is_main === 1 || acc.is_main === true) &&
                          accId !== null &&
                          accId !== undefined &&
                          !usedServerAccountIds.has(accId)
                        );
                      });
                    } else {
                      console.log('%cå…¶ä»–ä½ç½®æŒ‰positionåŒ¹é…æœåŠ¡å™¨è´¦å·', 'color:blue;')
                      serverAccount = sortedServerAccounts.find((acc) => {
                        const accId = acc.acc_id;
                        // åªåŒ¹é…æœ‰acc_idçš„è´¦å·ï¼Œé¿å…åŒ¹é…åˆ°ç©ºè´¦å·
                        return (
                          acc.position === localPosition &&
                          accId !== null &&
                          accId !== undefined &&
                          !usedServerAccountIds.has(accId)
                        );
                      });
                    }
                  }
                }
                
                // æ›´æ–°hasEverBoundå±æ€§ï¼šå¦‚æœåŒ¹é…åˆ°äº†serverAccountï¼Œè¯´æ˜å·²ç»ç»‘å®šè¿‡
                // if (serverAccount && serverAccount.acc_id) {
                //   account.hasEverBound = true;
                // }

                console.log(`%cä½ç½® ${localPosition} çš„è´¦å·åŒ¹é…ç»“æœ:`,'color:green;');
                console.log(serverAccount)

                const newStatus = serverAccount ? 
                  (serverAccount.acc_id !== null && serverAccount.acc_id !== undefined ? "active" : "pending") : 
                  "pending";

                // å¼ºåˆ¶ä¿ç•™æœ¬åœ°å›ºå®šä½ç½®ï¼Œå¿½ç•¥æœåŠ¡å™¨è¿”å›çš„position
                const originalPosition = account.position;
                account.position = localPosition;
                
                // å¼ºåˆ¶åŸºäºæœ¬åœ°positionè®¾ç½®isMainï¼Œä¸å—æœåŠ¡å™¨is_mainå½±å“
                const originalIsMain = account.isMain;
                account.isMain = currentMenuId === 1 ? (localPosition === 1 ? 1 : 0) : 0;

                let serverDataChanged = false;
                console.log("%cserverAccount: ",'color:red;', serverAccount)
                if (serverAccount) {
                    // æ ‡è®°è¿™ä¸ªæœåŠ¡å™¨è´¦å·å·²è¢«ä½¿ç”¨
                    if (serverAccount.acc_id) {
                      usedServerAccountIds.add(serverAccount.acc_id);
                    }

                    console.log(
                      `æœåŠ¡å™¨è´¦å·æ•°æ® (position ${localPosition}):`,
                    //   JSON.stringify(serverAccount, null, 2)
                    serverAccount
                    );
                    console.log(
                      `userData å­˜åœ¨:`,
                      !!serverAccount.userData,
                      "userData å†…å®¹:",
                      serverAccount.userData
                    );
                    account.serverData = serverAccount;
                    // æ›´æ–°è´¦å·åç§°ï¼ˆå¦‚æœæœåŠ¡å™¨æœ‰è¿”å›ï¼‰
                    if (
                        serverAccount.userData &&
                        serverAccount.userData.nikeName
                    ) {
                        account.name = serverAccount.userData.nikeName;
                    }
                } else {
                  // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°æœåŠ¡å™¨è´¦å·ï¼Œæ£€æŸ¥serverDataæ˜¯å¦éœ€è¦æ¸…ç©º
                  if (account.serverData) {
                    delete account.serverData;
                    serverDataChanged = true;
                  }
                }

                // â€”â€”â€”â€”â€”â€”â€”â€”æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ï¼šçŠ¶æ€å˜åŒ–ã€serverDataå˜åŒ–ã€positionå˜åŒ–æˆ–isMainå˜åŒ–
                // [fix]æ¯æ¬¡éƒ½æ›´æ–°
                const positionChanged = originalPosition !== account.position;
                const isMainChanged = originalIsMain !== account.isMain;
                
                // if (account.status !== newStatus || serverDataChanged || positionChanged || isMainChanged) {
                  account.status = newStatus;
                  hasChanges = true;
                  
                //   if (serverAccount) {
                //     console.log(
                //       `æ›´æ–°è´¦æˆ· ${account.id} (position: ${localPosition})ï¼ŒæœåŠ¡å™¨è´¦å·ID: ${serverAccount.acc_id}ï¼ŒisMain: ${account.isMain}`
                //     );
                //   } else {
                //     console.log(
                //       `é‡ç½®è´¦æˆ· ${account.id} (position: ${localPosition}) ä¸º pending çŠ¶æ€ï¼ŒisMain: ${account.isMain}`
                //     );
                //   }
                // }
              }
            );

            if (hasChanges) {
              console.log("è´¦å·çŠ¶æ€æœ‰å˜åŒ–ï¼Œé‡æ–°æ¸²æŸ“");
              renderAccounts(false);
            } else {
              console.log("è´¦å·çŠ¶æ€æ— å˜åŒ–ï¼Œè·³è¿‡æ¸²æŸ“");
            }
          }
        }
      } catch (error) {
        console.error("è·å–è´¦å·çŠ¶æ€å¤±è´¥:", error);
      }
    }

    const debouncedUpdateAccountStatus = debounce(updateAccountStatus, 300);

    //æˆæƒæ—¶é—´å¤„ç†æ ¼å¼
    function formatAuthTime(timeStr) {
      if (!timeStr) return "";

      const date = new Date(timeStr);
      // å¤„ç†è§£æå¤±è´¥çš„æƒ…å†µ
      if (isNaN(date.getTime())) return timeStr;

      // è¡¥é›¶å‡½æ•°ï¼ˆç¡®ä¿æœˆä»½/æ—¥æœŸ/æ—¶åˆ†ç§’ä¸ºä¸¤ä½æ•°ï¼‰
      const padZero = (num) => num.toString().padStart(2, "0");

      const year = date.getFullYear();
      const month = padZero(date.getMonth() + 1); // æœˆä»½ä»0å¼€å§‹ï¼Œéœ€+1
      const day = padZero(date.getDate());
      const hours = padZero(date.getHours());
      const minutes = padZero(date.getMinutes());
      const seconds = padZero(date.getSeconds());

      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    function renderAccounts(shouldUpdateStatus = true) {
      console.log("è°ƒç”¨äº†renderAccounts ç”¨æˆ·IDä¸º:", currentMenuId);
      const accountsGrid = document.getElementById("accountsGrid");

    //   console.log("è´¦æˆ·ç½‘æ ¼å…ƒç´ :", accountsGrid);
    //   console.log("è´¦æˆ·çˆ¶çº§å…ƒç´ :", accountsGrid?.parentElement);

      if (
        currentMenuId === null ||
        currentMenuId === undefined ||
        !currentUserData
      ) {
        console.log("æ— èœå•IDï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€");
        showEmptyState();
        return;
      }

      // ç¡®ä¿å½“å‰ç”¨æˆ·æœ‰è´¦æˆ·å­˜å‚¨ç©ºé—´
      if (!accounts[currentUserData.sendId]) {
        accounts[currentUserData.sendId] = {};
      }
      

      // æ–‡å¿ƒæ™ºèƒ½ä½“å— showMultipleAccounts æ§åˆ¶
      // åˆ¤æ–­æ˜¯å¦ä¸ºæ–‡å¿ƒæ™ºèƒ½ä½“ï¼šactualTypeä¸º9è¡¨ç¤ºæ–‡å¿ƒæ™ºèƒ½ä½“
      console.log("æ£€æŸ¥æ–‡å¿ƒæ™ºèƒ½ä½“", actualType)

      // æŸ¥æ‰¾å¯¹åº”çš„èœå•é¡¹
      const menuItem = navItems.find((item) => item.id === currentMenuId);
      if (!menuItem) {
        console.log("æœªæ‰¾åˆ°èœå•ï¼Œå…ƒç´ IDä¸º:", currentMenuId);
        showEmptyState();
        return;
      }

      // è·å–æˆ–åˆ›å»ºè´¦å·åˆ—è¡¨
      if (
        !accounts[currentUserData.sendId][currentMenuId] ||
        accounts[currentUserData.sendId][currentMenuId].length === 0
      ) {
        accounts[currentUserData.sendId][currentMenuId] = [];
        // ç¡®å®šéœ€è¦åˆ›å»ºçš„è´¦å·æ•°é‡ï¼šç™¾å®¶å·å’Œæ–‡å¿ƒæ™ºèƒ½ä½“åˆ›å»º5ä¸ªï¼Œå…¶ä»–å¹³å°åˆ›å»º1ä¸ª
        // åˆ¤æ–­æ˜¯å¦ä¸ºç™¾å®¶å·æˆ–æ–‡å¿ƒæ™ºèƒ½ä½“ï¼šmenuIdä¸º1è¡¨ç¤ºç™¾å®¶å·æˆ–æ–‡å¿ƒæ™ºèƒ½ä½“
        console.log("showMultipleAccounts:", showMultipleAccounts)
        console.log('%ccurrentMenuId', 'color: green;', currentMenuId)
        const accountCount =
          [1, 9].includes(currentMenuId) && showMultipleAccounts
            ? 5
            : 1;

        // åˆ›å»ºå¯¹åº”æ•°é‡çš„æœªç»‘å®šè´¦å·ï¼Œæ¯ä¸ªè´¦å·åˆ†é…å”¯ä¸€å›ºå®šçš„position
        for (let i = 1; i <= accountCount; i++) {
          accounts[currentUserData.sendId][currentMenuId].push({
            id: "pending_" + currentMenuId + "_" + i,
            name: menuItem.name + "è´¦å·" + i,
            icon: menuItem.icon,
            status: "pending", // æœªç»‘å®šçŠ¶æ€
            menuId: currentMenuId,
            actualType: actualType, // ä¿å­˜å®é™…ç±»å‹ï¼Œç”¨äºåŒºåˆ†ç™¾å®¶å·å’Œæ–‡å¿ƒæ™ºèƒ½ä½“
            position: i, // å›ºå®špositionï¼Œåˆ›å»ºæ—¶åˆ†é…ï¼Œæ°¸ä¸æ”¹å˜
            isMain:
              [1, 9].includes(currentMenuId)
                ? i === 1
                  ? 1
                  : 0
                : 0, // ä¸»è´¦å·æ ‡è¯†ï¼ˆç™¾å®¶å·å’Œæ–‡å¿ƒæ™ºèƒ½ä½“éƒ½ä½¿ç”¨menuId=1ï¼‰
          });
        }
      } else {
        // ç¡®ä¿ç°æœ‰è´¦å·éƒ½æœ‰å›ºå®šçš„positionå’Œæ­£ç¡®çš„isMainå€¼
        accounts[currentUserData.sendId][currentMenuId].forEach((account, index) => {
          if (!account.position) {
            // å¦‚æœè´¦å·æ²¡æœ‰positionï¼Œåˆ†é…ä¸€ä¸ªåŸºäºç´¢å¼•çš„å›ºå®šposition
            account.position = index + 1;
          }
          // ç¡®ä¿isMainå€¼æ­£ç¡®ï¼šç™¾å®¶å·/æ–‡å¿ƒæ™ºèƒ½ä½“çš„ç¬¬ä¸€ä¸ªè´¦å·ï¼ˆposition=1ï¼‰isMain=1ï¼Œå…¶ä»–ä¸º0
          account.isMain = currentMenuId === 1 ? (account.position === 1 ? 1 : 0) : 0;
        });
      }

      const menuAccounts = accounts[currentUserData.sendId][currentMenuId];
      console.log("æ¸²æŸ“è´¦æˆ·æ•°é‡ä¸ºï¼š", menuAccounts.length, "è´¦æˆ·");
      console.log("èœå•è´¦æˆ·ä¸º:", menuAccounts);

      accountsGrid.innerHTML = "";
      accountsGrid.style.display = "grid";
    //   console.log("è®¾ç½®ä¸ºç½‘æ ¼æ˜¾ç¤º");

      if (menuAccounts.length > 0) {
        // æŒ‰ç…§ position å­—æ®µæ’åºè´¦å·åˆ—è¡¨
        menuAccounts.sort((a, b) => {
          // ç¡®ä¿æœ‰ position å­—æ®µï¼Œé»˜è®¤ä¸ºç´¢å¼•+1
          const posA = a.position || 0;
          const posB = b.position || 0;
          return posA - posB;
        });

        menuAccounts.forEach((account, index) => {
        //   console.log("ä¸ºè´¦æˆ·ä¿¡æ¯åˆ›å»ºå¡ç‰‡", index, ":", account);
          const card = createAccountCard(account, menuItem);
          accountsGrid.appendChild(card);
        //   console.log(
        //     "è´¦æˆ·å¡ç‰‡å·²æ·»åŠ ï¼Œå½“å‰è´¦æˆ·æ•°é‡ï¼š",
        //     accountsGrid.children.length
        //   );
        });
      } else {
        console.log("æ²¡æœ‰è´¦æˆ·ä¿¡æ¯");
        showEmptyState();
      }

      console.log("è´¦å·ä¿¡æ¯é•¿åº¦ä¸ºï¼š", accountsGrid.children.length);
      if (shouldUpdateStatus) {
        setTimeout(() => {
          debouncedUpdateAccountStatus();
        }, 100);
      }
    }

    function createAccountCard(account, menuItem) {
//   console.log("åˆ›å»ºè´¦å·å¡ç‰‡");
//   console.log("è´¦æˆ·æ•°æ®ä¸º:", account);
  
  // åœ¨å‡½æ•°é¡¶éƒ¨ç»Ÿä¸€å£°æ˜ accountTypeï¼Œç”¨äºåŒºåˆ†æ–‡å¿ƒæ™ºèƒ½ä½“å’Œç™¾å®¶å·
  // å¦‚æœæ˜¯æ–‡å¿ƒæ™ºèƒ½ä½“ï¼ˆactualTypeä¸º9ï¼‰ï¼Œä½¿ç”¨æ–‡å¿ƒæ™ºèƒ½ä½“çš„ç±»å‹ï¼›å¦åˆ™ä½¿ç”¨menuId
  const accountType = account.actualType !== undefined ? account.actualType : account.menuId;
  
  const card = document.createElement("div");
  card.className = "account-card";
  
  // æ ¹æ® position è®¾ç½® orderï¼Œä¿è¯åœ¨ CSS Grid ä¸­æŒ‰ä½ç½®æ¸²æŸ“
  const _pos = parseInt(account.position, 10);
  if (!Number.isNaN(_pos) && _pos > 0) {
    card.style.order = _pos;
  }

  // åº”ç”¨å¹³å°å¯¹åº”çš„å¡ç‰‡èƒŒæ™¯
  const platformBgClass = platformCardBgMap[accountType] || "card-bg-default";
  card.classList.add(platformBgClass);

  // ä¸»è´¦å·æ ‡è¯†
  if (account.isMain === 1) {
    const mainBadge = document.createElement("div");
    mainBadge.className = "main-account-badge";
    mainBadge.textContent = "ä¸»";
    card.appendChild(mainBadge);
  }

  // å¡ç‰‡å¤´éƒ¨
  const headerDiv = document.createElement("div");
  headerDiv.className = "account-card-header";

  const iconDiv = document.createElement("div");
  iconDiv.className = "account-icon";
  iconDiv.textContent = menuItem.icon;

  const infoDiv = document.createElement("div");
  infoDiv.className = "account-info";

  const platformName = document.createElement("div");
  platformName.className = "account-platform";
  if (account.serverData && account.serverData.userData.nikeName) {
    console.log("è´¦æˆ·åä¸º:", account.serverData.userData.nikeName);
    platformName.textContent = account.serverData.userData.nikeName;
  } else {
    platformName.textContent = account.name;
  }

  infoDiv.appendChild(platformName);
  headerDiv.appendChild(iconDiv);
  headerDiv.appendChild(infoDiv);

  // å¡ç‰‡ä¸»ä½“å†…å®¹å®¹å™¨
  const cardContent = document.createElement("div");
  cardContent.style.display = "flex";
  cardContent.style.flexDirection = "column";
  cardContent.style.flex = "1";

  // å°†å¤´éƒ¨æ·»åŠ åˆ°å¡ç‰‡å†…å®¹ä¸­
  cardContent.appendChild(headerDiv);

  // çŠ¶æ€å’Œè®¤è¯æ—¶é—´å®¹å™¨ - æ”¾åœ¨å¤´éƒ¨ä¸‹é¢ï¼Œå•ç‹¬ä¸€è¡Œ
  const statusContainer = document.createElement("div");
  statusContainer.style.display = "flex";
  statusContainer.style.alignItems = "center";;
  statusContainer.style.marginTop = "10px";
  statusContainer.style.justifyContent = "flex-start"; // å·¦å¯¹é½

  // çŠ¶æ€æ ‡ç­¾
  const statusDiv = document.createElement("div");
  const statusText = document.createElement("span");
  statusText.textContent = account.status === "pending" ? "æœªæˆæƒ" : "å·²æˆæƒ";

  // è®¾ç½®çŠ¶æ€æ ‡ç­¾çš„æ ·å¼
  if (account.status === "pending") {
    statusDiv.className = "account-status-default";
  } else {
    statusDiv.className = "account-status-active";
  }
  statusDiv.style.display = "flex";
  statusDiv.style.justifyContent = "center";
  statusDiv.style.alignItems = "center";
  statusDiv.style.width = "63px";
  statusDiv.style.height = "16px";
  statusDiv.style.borderRadius = "3px";
  statusDiv.style.fontWeight = "400";
  statusDiv.style.fontSize = "11px";
  statusDiv.style.color = "#ffffff";

  if (account.status === "pending") {
    statusDiv.style.background = "#418dff";
  } else {
    statusDiv.style.background = "#00c433";
  }

  statusDiv.appendChild(statusText);
  statusContainer.appendChild(statusDiv);

  // å·²æˆæƒæ—¶æ˜¾ç¤ºè®¤è¯æ—¶é—´
  if (account.status === "active" && account.serverData && account.serverData.auth_time) {
    const authTimeElement = document.createElement("div");
    authTimeElement.textContent = `æˆæƒæ—¶é—´ï¼š${formatAuthTime(account.serverData.auth_time)}`;
    authTimeElement.style.fontSize = "14px";
    authTimeElement.style.color = "#585A73";
    authTimeElement.style.lineHeight = "16px"; // ä¸çŠ¶æ€æ ‡ç­¾ä¿æŒç›¸åŒè¡Œé«˜
    authTimeElement.style.marginLeft = "15px";
    statusContainer.appendChild(authTimeElement);
  }

  cardContent.appendChild(statusContainer);

  // æœªæˆæƒæ—¶æ˜¾ç¤ºæè¿°æ–‡å­— - æ”¾åœ¨çŠ¶æ€ä¸‹é¢
  if (account.status === "pending") {
    const descContainer = document.createElement("div");
    const accountDesc = document.createElement("div");
    accountDesc.className = "account-name";
    accountDesc.textContent = "æ‚¨çš„è´¦å·æœªæˆæƒï¼Œè¯·ç‚¹å‡»å»æˆæƒè¿›è¡Œç»‘å®š";
    accountDesc.style.marginTop = "8px";
    accountDesc.style.textAlign = "left"; // å·¦å¯¹é½
    descContainer.appendChild(accountDesc);
    cardContent.appendChild(descContainer);
  }

  // è´¦å·è¯¦ç»†ä¿¡æ¯ - å·²æˆæƒçš„è´¦å·è¯¦ç»†ä¿¡æ¯æ”¾åœ¨çŠ¶æ€ä¸‹é¢
  if (account.serverData && account.serverData.acc_id) {
    console.log("å¼€å§‹æ¸²æŸ“è´¦å·è¯¦ç»†ä¿¡æ¯, serverData:", account.serverData);
    const detailsDiv = document.createElement("div");
    detailsDiv.className = "account-details";
    detailsDiv.style.marginTop = "15px"; // å¢åŠ ä¸Šè¾¹è·ï¼Œä¸çŠ¶æ€åˆ†å¼€

    // æ•°æ®ç»Ÿè®¡ - æ£€æŸ¥ä¸åŒçš„æ•°æ®å­—æ®µ
    const userData = account.serverData.userData || {};
    console.log("userData å†…å®¹:", userData);
    console.log(
      "userData å­—æ®µæ£€æŸ¥ - sub_data:",
      userData.sub_data,
      "read_data:",
      userData.read_data,
      "fen_data:",
      userData.fen_data
    );
    const hasStats =
      userData.sub_data !== undefined ||
      userData.read_data !== undefined ||
      userData.fen_data !== undefined ||
      userData.article_count !== undefined ||
      userData.read_count !== undefined ||
      userData.fans_count !== undefined;
    console.log("hasStats:", hasStats);

    // å¦‚æœå·²æˆæƒï¼Œæ€»æ˜¯æ˜¾ç¤ºæ•°æ®ç»Ÿè®¡ï¼Œå³ä½¿å€¼ä¸º0
    if (account.status === "active" || hasStats) {
      // æ–‡ç« æ•° - æ€»æ˜¯æ˜¾ç¤º
      const articleCount = userData.sub_data || userData.article_count || 0;
      const statsItem = document.createElement("div");
      statsItem.className = "account-detail-item";
      statsItem.innerHTML = `
        <span class="account-detail-label">æ–‡ç« æ•°</span>
        <span class="account-detail-value">${articleCount}</span>
      `;
      statsItem.style.alignItems = "center";
      detailsDiv.appendChild(statsItem);

      // é˜…è¯»é‡ - æ€»æ˜¯æ˜¾ç¤º
      const readCount = userData.read_data || userData.read_count || 0;
      const readItem = document.createElement("div");
      readItem.className = "account-detail-item";
      readItem.innerHTML = `
        <span class="account-detail-label">é˜…è¯»é‡</span>
        <span class="account-detail-value">${readCount}</span>
      `;
      readItem.style.alignItems = "center";
      detailsDiv.appendChild(readItem);

      // ç²‰ä¸æ•° - æ€»æ˜¯æ˜¾ç¤º
      const fansCount = userData.fen_data || userData.fans_count || 0;
      const fansItem = document.createElement("div");
      fansItem.className = "account-detail-item";
      fansItem.innerHTML = `
        <span class="account-detail-label">ç²‰ä¸æ•°</span>
        <span class="account-detail-value">${fansCount}</span>
      `;
      fansItem.style.alignItems = "center";
      detailsDiv.appendChild(fansItem);
    }

    cardContent.appendChild(detailsDiv);
  }

  // æ“ä½œæŒ‰é’® - å·¦å¯¹é½
  const actionsDiv = document.createElement("div");
  actionsDiv.className = "account-actions";

  const enterBtn = document.createElement("button");
  enterBtn.className = "account-btn enter-btn";
  enterBtn.textContent = account.status === "pending" ? "å»æˆæƒ" : "ç®¡ç†";

  // åº”ç”¨å¹³å°å¯¹åº”çš„æŒ‰é’®é¢œè‰²
  const platformColorClass = platformColorMap[accountType] || "";
  if (platformColorClass) {
    enterBtn.classList.add(platformColorClass);
  }

  enterBtn.addEventListener("click", async (e) => {
    e.stopPropagation();
    console.log("ç‚¹å‡»äº†ç½‘æ ¼å…ƒç´ ï¼Œè¿›å…¥ç½‘é¡µ", account);
    console.log("%cè´¦å·å®é™…ç™»å½•ä¿¡æ¯ serverData:", 'color:green;');
    console.log(account.serverData)
    console.log('%cæ˜¯å¦ä¸ºæ–‡å¿ƒæ™ºèƒ½ä½“', 'color:green', accountType)
    

    window.currentAccountId = account.serverData
      ? account.serverData.acc_id
      : null;
    window.currentAccount = account;

    console.log("å½“å‰è´¦æˆ·ä¿¡æ¯ä¸ºï¼š", window.currentAccount);
    console.log("å½“å‰è´¦æˆ·IDï¼ˆacc_idï¼‰:", window.currentAccountId);

    // åˆ¤æ–­æ˜¯å¦ä¸ºæ–‡å¿ƒæ™ºèƒ½ä½“ï¼šä½¿ç”¨actualTypeè€Œä¸æ˜¯menuId
    if (accountType === 9) {
      console.log('å‡†å¤‡å‘é€openWenxinAuthæ¶ˆæ¯ï¼Œaccount.serverData:', account.serverData);
      
      const cookiesData = account.serverData ? account.serverData.cookies : null;
      console.log('Cookiesæ•°æ®ç±»å‹:', typeof cookiesData);
      console.log('Cookiesæ•°æ®é•¿åº¦:', cookiesData ? cookiesData.length : 0);
      console.log('Cookiesæ•°æ®å‰100å­—ç¬¦:', cookiesData ? cookiesData.substring(0, 100) : 'null');
      
      console.log("å‘é€æ–‡å¿ƒæ™ºèƒ½ä½“enterWebviewæ¶ˆæ¯ç»™ä¸»çª—å£");
      
      // ç”Ÿæˆå›ºå®šçš„ã€å”¯ä¸€çš„è´¦å·ID
      const uniqueAccountId = account.serverData && account.serverData.acc_id 
        ? `acc_${account.serverData.acc_id}` 
        : `pending_${account.menuId}_${account.position}`;

      // å‡†å¤‡è¦å‘é€ç»™ä¸»çª—å£çš„æ•°æ®ï¼ˆä¸ç™¾å®¶å·ç›¸åŒçš„æ ¼å¼ï¼Œä½¿ç”¨enterWebviewï¼‰
      const messageData = {
        type: "enterWebview",
        menuId: account.menuId,  // menuIdä¿æŒä¸º9
        accountId: uniqueAccountId,
        accountIndex: account.position ||
            (account.id.includes("_") ? account.id.split("_")[2] : "1"),
        acc_id: account.serverData ? account.serverData.acc_id : null,
        position: account.position,
        isMain: account.isMain,
        cookies: account.serverData ? account.serverData.cookies : null,
        sendId: currentUserData.sendId,
        actualType: accountType,  // æ·»åŠ actualType=9ç”¨äºåŒºåˆ†æ–‡å¿ƒæ™ºèƒ½ä½“
      };

      window.parent.postMessage(messageData, "*");
      console.log(
        "æ–‡å¿ƒæ™ºèƒ½ä½“æ¶ˆæ¯å·²å‘é€ï¼ŒaccountId:",
        uniqueAccountId,
        "position:",
        account.position
      );
    } else {
      console.log("å‘é€è¿›å…¥webviewæ¶ˆæ¯ç»™ä¸»çª—å£");
      const electronAPI =
        window.electronAPI ||
        (window.parent && window.parent.electronAPI);

      // ç”Ÿæˆå›ºå®šçš„ã€å”¯ä¸€çš„è´¦å·IDï¼Œç¡®ä¿æ¯ä¸ªè´¦å·ä½¿ç”¨å›ºå®šçš„partition
      // å¯¹äºå·²æˆæƒè´¦å·ï¼Œåªä½¿ç”¨acc_idï¼Œä¸ä½¿ç”¨åŠ¨æ€å˜åŒ–çš„position
      // å¯¹äºæœªæˆæƒè´¦å·ï¼Œä½¿ç”¨ pending_${menuId}_${position} æ ¼å¼
      const uniqueAccountId = account.serverData && account.serverData.acc_id 
        ? `acc_${account.serverData.acc_id}` 
        : `pending_${account.menuId}_${account.position}`;

      const accountIndex =
        account.position ||
        (account.id.includes("_") ? account.id.split("_")[2] : "1");

      // å‡†å¤‡è¦å‘é€ç»™ä¸»çª—å£çš„æ•°æ®
      const messageData = {
        type: "enterWebview",
        menuId: account.menuId,
        accountId: uniqueAccountId,
        accountIndex: accountIndex,
        acc_id: account.serverData ? account.serverData.acc_id : null,
        position: account.position,
        isMain: account.isMain,
        cookies: account.serverData ? account.serverData.cookies : null,
      };

      // å¯¹äºå·²æˆæƒè´¦å·ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰é»˜è®¤cookies
      if (account.status !== "pending" && electronAPI && typeof electronAPI.getCookies === "function") {
        try {
          const defaultCookies = await electronAPI.getCookies(
            getDomainByMenuId(account.menuId),
            "persist:zhongshang"
          );
          messageData.hasDefaultCookies = defaultCookies && defaultCookies.length > 0;
        } catch (error) {
          console.error("æ£€æŸ¥cookieæ—¶å‡ºé”™:", error);
        }
      }

      window.parent.postMessage(messageData, "*");
      console.log(
        "æ¶ˆæ¯å·²å‘é€ï¼ŒaccountId:",
        uniqueAccountId,
        "position:",
        account.position
      );
    }
  });

  // åªæœ‰å·²æˆæƒæ—¶æ‰æ·»åŠ è§£ç»‘æŒ‰é’®
  if (account.status === "active") {
    const deleteBtn = document.createElement("button");
    deleteBtn.className = "account-btn delete-btn";
    deleteBtn.textContent = "è§£ç»‘";
    
    // åº”ç”¨å¹³å°å¯¹åº”çš„æŒ‰é’®é¢œè‰²ï¼ˆè§£ç»‘æŒ‰é’®ä¹Ÿä½¿ç”¨ç›¸åŒé¢œè‰²ï¼‰
    if (platformColorClass) {
      deleteBtn.classList.add(platformColorClass);
    }

    deleteBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      deleteAccount(account.id);
    });

    actionsDiv.appendChild(enterBtn);
    actionsDiv.appendChild(deleteBtn);
  } else {
    // æœªæˆæƒæ—¶åªæ˜¾ç¤ºå»æˆæƒæŒ‰é’®
    actionsDiv.appendChild(enterBtn);
  }

  cardContent.appendChild(actionsDiv);

  // å°†å¡ç‰‡å†…å®¹æ·»åŠ åˆ°å¡ç‰‡ä¸­
  card.appendChild(cardContent);

  return card;
}

  function getDomainByMenuId(menuId) {
      const domainMap = {
        1: "https://baijiahao.baidu.com",
        2: "https://mp.sohu.com",
        3: "https://mp.toutiao.com",
        4: "http://zs.open.chuangmaedu.com",
        5: "https://mp.sina.com.cn",
        6: "https://om.qq.com",
        8: "https://mp.163.com",
      };
      return domainMap[menuId] || "";
    }

    function showEmptyState() {
      const accountsGrid = document.getElementById("accountsGrid");
      console.log("è°ƒç”¨äº†showEmptyStateå‡½æ•°");
      accountsGrid.innerHTML = `
                <div style="grid-column: 1/-1;">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <div class="empty-text">æš‚æ— è´¦å·ä¿¡æ¯</div>
                        <div class="empty-subtext">ç‚¹å‡»ä¸‹æ–¹"æ·»åŠ è´¦å·"æŒ‰é’®ç»‘å®šæ–°è´¦å·</div>
                    </div>
                </div>
            `;
    }

    function deleteAccount(accountId) {
      // è·å–è´¦å·çš„çœŸå®IDï¼ˆä»serverDataä¸­ï¼‰
      let realAccountId = null;
      let foundAccount = null;

      // åœ¨å½“å‰ç”¨æˆ·çš„è´¦å·ä¸­æŸ¥æ‰¾è¦åˆ é™¤çš„è´¦å·
      if (
        accounts[currentUserData.sendId] &&
        accounts[currentUserData.sendId][currentMenuId]
      ) {
        for (const account of accounts[currentUserData.sendId][
          currentMenuId
        ]) {
          if (account.id === accountId) {
            foundAccount = account;
            // å¦‚æœè´¦å·æœ‰serverDataä¸”åŒ…å«acc_idï¼Œåˆ™ä½¿ç”¨acc_idä½œä¸ºçœŸå®ID
            if (account.serverData && account.serverData.acc_id) {
              realAccountId = account.serverData.acc_id;
            }
            break;
          }
        }
      }

      // å¦‚æœæ²¡æœ‰æ‰¾åˆ°è´¦å·ï¼Œç›´æ¥è¿”å›
      if (!foundAccount) {
        console.error("æœªæ‰¾åˆ°è¦åˆ é™¤çš„è´¦å·:", accountId);
        return;
      }

      // å¦‚æœæ˜¯ä¸´æ—¶è´¦å·ï¼ˆæ²¡æœ‰çœŸå®IDï¼‰ï¼Œç›´æ¥è½¯åˆ é™¤ï¼ˆé‡ç½®çŠ¶æ€ï¼‰
      if (!realAccountId) {
        if (confirm("ç¡®å®šè¦åˆ é™¤æ­¤è´¦å·å—ï¼Ÿ")) {
          // è½¯åˆ é™¤ï¼šé‡ç½®è´¦å·çŠ¶æ€
          foundAccount.status = "pending";
          delete foundAccount.serverData;

          // å¦‚æœè´¦å·åç§°æ˜¯ä¸´æ—¶åç§°ï¼Œæ¢å¤ä¸ºé»˜è®¤åç§°
          const menuItem = navItems.find((item) => item.id === currentMenuId);
          if (menuItem && foundAccount.id.startsWith("temp_")) {
            foundAccount.name =
              menuItem.name + "è´¦å·" + foundAccount.position;
          }

          renderAccounts();
          console.log("ä¸´æ—¶è´¦å·å·²é‡ç½®ä¸ºæœªæˆæƒçŠ¶æ€");
        }
        return;
      }

      // å¯¹äºå·²æœ‰çœŸå®IDçš„è´¦å·ï¼Œè°ƒç”¨åç«¯è§£ç»‘æ¥å£
      if (confirm("ç¡®å®šè¦è§£ç»‘æ­¤è´¦å·å—ï¼Ÿ")) {
        // å®‰å…¨åœ°è®¿é—® electronAPIï¼ˆå…¼å®¹ iframe ç¯å¢ƒï¼‰
        const electronAPI =
          window.electronAPI || (window.parent && window.parent.electronAPI);

        if (!electronAPI) {
          console.error("æ— æ³•è®¿é—® electronAPIï¼Œè§£ç»‘åŠŸèƒ½ä¸å¯ç”¨");
          alert("è§£ç»‘åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•");
          return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const accountsGrid = document.getElementById("accountsGrid");
        const loadingElement = document.createElement("div");
        loadingElement.style.cssText =
          "grid-column: 1/-1; padding: 20px; text-align: center; background: rgba(255,255,255,0.9); border-radius: 8px;";
        loadingElement.innerHTML = "<p>æ­£åœ¨è§£ç»‘è´¦å·...</p>";
        accountsGrid.appendChild(loadingElement);

        // è°ƒç”¨ä¸»è¿›ç¨‹è¿›è¡Œè§£ç»‘
        electronAPI
          .unbindAccount({
            accountId: realAccountId,
            userId: currentUserData.sendId,
            currentNavId: currentMenuId,
            type: currentMenuId,
            token: currentUserData.token,
            isMain: foundAccount.isMain || foundAccount.serverData?.is_main || 0,
            position: foundAccount.position || 0
          })
          .then((result) => {
            // ç§»é™¤åŠ è½½çŠ¶æ€
            if (loadingElement.parentNode) {
              loadingElement.parentNode.removeChild(loadingElement);
            }

            if (result.success) {
              // è§£ç»‘æˆåŠŸï¼Œè½¯åˆ é™¤ï¼šé‡ç½®è´¦å·çŠ¶æ€ï¼Œä¸æ¸…é™¤å¡ç‰‡
              if (foundAccount) {
                foundAccount.status = "pending";
                delete foundAccount.serverData;
                // é‡ç½®hasEverBoundå±æ€§ï¼Œå…è®¸é‡æ–°æˆæƒæ—¶åŒ¹é…æ–°çš„æœåŠ¡å™¨æ•°æ®
                foundAccount.hasEverBound = false;
                // ç¡®ä¿isMainå€¼æ­£ç¡®ï¼šç™¾å®¶å·/æ–‡å¿ƒæ™ºèƒ½ä½“çš„ç¬¬ä¸€ä¸ªè´¦å·ï¼ˆposition=1ï¼‰isMain=1ï¼Œå…¶ä»–ä¸º0
                foundAccount.isMain = currentMenuId === 1 ? (foundAccount.position === 1 ? 1 : 0) : 0;

                // æ¢å¤è´¦å·åç§°ä¸ºé»˜è®¤åç§°
                const menuItem = navItems.find(
                  (item) => item.id === currentMenuId
                );
                if (menuItem) {
                  foundAccount.name = 
                    menuItem.name + "è´¦å·" + foundAccount.position;
                }
                // ç”Ÿæˆå”¯ä¸€çš„accountIdç”¨äºæ¸…é™¤cookieï¼Œä½¿ç”¨ä¸åˆ›å»ºæ—¶ç›¸åŒçš„å›ºå®šæ ¼å¼
                const uniqueAccountId = currentUserData.acc_id 
                  ? `acc_${currentUserData.acc_id}` 
                  : `pending_${currentMenuId}_${foundAccount.position}`;

                // æ¸…é™¤è¯¥è´¦å·çš„cookie
                if (
                  electronAPI &&
                  typeof electronAPI.clearAccountCookies === "function"
                ) {
                  electronAPI
                    .clearAccountCookies({
                      accountId: uniqueAccountId,
                      menuId: currentMenuId,
                    })
                    .then((clearResult) => {
                      if (clearResult.success) {
                        console.log("è´¦å·cookieæ¸…é™¤æˆåŠŸ");
                      } else {
                        console.error(
                          "è´¦å·cookieæ¸…é™¤å¤±è´¥:",
                          clearResult.message
                        );
                      }
                    });
                }
              }

              // é‡æ–°æ¸²æŸ“ï¼Œæ˜¾ç¤ºæ›´æ–°åçš„çŠ¶æ€
              renderAccounts();

              // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
              const messageBox = document.createElement("div");
              messageBox.style.cssText =
                "position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000;";
              messageBox.innerHTML = `
                <h3 style="margin: 0 0 10px 0; color: #28a745;">âœ“ æˆåŠŸ</h3>
                <p style="margin: 0 0 15px 0;">è´¦å·è§£ç»‘æˆåŠŸ</p>
                <button onclick="this.parentElement.remove()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">ç¡®å®š</button>
              `;
              document.body.appendChild(messageBox);

              setTimeout(() => {
                if (messageBox.parentElement) {
                  messageBox.remove();
                }
              }, 3000);
            } else {
              // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
              const messageBox = document.createElement("div");
              messageBox.style.cssText =
                "position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000;";
              messageBox.innerHTML = `
                <h3 style="margin: 0 0 10px 0; color: #e74c3c;">âš ï¸ é”™è¯¯</h3>
                <p style="margin: 0 0 15px 0;">${result.message || "è§£ç»‘å¤±è´¥"
                }</p>
                <button onclick="this.parentElement.remove()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">ç¡®å®š</button>
              `;
              document.body.appendChild(messageBox);

              setTimeout(() => {
                if (messageBox.parentElement) {
                  messageBox.remove();
                }
              }, 3000);
            }
          })
          .catch((error) => {
            // ç§»é™¤åŠ è½½çŠ¶æ€
            if (loadingElement.parentNode) {
              loadingElement.parentNode.removeChild(loadingElement);
            }

            // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
            const messageBox = document.createElement("div");
            messageBox.style.cssText =
              "position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000;";
            messageBox.innerHTML = `
              <h3 style="margin: 0 0 10px 0; color: #e74c3c;">âš ï¸ é”™è¯¯</h3>
              <p style="margin: 0 0 15px 0;">è§£ç»‘è´¦å·æ—¶å‘ç”Ÿé”™è¯¯</p>
              <button onclick="this.parentElement.remove()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">ç¡®å®š</button>
            `;
            document.body.appendChild(messageBox);

            setTimeout(() => {
              if (messageBox.parentElement) {
                messageBox.remove();
              }
            }, 3000);

            console.error("è§£ç»‘è´¦å·æ—¶å‘ç”Ÿé”™è¯¯:", error);
          });
      }
    }

    // function addAccount() {
    //     if (currentMenuId === null || currentMenuId === undefined) {
    //         alert('è¯·å…ˆä»å·¦ä¾§èœå•é€‰æ‹©å¹³å°');
    //         return;
    //     }

    //     if (!accounts[currentMenuId]) {
    //         accounts[currentMenuId] = [];
    //     }

    //     const menuItem = navItems.find(item => item.id === currentMenuId);
    //     if (!menuItem) return;

    //     const newAccount = {
    //         id: 'account_' + Date.now(),
    //         name: menuItem.name + 'è´¦å·' + (accounts[currentMenuId].length + 1),
    //         icon: menuItem.icon,
    //         status: 'active',
    //         menuId: currentMenuId
    //     };

    //     accounts[currentMenuId].push(newAccount);
    //     renderAccounts();

    //     // é€šçŸ¥ä¸»çª—å£éœ€è¦è¿›è¡Œè´¦å·ç»‘å®š
    //     window.parent.postMessage({
    //         type: 'addNewAccount',
    //         menuId: currentMenuId,
    //         accountId: newAccount.id
    //     }, '*');
    // }

    function addAccount() {
      if (
        accounts[currentUserData.sendId][currentMenuId] === null ||
        accounts[currentUserData.sendId][currentMenuId] === undefined
      ) {
        alert("è¯·å…ˆä»å·¦ä¾§èœå•é€‰æ‹©å¹³å°");
        return;
      }

      // ç›´æ¥å‘é€æ¶ˆæ¯ç»™çˆ¶çª—å£ï¼Œè¿›å…¥å¯¹åº”çš„webviewé¡µé¢è¿›è¡Œè´¦å·ç»‘å®š
      window.parent.postMessage(
        {
          type: "enterWebview",
          menuId: accounts[currentUserData.sendId][currentMenuId].menuId,
        },
        "*"
      );

      const menuItem = navItems.find((item) => item.id === currentMenuId);
      if (!menuItem) return;

      // æ‰¾åˆ°ä¸‹ä¸€ä¸ªå¯ç”¨çš„ä½ç½®ï¼Œè€Œä¸æ˜¯ç®€å•åœ°åœ¨æ•°ç»„é•¿åº¦ä¸ŠåŠ 1
      const currentAccounts = accounts[currentUserData.sendId][currentMenuId] || [];
      let nextPosition = 1;
      const existingPositions = new Set(currentAccounts.map(account => account.position));
      
      // æŸ¥æ‰¾æœ€å°çš„æœªä½¿ç”¨ä½ç½®
      while (existingPositions.has(nextPosition)) {
        nextPosition++;
      }
      
      const newAccount = {
        id: "temp_" + Date.now(),
        name: menuItem.name + "æ–°è´¦å·",
        icon: menuItem.icon,
        status: "pending",
        menuId: currentMenuId,
        position: nextPosition,
        isMain: 0,
      };

      // å¯ä»¥æš‚æ—¶å­˜å‚¨è¿™ä¸ªè´¦å·ä¿¡æ¯ï¼Œç­‰å¾…ç»‘å®šå®Œæˆåå†æ­£å¼æ·»åŠ 
      // è¿™é‡Œæˆ‘ä»¬å…ˆæ³¨é‡Šæ‰ä¹‹å‰çš„é€»è¾‘ï¼Œç›´æ¥è·³è½¬

      if (!accounts[currentUserData.sendId]) {
        accounts[currentUserData.sendId] = {};
      }
      if (!accounts[currentUserData.sendId][currentMenuId]) {
        accounts[currentUserData.sendId][currentMenuId] = [];
      }
      accounts[currentUserData.sendId][currentMenuId].push(newAccount);
      renderAccounts();
    }
    showEmptyState();
  </script>
</body>

</html>