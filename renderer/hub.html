<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è´¦å·ç»‘å®š</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Microsoft YaHei", "PingFang SC", "Helvetica Neue", Arial,
          sans-serif;
      }

      body {
        background: #f5f7fa;
        display: flex;
      }

      .hub-container {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .hub-header {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        padding: 20px;
        background: white;
        border-bottom: 1px solid #e9ecef;
        flex-shrink: 0;
      }

      .hub-header h1 {
        font-size: 24px;
        font-weight: 600;
        color: #333;
      }

      .hub-header p {
        font-size: 14px;
        color: #666;
      }

      .accounts-section {
        flex: 1;
        padding: 20px;
        background: #f5f7fa;
        display: flex;
        flex-direction: column;
        gap: 16px;
        overflow: hidden;
      }

      .accounts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        row-gap: 16px; /* è¡Œé—´è·ï¼ˆä¸Šä¸‹é—´è·ï¼‰*/
        column-gap: 16px; /* åˆ—é—´è·ï¼ˆå·¦å³é—´è·ï¼‰*/
        width: 100%;
        /* flex: 1; */
        overflow-y: auto;
        overflow-x: hidden;
        padding-top: 10px;
        /* grid-auto-rows: minmax(80px, auto); */
      }

      .accounts-grid::-webkit-scrollbar {
        width: 6px;
      }

      .accounts-grid::-webkit-scrollbar-track {
        background: transparent;
      }

      .accounts-grid::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
      }

      .accounts-grid::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.3);
      }

      .account-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 18px;
        transition: all 0.3s ease;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        gap: 14px;
        height: fit-content;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .account-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
        border-color: #667eea;
      }

      .account-card-header {
        display: flex;
        align-items: flex-start;
        gap: 12px;
      }

      .account-icon {
        font-size: 32px;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 8px;
        flex-shrink: 0;
      }

      .account-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 0;
      }

      .account-platform {
        font-size: 14px;
        font-weight: 600;
        color: #333;
        word-break: break-word;
      }

      .account-name {
        font-size: 12px;
        color: #999;
        word-break: break-word;
      }

      .account-status {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: #28a745;
      }

      .status-dot {
        width: 6px;
        height: 6px;
        background: #28a745;
        border-radius: 50%;
        flex-shrink: 0;
      }

      .account-actions {
        display: flex;
        gap: 8px;
        padding-top: 12px;
        border-top: 1px solid #e9ecef;
        flex-wrap: wrap;
      }

      .account-btn {
        flex: 1;
        padding: 10px 16px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 70px;
      }

      .enter-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .enter-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      .delete-btn {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
      }

      .delete-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
      }

      .add-account-btn {
        padding: 14px 20px;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        flex-shrink: 0;
        height: fit-content;
      }

      .add-account-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
      }

      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 16px;
        padding: 40px 20px;
        text-align: center;
        background: white;
        border-radius: 12px;
        margin: 20px;
      }

      .empty-icon {
        font-size: 48px;
        opacity: 0.5;
      }

      .empty-text {
        font-size: 16px;
        color: #666;
      }

      .empty-subtext {
        font-size: 13px;
        color: #999;
      }

      @media (max-width: 768px) {
        .hub-header {
          padding: 16px;
        }

        .hub-header h1 {
          font-size: 20px;
        }

        .accounts-section {
          padding: 16px;
        }

        .accounts-grid {
          grid-template-columns: 1fr;
        }
      }

      /* æ·»åŠ æ–°çš„æ ·å¼è§„åˆ™ */
      .account-card {
        background: white;
        border: 1px solid #d9e6f2;
        border-radius: 8px;
        padding: 16px;
        transition: all 0.3s ease;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        gap: 12px;
        height: fit-content;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        position: relative;
      }

      .account-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
        border-color: #667eea;
      }

      /* ä¸»è´¦å·å¡ç‰‡æ ·å¼ */
      .main-account-card {
        border: 2px solid #0066cc;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 102, 204, 0.2);
      }

      /* è´¦å·å¡ç‰‡å¤´éƒ¨ */
      .account-card-header {
        display: flex;
        align-items: flex-start;
        gap: 12px;
      }

      .account-icon {
        font-size: 32px;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 8px;
        flex-shrink: 0;
      }

      .account-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 0;
      }

      .account-platform {
        font-size: 14px;
        font-weight: 600;
        color: #333;
        word-break: break-word;
      }

      .account-name {
        font-size: 12px;
        color: #999;
        word-break: break-word;
      }

      /* çŠ¶æ€æ˜¾ç¤º */
      .account-status {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: #28a745;
      }

      .status-dot {
        width: 6px;
        height: 6px;
        background: #28a745;
        border-radius: 50%;
        flex-shrink: 0;
      }

      /* æ“ä½œæŒ‰é’® */
      .account-actions {
        display: flex;
        gap: 8px;
        padding-top: 12px;
        border-top: 1px solid #e9ecef;
        flex-wrap: wrap;
      }

      .account-btn {
        flex: 1;
        padding: 10px 16px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 70px;
      }

      .enter-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .enter-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      .delete-btn {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
      }

      .delete-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
      }

      /* æ–°å¢çš„ä¸»è´¦å·æ ‡è¯† */
      .main-account-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #ff4d4d;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: bold;
      }

      /* è´¦å·ä¿¡æ¯å±•ç¤º */
      .account-details {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 8px;
      }

      .account-detail-item {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #666;
      }

      .account-detail-label {
        font-weight: 500;
      }

      .account-detail-value {
        font-weight: 600;
      }

      /* è´¦å·çŠ¶æ€æ ‡ç­¾ */
      .account-status-tag {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 500;
      }

      .account-status-active {
        background: #d4edda;
        color: #155724;
      }

      .account-status-pending {
        background: #fff3cd;
        color: #856404
      }
    </style>
  </head>

  <body>
    <div class="hub-container">
      <div class="hub-header">
        <div>
          <h1 id="hubTitle">è´¦å·ç®¡ç†</h1>
          <p id="hubSubtitle">ç‚¹å‡»ä¸‹æ–¹å¡ç‰‡è¿›å…¥å¯¹åº”è´¦å·å¹³å°</p>
        </div>
      </div>
      <div class="accounts-section">
      <div class="accounts-grid" id="accountsGrid"></div>
    </div>
  </div>

  <script>
    // é˜²æŠ–å‡½æ•°
    function debounce(func, delay) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    let currentMenuId = null;
    let navItems = [];
    let accounts = {};
    let showMultipleAccounts = false; // æ˜¯å¦æ˜¾ç¤ºå¤šä¸ªè´¦å·ï¼Œä¸»è¦ç”¨äºç™¾å®¶å·å’Œæ–‡å¿ƒæ™ºèƒ½ä½“
    let currentUserData = null; //ä½œä¸ºç”¨æˆ·æ•°æ®éš”ç¦»

    window.addEventListener("message", (event) => {
      console.log("æ¥æ”¶åˆ°æ¶ˆæ¯", event.data);
      if (event.data.type === "selectMenu") {
        currentMenuId = event.data.menuId;
        navItems = event.data.navItems || [];
        if (event.data.userData) {
          currentUserData = event.data.userData;

          // ç¡®ä¿ accounts ç»“æ„å­˜åœ¨
          if (!accounts[currentUserData.sendId]) {
            accounts[currentUserData.sendId] = {};
          }
          // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºè“Vå¥—é¤ç”¨æˆ·
          checkBlueVPackageStatus(currentUserData.sendId);
        }
        console.log("é€‰æ‹©èœå•", currentMenuId, "å¯¼èˆªé¡¹æ•°é‡", navItems.length);
        renderAccounts();
        setTimeout(debouncedUpdateAccountStatus, 100);
      } else if (event.data.type === "accountAuthorized") {
        // è´¦å·æˆæƒæˆåŠŸï¼Œåˆ·æ–°è´¦å·çŠ¶æ€
        console.log("æ”¶åˆ°è´¦å·æˆæƒæˆåŠŸæ¶ˆæ¯ï¼Œåˆ·æ–°è´¦å·çŠ¶æ€");
        debouncedUpdateAccountStatus();
      }
    });

    // è·å–è´¦å·çŠ¶æ€å¹¶æ›´æ–°æ˜¾ç¤º
    async function updateAccountStatus() {
      console.log("è°ƒç”¨äº†updateAccountStatusï¼Œå½“å‰æ•°æ®ä¸º:", currentUserData);
      console.log("èœå•IDä¸ºï¼š", currentMenuId);

      if (!currentMenuId || !currentUserData || !currentUserData.sendId) {
        console.log("æ›´æ–°è´¦æˆ·æ•°æ®æ—¶ç¼ºå°‘å¿…è¦æ•°æ®");
        return;
      }

      try {
        const electronAPI = window.electronAPI || (window.parent && window.parent.electronAPI);
        if (!electronAPI) {
          console.error('æ— æ³•è°ƒç”¨æ¥å£æ•°æ®');
          return;
        }

        // èœå•IDåˆ°å¹³å°ç±»å‹çš„æ˜ å°„
        const menuIdToTypeMap = {
          1: 1,
          2: 2,
          3: 3,
          4: 4,
          5: 5,
          6: 6,
          7: 7,
          8: 8,
          9: 9
        };

        const platformType = menuIdToTypeMap[currentMenuId] || currentMenuId;

        console.log("æ­£åœ¨è°ƒç”¨ getAccountStatus å½“å‰ userId:", currentUserData.sendId, "type:", platformType);
        const result = await electronAPI.getAccountStatus({
          userId: currentUserData.sendId,
          type: platformType
        });

        console.log("è°ƒç”¨getAccountStatus ç»“æœä¸º:", result);
        console.log("æœåŠ¡å™¨è¿”å›çš„è´¦å·åˆ—è¡¨:", result.accounts);

        if (result.success) {
          if (!accounts[currentUserData.sendId]) {
            accounts[currentUserData.sendId] = {};
          }

          if (accounts[currentUserData.sendId][currentMenuId]) {
            let hasChanges = false;

            // åˆ›å»ºä¸€ä¸ªæ˜ å°„æ¥è·Ÿè¸ªå·²ç»ä½¿ç”¨çš„æœåŠ¡å™¨è´¦å·ï¼ˆä½¿ç”¨ acc_id ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼‰
            const usedServerAccountIds = new Set();

            // å…ˆæŒ‰ position æ’åºæœåŠ¡å™¨è´¦å·ï¼Œç¡®ä¿åŒ¹é…é¡ºåºæ­£ç¡®
            const sortedServerAccounts = [...result.accounts].sort((a, b) => {
              const posA = a.position || 0;
              const posB = b.position || 0;
              return posA - posB;
            });

            accounts[currentUserData.sendId][currentMenuId].forEach((account, index) => {
              const position = account.position || (index + 1);
              let serverAccount = null;

              // å¯¹äºç™¾å®¶å·å’Œæ–‡å¿ƒæ™ºèƒ½ä½“ï¼Œéœ€è¦è€ƒè™‘is_mainå­—æ®µ
              if (currentMenuId === 1 || currentMenuId === 9) {
                // ç»Ÿä¸€å¤„ç† is_mainï¼šå¯èƒ½æ˜¯ 1/0 æˆ– true/false
                const normalizeIsMain = (val) => {
                  if (val === true || val === 1) return 1;
                  if (val === false || val === 0) return 0;
                  return 0;
                };

                const accountIsMain = normalizeIsMain(account.isMain);

                // é¦–å…ˆå°è¯•ç²¾ç¡®åŒ¹é…ï¼šposition å’Œ is_main éƒ½åŒ¹é…
                serverAccount = sortedServerAccounts.find(acc => {
                  const accIsMain = normalizeIsMain(acc.is_main);
                  const accPosition = acc.position || 0;
                  const accId = acc.acc_id;

                  return accPosition === position &&
                    accIsMain === accountIsMain &&
                    accId &&
                    !usedServerAccountIds.has(accId);
                });

                // å¦‚æœæ²¡æœ‰ç²¾ç¡®åŒ¹é…ï¼Œå°è¯•ä»…åŒ¹é… positionï¼ˆä½†ä¼˜å…ˆåŒ¹é…ä¸»è´¦å·ï¼‰
                if (!serverAccount) {
                  // å…ˆå°è¯•åŒ¹é…ä¸»è´¦å·
                  if (position === 1) {
                    serverAccount = sortedServerAccounts.find(acc => {
                      const accIsMain = normalizeIsMain(acc.is_main);
                      const accPosition = acc.position || 0;
                      const accId = acc.acc_id;

                      return accPosition === position &&
                        accIsMain === 1 &&
                        accId &&
                        !usedServerAccountIds.has(accId);
                    });
                  }

                  // å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼ŒåŒ¹é…ä»»æ„ position ç›¸åŒçš„è´¦å·
                  if (!serverAccount) {
                    serverAccount = sortedServerAccounts.find(acc => {
                      const accPosition = acc.position || 0;
                      const accId = acc.acc_id;

                      return accPosition === position &&
                        accId &&
                        !usedServerAccountIds.has(accId);
                    });
                  }
                }
              } else {
                // å…¶ä»–å¹³å°åªéœ€åŒ¹é… position
                serverAccount = sortedServerAccounts.find(acc => {
                  const accPosition = acc.position || 0;
                  const accId = acc.acc_id;

                  return accPosition === position &&
                    accId &&
                    !usedServerAccountIds.has(accId);
                });
              }

              console.log(`ä½ç½® ${position} çš„è´¦å·åŒ¹é…ç»“æœ:`, serverAccount);

              if (serverAccount) {
                // æ ‡è®°è¿™ä¸ªæœåŠ¡å™¨è´¦å·å·²è¢«ä½¿ç”¨
                if (serverAccount.acc_id) {
                  usedServerAccountIds.add(serverAccount.acc_id);
                }
                
                console.log(`æœåŠ¡å™¨è´¦å·æ•°æ® (position ${position}):`, JSON.stringify(serverAccount, null, 2));
                console.log(`userData å­˜åœ¨:`, !!serverAccount.userData, "userData å†…å®¹:", serverAccount.userData);

                const newStatus = serverAccount.acc_id !== null && serverAccount.acc_id !== undefined ? "active" : "pending";

                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
                const serverDataChanged = !account.serverData ||
                  account.serverData.acc_id !== serverAccount.acc_id ||
                  JSON.stringify(account.serverData) !== JSON.stringify(serverAccount);

                if (account.status !== newStatus || serverDataChanged) {
                  account.status = newStatus;
                  account.serverData = serverAccount;
                  // æ›´æ–°è´¦å·åç§°ï¼ˆå¦‚æœæœåŠ¡å™¨æœ‰è¿”å›ï¼‰
                  if (serverAccount.userData && serverAccount.userData.nikeName) {
                    account.name = serverAccount.userData.nikeName;
                  }
                  hasChanges = true;
                  console.log(`æ›´æ–°è´¦æˆ· ${account.id} (position: ${position})ï¼ŒæœåŠ¡å™¨è´¦å·ID: ${serverAccount.acc_id}`);
                }
              } else {
                // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°æœåŠ¡å™¨è´¦å·ï¼Œä¸”å½“å‰è´¦å·çŠ¶æ€ä¸æ˜¯ pendingï¼Œåˆ™é‡ç½®
                if (account.status !== "pending") {
                  account.status = "pending";
                  delete account.serverData;
                  hasChanges = true;
                  console.log(`é‡ç½®è´¦æˆ· ${account.id} (position: ${position}) ä¸º pending çŠ¶æ€`);
                }
              }
            });

            if (hasChanges) {
              console.log("è´¦å·çŠ¶æ€æœ‰å˜åŒ–ï¼Œé‡æ–°æ¸²æŸ“");
              renderAccounts(false);
            } else {
              console.log("è´¦å·çŠ¶æ€æ— å˜åŒ–ï¼Œè·³è¿‡æ¸²æŸ“");
            }
          }
        }
      } catch (error) {
        console.error('è·å–è´¦å·çŠ¶æ€å¤±è´¥:', error);
      }
    }

    const debouncedUpdateAccountStatus = debounce(updateAccountStatus, 300);

    function renderAccounts(shouldUpdateStatus = true) {
        console.log("è°ƒç”¨äº†renderAccounts ç”¨æˆ·IDä¸º:", currentMenuId);
        const accountsGrid = document.getElementById("accountsGrid");

        console.log("è´¦æˆ·ç½‘æ ¼å…ƒç´ :", accountsGrid);
        console.log("è´¦æˆ·çˆ¶çº§å…ƒç´ :", accountsGrid?.parentElement);

        if (currentMenuId === null || currentMenuId === undefined || !currentUserData) {
          console.log("æ— èœå•IDï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€");
          showEmptyState();
          return;
        }

        // ç¡®ä¿å½“å‰ç”¨æˆ·æœ‰è´¦æˆ·å­˜å‚¨ç©ºé—´
        if (!accounts[currentUserData.sendId]) {
          accounts[currentUserData.sendId] = {};
        }
        // if (currentMenuId === 9) {
        //   // æ–‡å¿ƒæ™ºèƒ½ä½“çš„ID
        //   // ç”Ÿæˆ5ä¸ªå›ºå®šè´¦å·
        //   accounts[currentMenuId] = [
        //     {
        //       id: "wenxin_1",
        //       name: "æ–‡å¿ƒæ™ºèƒ½ä½“è´¦å·1",
        //       icon: "ğŸ¤–",
        //       status: "pending",
        //       menuId: 9,
        //     },
        //     {
        //       id: "wenxin_2",
        //       name: "æ–‡å¿ƒæ™ºèƒ½ä½“è´¦å·2",
        //       icon: "ğŸ¤–",
        //       status: "pending",
        //       menuId: 9,
        //     },
        //     {
        //       id: "wenxin_3",
        //       name: "æ–‡å¿ƒæ™ºèƒ½ä½“è´¦å·3",
        //       icon: "ğŸ¤–",
        //       status: "pending",
        //       menuId: 9,
        //     },
        //     {
        //       id: "wenxin_4",
        //       name: "æ–‡å¿ƒæ™ºèƒ½ä½“è´¦å·4",
        //       icon: "ğŸ¤–",
        //       status: "pending",
        //       menuId: 9,
        //     },
        //     {
        //       id: "wenxin_5",
        //       name: "æ–‡å¿ƒæ™ºèƒ½ä½“è´¦å·5",
        //       icon: "ğŸ¤–",
        //       status: "pending",
        //       menuId: 9,
        //     },
        //   ];
        // }


        // æ–‡å¿ƒæ™ºèƒ½ä½“å— showMultipleAccounts æ§åˆ¶
        if (currentMenuId === 9) {
          if (showMultipleAccounts) {
            // ç”Ÿæˆ5ä¸ªå›ºå®šè´¦å·
            accounts[currentUserData.sendId][currentMenuId] = [
              {
                id: "wenxin_1",
                name: "æ–‡å¿ƒæ™ºèƒ½ä½“è´¦å·1",
                icon: "ğŸ¤–",
                status: "pending",
                menuId: 9,
                position: 1
              },
              {
                id: "wenxin_2",
                name: "æ–‡å¿ƒæ™ºèƒ½ä½“è´¦å·2",
                icon: "ğŸ¤–",
                status: "pending",
                menuId: 9,
                position: 2
              },
              {
                id: "wenxin_3",
                name: "æ–‡å¿ƒæ™ºèƒ½ä½“è´¦å·3",
                icon: "ğŸ¤–",
                status: "pending",
                menuId: 9,
                position: 3
              },
              {
                id: "wenxin_4",
                name: "æ–‡å¿ƒæ™ºèƒ½ä½“è´¦å·4",
                icon: "ğŸ¤–",
                status: "pending",
                menuId: 9,
                position: 4
              },
              {
                id: "wenxin_5",
                name: "æ–‡å¿ƒæ™ºèƒ½ä½“è´¦å·5",
                icon: "ğŸ¤–",
                status: "pending",
                menuId: 9,
                position: 5
              },
            ];
          } else {
            // å½“ showMultipleAccounts ä¸º false æ—¶ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤è´¦å·
            accounts[currentUserData.sendId][currentMenuId] = [
              {
                id: "wenxin_default",
                name: "æ–‡å¿ƒæ™ºèƒ½ä½“è´¦å·",
                icon: "ğŸ¤–",
                status: "pending",
                menuId: 9,
                position: 1
              }
            ];
          }
        }

        // æŸ¥æ‰¾å¯¹åº”çš„èœå•é¡¹
        const menuItem = navItems.find((item) => item.id === currentMenuId);
        if (!menuItem) {
          console.log("æœªæ‰¾åˆ°èœå•ï¼Œå…ƒç´ IDä¸º:", currentMenuId);
          showEmptyState();
          return;
        }

        // è·å–æˆ–åˆ›å»ºè´¦å·åˆ—è¡¨
        if (!accounts[currentUserData.sendId][currentMenuId] || accounts[currentUserData.sendId][currentMenuId].length === 0) {
          accounts[currentUserData.sendId][currentMenuId] = [];
          // ç¡®å®šéœ€è¦åˆ›å»ºçš„è´¦å·æ•°é‡ï¼šç™¾å®¶å·(id=1)åˆ›å»º5ä¸ªï¼Œå…¶ä»–å¹³å°åˆ›å»º1ä¸ª
          // const accountCount = currentMenuId === 1 ? 5 : 1;
          const accountCount = ((currentMenuId === 1 || currentMenuId === 9) && showMultipleAccounts) ? 5 : 1;


          // åˆ›å»ºå¯¹åº”æ•°é‡çš„æœªç»‘å®šè´¦å·
          for (let i = 1; i <= accountCount; i++) {
            accounts[currentUserData.sendId][currentMenuId].push({
              id: "pending_" + currentMenuId + "_" + i,
              name: menuItem.name + "è´¦å·" + i,
              icon: menuItem.icon,
              status: "pending", // æœªç»‘å®šçŠ¶æ€
              menuId: currentMenuId,
              position: i,
              isMain: (currentMenuId === 1 || currentMenuId === 9) ? (i === 1 ? 1 : 0) : 0 // ä¸»è´¦å·æ ‡è¯†

            });
          }
        }

        const menuAccounts = accounts[currentUserData.sendId][currentMenuId];
        console.log("æ¸²æŸ“è´¦æˆ·æ•°é‡ä¸ºï¼š", menuAccounts.length, "è´¦æˆ·");
        console.log("èœå•è´¦æˆ·ä¸º:", menuAccounts);

        accountsGrid.innerHTML = "";
        accountsGrid.style.display = "grid";
        console.log("è®¾ç½®ä¸ºç½‘æ ¼æ˜¾ç¤º");

        if (menuAccounts.length > 0) {

          // æŒ‰ç…§ position å­—æ®µæ’åºè´¦å·åˆ—è¡¨
          menuAccounts.sort((a, b) => {
              // ç¡®ä¿æœ‰ position å­—æ®µï¼Œé»˜è®¤ä¸ºç´¢å¼•+1
              const posA = a.position || 0;
              const posB = b.position || 0;
              return posA - posB;
          });

          menuAccounts.forEach((account, index) => {
            console.log("ä¸ºè´¦æˆ·ä¿¡æ¯åˆ›å»ºå¡ç‰‡", index, ":", account);
            const card = createAccountCard(account, menuItem);
            accountsGrid.appendChild(card);
            console.log(
              "è´¦æˆ·å¡ç‰‡å·²æ·»åŠ ï¼Œå½“å‰è´¦æˆ·æ•°é‡ï¼š",
              accountsGrid.children.length
            );
          });
        } else {
          console.log("æ²¡æœ‰è´¦æˆ·ä¿¡æ¯");
          showEmptyState();
        }

        console.log(
          "è´¦å·ä¿¡æ¯é•¿åº¦ä¸ºï¼š",
          accountsGrid.children.length
        );
        if (shouldUpdateStatus) {
          setTimeout(() => {
            debouncedUpdateAccountStatus();
          }, 100);
        }
      }

      function createAccountCard(account, menuItem) {
        console.log("åˆ›å»ºè´¦å·å¡ç‰‡")
        console.log("è´¦æˆ·æ•°æ®ä¸º:", account);
        const card = document.createElement("div");
        card.className = "account-card";
        // æ ¹æ® position è®¾ç½® orderï¼Œä¿è¯åœ¨ CSS Grid ä¸­æŒ‰ä½ç½®æ¸²æŸ“
        const _pos = parseInt(account.position, 10);
        if (!Number.isNaN(_pos) && _pos > 0) {
           card.style.order = _pos;
        }

        // å¦‚æœæ˜¯ä¸»è´¦å·ï¼Œæ·»åŠ ç‰¹æ®Šæ ·å¼
        // if (account.isMain == 1) {
        //   card.classList.add("main-account-card");
        // }

        console.log("æ­£åœ¨ä¸ºä»¥ä¸‹è´¦æˆ·åˆ›å»ºæ•°æ®:", account.serverData);
        // å¡ç‰‡å¤´éƒ¨
        const headerDiv = document.createElement("div");
        headerDiv.className = "account-card-header";

        const iconDiv = document.createElement("div");
        iconDiv.className = "account-icon";
        iconDiv.textContent = menuItem.icon;

        const infoDiv = document.createElement("div");
        infoDiv.className = "account-info";

        const platformName = document.createElement("div");
        platformName.className = "account-platform";
        // platformName.textContent = account.name;
        if (account.serverData && account.serverData.userData.nikeName) {
          console.log("è´¦æˆ·åä¸º:", account.serverData.userData.nikeName);
          platformName.textContent = account.serverData.userData.nikeName;
        } else {
          platformName.textContent = account.name;
        }

        const accountDesc = document.createElement("div");
        accountDesc.className = "account-name";
        // accountDesc.textContent = "è´¦å·ç»‘å®šä¿¡æ¯";
        accountDesc.textContent = account.status === "pending" ? "æœªæˆæƒ" : "å·²æˆæƒ";


        infoDiv.appendChild(platformName);
        infoDiv.appendChild(accountDesc);
        headerDiv.appendChild(iconDiv);
        headerDiv.appendChild(infoDiv);
        
        // ä¸»è´¦å·æ ‡è¯†
        if (account.isMain === 1) {
          const mainBadge = document.createElement("div");
          mainBadge.className = "main-account-badge";
          mainBadge.textContent = "ä¸»è´¦å·";
          card.appendChild(mainBadge);
        }


        // çŠ¶æ€
        const statusDiv = document.createElement("div");
        statusDiv.className = "account-status";
        const statusDot = document.createElement("div");
        statusDot.className = "status-dot";
        const statusText = document.createElement("span");
        // statusText.textContent = "å·²æ¿€æ´»";
        // æ ¹æ®å®é™…çŠ¶æ€æ˜¾ç¤ºæ–‡æœ¬
        statusText.textContent = account.status === "pending" ? "å¾…æˆæƒ" : "å·²æ¿€æ´»";
        // æ ¹æ®çŠ¶æ€æ”¹å˜é¢œè‰²
        // statusText.style.color = account.status === "pending" ? "#999" : "#28a745";
        // æ ¹æ®çŠ¶æ€è®¾ç½®é¢œè‰²
        if (account.status === "pending") {
          statusText.style.color = "#999";
          statusDot.style.background = "#999";
        } else {
          statusText.style.color = "#28a745";
          statusDot.style.background = "#28a745";
        }
        statusDiv.appendChild(statusDot);
        statusDiv.appendChild(statusText);
        
        // è´¦å·è¯¦ç»†ä¿¡æ¯
        if (account.serverData && account.serverData.acc_id) {
          console.log("å¼€å§‹æ¸²æŸ“è´¦å·è¯¦ç»†ä¿¡æ¯, serverData:", account.serverData);
          const detailsDiv = document.createElement("div");
          detailsDiv.className = "account-details";
          
          // è®¤è¯æ—¶é—´
          if (account.serverData.auth_time) {
            const expireItem = document.createElement("div");
            expireItem.className = "account-detail-item";
            expireItem.innerHTML = `
              <span class="account-detail-label">è®¤è¯æ—¶é—´:</span>
              <span class="account-detail-value">${account.serverData.auth_time}</span>
            `;
            detailsDiv.appendChild(expireItem);
          }
          
          // æ•°æ®ç»Ÿè®¡ - æ£€æŸ¥ä¸åŒçš„æ•°æ®å­—æ®µ
          const userData = account.serverData.userData || {};
          console.log("userData å†…å®¹:", userData);
          console.log("userData å­—æ®µæ£€æŸ¥ - sub_data:", userData.sub_data, "read_data:", userData.read_data, "fen_data:", userData.fen_data);
          const hasStats = userData.sub_data || userData.read_data || userData.fen_data || 
                          userData.article_count || userData.read_count || userData.fans_count;
          console.log("hasStats:", hasStats);
          
          if (hasStats) {
            // æ–‡ç« æ•°
            const articleCount = userData.sub_data || userData.article_count || 0;
            if (articleCount > 0) {
              const statsItem = document.createElement("div");
              statsItem.className = "account-detail-item";
              statsItem.innerHTML = `
                <span class="account-detail-label">æ–‡ç« æ•°:</span>
                <span class="account-detail-value">${articleCount}</span>
              `;
              detailsDiv.appendChild(statsItem);
            }
            
            // é˜…è¯»é‡
            const readCount = userData.read_data || userData.read_count || 0;
            if (readCount > 0) {
              const readItem = document.createElement("div");
              readItem.className = "account-detail-item";
              readItem.innerHTML = `
                <span class="account-detail-label">é˜…è¯»é‡:</span>
                <span class="account-detail-value">${readCount}</span>
              `;
              detailsDiv.appendChild(readItem);
            }
            
            // ç²‰ä¸æ•°
            const fansCount = userData.fen_data || userData.fans_count || 0;
            if (fansCount > 0) {
              const fansItem = document.createElement("div");
              fansItem.className = "account-detail-item";
              fansItem.innerHTML = `
                <span class="account-detail-label">ç²‰ä¸æ•°:</span>
                <span class="account-detail-value">${fansCount}</span>
              `;
              detailsDiv.appendChild(fansItem);
            }
          }
          
          card.appendChild(detailsDiv);
        }


        // æ“ä½œæŒ‰é’®
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "account-actions";

        const enterBtn = document.createElement("button");
        enterBtn.className = "account-btn enter-btn";
        // æ ¹æ®è´¦å·çŠ¶æ€æ˜¾ç¤ºä¸åŒæ–‡æœ¬
        enterBtn.textContent = account.status === "pending" ? "å»æˆæƒ" : "è¿›å…¥";
        
        enterBtn.addEventListener("click", async (e) => {
          e.stopPropagation();
          console.log("ç‚¹å‡»äº†ç½‘æ ¼å…ƒç´ ï¼Œè¿›å…¥ç½‘é¡µ", account);
          console.log("è´¦å·çš„ serverData:", account.serverData);
          
          // è®¾ç½®å½“å‰é€‰ä¸­çš„è´¦å·ä¿¡æ¯
          window.currentAccountId = account.serverData ? account.serverData.acc_id : null;
          window.currentAccount = account;

          console.log("å½“å‰è´¦æˆ·ä¿¡æ¯ä¸ºï¼š", window.currentAccount);
          console.log("å½“å‰è´¦æˆ·IDï¼ˆacc_idï¼‰:", window.currentAccountId);

          // æ–‡å¿ƒæ™ºèƒ½ä½“è´¦å·ç‰¹æ®Šå¤„ç†
          if (account.menuId === 9) {
            // å‘é€æ¶ˆæ¯ç»™ä¸»çª—å£ï¼Œè¦æ±‚æ‰“å¼€æ–°çª—å£
            window.parent.postMessage(
              {
                type: "openWenxinAuth",
                accountId: account.serverData ? account.serverData.acc_id : account.id,
                accountIndex: account.position || (account.id.includes('_') ? account.id.split('_')[2] : '1'),
                url: "https://agents.baidu.com/center",
                acc_id: account.serverData ? account.serverData.acc_id : null,
                position: account.position
              },
              "*"
            );
          } else {
            console.log("å‘é€è¿›å…¥webviewæ¶ˆæ¯ç»™ä¸»çª—å£");
            // å®‰å…¨åœ°è®¿é—® electronAPI
            const electronAPI = window.electronAPI || (window.parent && window.parent.electronAPI);
            
            // ç”Ÿæˆå”¯ä¸€çš„ accountIdï¼šä¼˜å…ˆä½¿ç”¨ acc_idï¼Œå¦åˆ™ä½¿ç”¨ position ç»„åˆ
            const uniqueAccountId = account.serverData && account.serverData.acc_id 
              ? `acc_${account.serverData.acc_id}_pos_${account.position}` 
              : `pending_${account.menuId}_${account.position}`;
            
            // è·å– accountIndexï¼šç›´æ¥ä½¿ç”¨ position
            const accountIndex = account.position || (account.id.includes('_') ? account.id.split('_')[2] : '1');
            
            // å¯¹äºæœªæˆæƒè´¦å·ï¼Œä¸æ£€æŸ¥é»˜è®¤åˆ†åŒºcookieï¼Œç¡®ä¿ä½¿ç”¨ç‹¬ç«‹åˆ†åŒº
            if (account.status === "pending") {
              // æœªæˆæƒè´¦å·ç›´æ¥å‘é€æ¶ˆæ¯ï¼Œä¸æ£€æŸ¥é»˜è®¤åˆ†åŒºcookie
              window.parent.postMessage(
                {
                  type: "enterWebview",
                  menuId: account.menuId,
                  accountId: uniqueAccountId,
                  accountIndex: accountIndex,
                  acc_id: account.serverData ? account.serverData.acc_id : null,
                  position: account.position,
                  hasDefaultCookies: false // æ˜ç¡®è®¾ç½®ä¸ºfalseï¼Œç¡®ä¿ä¸ä½¿ç”¨é»˜è®¤åˆ†åŒºcookie
                },
                "*"
              );
            } else if (electronAPI && typeof electronAPI.getCookies === 'function') {
              // å·²æˆæƒè´¦å·å¯ä»¥æ£€æŸ¥é»˜è®¤åˆ†åŒºcookieï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰
              try {
                const defaultCookies = await electronAPI.getCookies(getDomainByMenuId(account.menuId), "persist:zhongshang");
                
                window.parent.postMessage(
                  {
                    type: "enterWebview",
                    menuId: account.menuId,
                    accountId: uniqueAccountId,
                    accountIndex: accountIndex,
                    acc_id: account.serverData ? account.serverData.acc_id : null,
                    position: account.position,
                    hasDefaultCookies: defaultCookies && defaultCookies.length > 0
                  },
                  "*"
                );
              } catch (error) {
                console.error("æ£€æŸ¥cookieæ—¶å‡ºé”™:", error);
                window.parent.postMessage(
                  {
                    type: "enterWebview",
                    menuId: account.menuId,
                    accountId: uniqueAccountId,
                    accountIndex: accountIndex,
                    acc_id: account.serverData ? account.serverData.acc_id : null,
                    position: account.position
                  },
                  "*"
                );
              }
            } else {
              window.parent.postMessage(
                {
                  type: "enterWebview",
                  menuId: account.menuId,
                  accountId: uniqueAccountId,
                  accountIndex: accountIndex,
                  acc_id: account.serverData ? account.serverData.acc_id : null,
                  position: account.position
                },
                "*"
              );
            }
            console.log("æ¶ˆæ¯å·²å‘é€ï¼ŒaccountId:", uniqueAccountId, "position:", account.position);
          }
        });

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "account-btn delete-btn";
        deleteBtn.textContent = "åˆ é™¤";
        deleteBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          deleteAccount(account.id);
        });

        actionsDiv.appendChild(enterBtn);
        actionsDiv.appendChild(deleteBtn);

        card.appendChild(headerDiv);
        card.appendChild(statusDiv);
        card.appendChild(actionsDiv);

        return card;
      }


      function getDomainByMenuId(menuId) {
        const domainMap = {
          1: "https://baijiahao.baidu.com",
          2: "https://mp.sohu.com",
          3: "https://mp.toutiao.com",
          4: "http://zs.open.chuangmaedu.com",
          5: "https://mp.sina.com.cn",
          6: "https://om.qq.com",
          8: "https://mp.163.com"
        };
        return domainMap[menuId] || "";
      }

      function showEmptyState() {
        const accountsGrid = document.getElementById("accountsGrid");
        console.log("è°ƒç”¨äº†showEmptyStateå‡½æ•°");
        accountsGrid.innerHTML = `
                <div style="grid-column: 1/-1;">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <div class="empty-text">æš‚æ— è´¦å·ä¿¡æ¯</div>
                        <div class="empty-subtext">ç‚¹å‡»ä¸‹æ–¹"æ·»åŠ è´¦å·"æŒ‰é’®ç»‘å®šæ–°è´¦å·</div>
                    </div>
                </div>
            `;
      }

      function deleteAccount(accountId) {
        // è·å–è´¦å·çš„çœŸå®IDï¼ˆä»serverDataä¸­ï¼‰
        let realAccountId = null;
        let foundAccount = null;
        
        // åœ¨å½“å‰ç”¨æˆ·çš„è´¦å·ä¸­æŸ¥æ‰¾è¦åˆ é™¤çš„è´¦å·
        if (accounts[currentUserData.sendId] && accounts[currentUserData.sendId][currentMenuId]) {
          for (const account of accounts[currentUserData.sendId][currentMenuId]) {
            if (account.id === accountId) {
              foundAccount = account;
              // å¦‚æœè´¦å·æœ‰serverDataä¸”åŒ…å«acc_idï¼Œåˆ™ä½¿ç”¨acc_idä½œä¸ºçœŸå®ID
              if (account.serverData && account.serverData.acc_id) {
                realAccountId = account.serverData.acc_id;
              }
              break;
            }
          }
        }
        
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°è´¦å·ï¼Œç›´æ¥è¿”å›
        if (!foundAccount) {
          console.error('æœªæ‰¾åˆ°è¦åˆ é™¤çš„è´¦å·:', accountId);
          return;
        }
        
        // å¦‚æœæ˜¯ä¸´æ—¶è´¦å·ï¼ˆæ²¡æœ‰çœŸå®IDï¼‰ï¼Œç›´æ¥è½¯åˆ é™¤ï¼ˆé‡ç½®çŠ¶æ€ï¼‰
        if (!realAccountId) {
          if (confirm("ç¡®å®šè¦åˆ é™¤æ­¤è´¦å·å—ï¼Ÿ")) {
            // è½¯åˆ é™¤ï¼šé‡ç½®è´¦å·çŠ¶æ€
            foundAccount.status = "pending";
            delete foundAccount.serverData;
            
            // å¦‚æœè´¦å·åç§°æ˜¯ä¸´æ—¶åç§°ï¼Œæ¢å¤ä¸ºé»˜è®¤åç§°
            const menuItem = navItems.find((item) => item.id === currentMenuId);
            if (menuItem && foundAccount.id.startsWith("temp_")) {
              foundAccount.name = menuItem.name + "è´¦å·" + foundAccount.position;
            }
            
            renderAccounts();
            console.log('ä¸´æ—¶è´¦å·å·²é‡ç½®ä¸ºæœªæˆæƒçŠ¶æ€');
          }
          return;
        }
        
        // å¯¹äºå·²æœ‰çœŸå®IDçš„è´¦å·ï¼Œè°ƒç”¨åç«¯è§£ç»‘æ¥å£
        if (confirm("ç¡®å®šè¦è§£ç»‘æ­¤è´¦å·å—ï¼Ÿ")) {
          // å®‰å…¨åœ°è®¿é—® electronAPIï¼ˆå…¼å®¹ iframe ç¯å¢ƒï¼‰
          const electronAPI = window.electronAPI || (window.parent && window.parent.electronAPI);
          
          if (!electronAPI) {
            console.error('æ— æ³•è®¿é—® electronAPIï¼Œè§£ç»‘åŠŸèƒ½ä¸å¯ç”¨');
            alert('è§£ç»‘åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
            return;
          }
          
          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          const accountsGrid = document.getElementById("accountsGrid");
          const loadingElement = document.createElement("div");
          loadingElement.style.cssText = "grid-column: 1/-1; padding: 20px; text-align: center; background: rgba(255,255,255,0.9); border-radius: 8px;";
          loadingElement.innerHTML = "<p>æ­£åœ¨è§£ç»‘è´¦å·...</p>";
          accountsGrid.appendChild(loadingElement);
          
          // è°ƒç”¨ä¸»è¿›ç¨‹è¿›è¡Œè§£ç»‘
          electronAPI.unbindAccount({
            accountId: realAccountId,
            userId: currentUserData.sendId
          }).then((result) => {
            // ç§»é™¤åŠ è½½çŠ¶æ€
            if (loadingElement.parentNode) {
              loadingElement.parentNode.removeChild(loadingElement);
            }
            
            if (result.success) {
              // è§£ç»‘æˆåŠŸï¼Œè½¯åˆ é™¤ï¼šé‡ç½®è´¦å·çŠ¶æ€ï¼Œä¸æ¸…é™¤å¡ç‰‡
              if (foundAccount) {
                foundAccount.status = "pending";
                delete foundAccount.serverData;
                
                // æ¢å¤è´¦å·åç§°ä¸ºé»˜è®¤åç§°
                const menuItem = navItems.find((item) => item.id === currentMenuId);
                if (menuItem) {
                  foundAccount.name = menuItem.name + "è´¦å·" + foundAccount.position;
                }
                // ç”Ÿæˆå”¯ä¸€çš„accountIdç”¨äºæ¸…é™¤cookie
                const uniqueAccountId = realAccountId 
                  ? `acc_${realAccountId}_pos_${foundAccount.position}` 
                  : `pending_${currentMenuId}_${foundAccount.position}`;
                
                // æ¸…é™¤è¯¥è´¦å·çš„cookie
                if (electronAPI && typeof electronAPI.clearAccountCookies === 'function') {
                  electronAPI.clearAccountCookies({
                    accountId: uniqueAccountId,
                    menuId: currentMenuId
                  }).then(clearResult => {
                    if (clearResult.success) {
                      console.log('è´¦å·cookieæ¸…é™¤æˆåŠŸ');
                    } else {
                      console.error('è´¦å·cookieæ¸…é™¤å¤±è´¥:', clearResult.message);
                    }
                  });
                }
              }
              
              // é‡æ–°æ¸²æŸ“ï¼Œæ˜¾ç¤ºæ›´æ–°åçš„çŠ¶æ€
              renderAccounts();
              
              // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
              const messageBox = document.createElement("div");
              messageBox.style.cssText = "position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000;";
              messageBox.innerHTML = `
                <h3 style="margin: 0 0 10px 0; color: #28a745;">âœ“ æˆåŠŸ</h3>
                <p style="margin: 0 0 15px 0;">è´¦å·è§£ç»‘æˆåŠŸ</p>
                <button onclick="this.parentElement.remove()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">ç¡®å®š</button>
              `;
              document.body.appendChild(messageBox);

              setTimeout(() => {
                if (messageBox.parentElement) {
                  messageBox.remove();
                }
              }, 3000);
            } else {
              // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
              const messageBox = document.createElement("div");
              messageBox.style.cssText = "position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000;";
              messageBox.innerHTML = `
                <h3 style="margin: 0 0 10px 0; color: #e74c3c;">âš ï¸ é”™è¯¯</h3>
                <p style="margin: 0 0 15px 0;">${result.message || 'è§£ç»‘å¤±è´¥'}</p>
                <button onclick="this.parentElement.remove()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">ç¡®å®š</button>
              `;
              document.body.appendChild(messageBox);

              setTimeout(() => {
                if (messageBox.parentElement) {
                  messageBox.remove();
                }
              }, 3000);
            }
          }).catch((error) => {
            // ç§»é™¤åŠ è½½çŠ¶æ€
            if (loadingElement.parentNode) {
              loadingElement.parentNode.removeChild(loadingElement);
            }
            
            // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
            const messageBox = document.createElement("div");
            messageBox.style.cssText = "position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000;";
            messageBox.innerHTML = `
              <h3 style="margin: 0 0 10px 0; color: #e74c3c;">âš ï¸ é”™è¯¯</h3>
              <p style="margin: 0 0 15px 0;">è§£ç»‘è´¦å·æ—¶å‘ç”Ÿé”™è¯¯</p>
              <button onclick="this.parentElement.remove()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">ç¡®å®š</button>
            `;
            document.body.appendChild(messageBox);

            setTimeout(() => {
              if (messageBox.parentElement) {
                messageBox.remove();
              }
            }, 3000);
            
            console.error('è§£ç»‘è´¦å·æ—¶å‘ç”Ÿé”™è¯¯:', error);
          });
        }
      }

      // function addAccount() {
      //     if (currentMenuId === null || currentMenuId === undefined) {
      //         alert('è¯·å…ˆä»å·¦ä¾§èœå•é€‰æ‹©å¹³å°');
      //         return;
      //     }

      //     if (!accounts[currentMenuId]) {
      //         accounts[currentMenuId] = [];
      //     }

      //     const menuItem = navItems.find(item => item.id === currentMenuId);
      //     if (!menuItem) return;

      //     const newAccount = {
      //         id: 'account_' + Date.now(),
      //         name: menuItem.name + 'è´¦å·' + (accounts[currentMenuId].length + 1),
      //         icon: menuItem.icon,
      //         status: 'active',
      //         menuId: currentMenuId
      //     };

      //     accounts[currentMenuId].push(newAccount);
      //     renderAccounts();

      //     // é€šçŸ¥ä¸»çª—å£éœ€è¦è¿›è¡Œè´¦å·ç»‘å®š
      //     window.parent.postMessage({
      //         type: 'addNewAccount',
      //         menuId: currentMenuId,
      //         accountId: newAccount.id
      //     }, '*');
      // }

      function addAccount() {
        if (accounts[currentUserData.sendId][currentMenuId] === null || accounts[currentUserData.sendId][currentMenuId] === undefined) {
          alert("è¯·å…ˆä»å·¦ä¾§èœå•é€‰æ‹©å¹³å°");
          return;
        }

        // ç›´æ¥å‘é€æ¶ˆæ¯ç»™çˆ¶çª—å£ï¼Œè¿›å…¥å¯¹åº”çš„webviewé¡µé¢è¿›è¡Œè´¦å·ç»‘å®š
        window.parent.postMessage(
          {
            type: "enterWebview",
            menuId: accounts[currentUserData.sendId][currentMenuId].menuId,
          },
          "*"
        );

        const menuItem = navItems.find((item) => item.id === currentMenuId);
        if (!menuItem) return;

        const newAccount = {
          id: "temp_" + Date.now(),
          name: menuItem.name + "æ–°è´¦å·",
          icon: menuItem.icon,
          status: "pending",
          menuId: currentMenuId,
          position: (accounts[currentUserData.sendId][currentMenuId] || []).length + 1,
          isMain: 0
        };

        // å¯ä»¥æš‚æ—¶å­˜å‚¨è¿™ä¸ªè´¦å·ä¿¡æ¯ï¼Œç­‰å¾…ç»‘å®šå®Œæˆåå†æ­£å¼æ·»åŠ 
        // è¿™é‡Œæˆ‘ä»¬å…ˆæ³¨é‡Šæ‰ä¹‹å‰çš„é€»è¾‘ï¼Œç›´æ¥è·³è½¬


        if (!accounts[currentUserData.sendId]) {
          accounts[currentUserData.sendId] = {};
        }
        if (!accounts[currentUserData.sendId][currentMenuId]) {
          accounts[currentUserData.sendId][currentMenuId] = [];
        }
        accounts[currentUserData.sendId][currentMenuId].push(newAccount);
        renderAccounts();
      }
      showEmptyState();
    </script>
  </body>
</html>