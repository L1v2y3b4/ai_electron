<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æˆæƒå·¥å…·</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Microsoft YaHei", "PingFang SC", "Helvetica Neue", Arial,
          sans-serif;
      }

      body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
        color: #333;
      }

      #app {
        display: flex;
        flex: 1;
        overflow: hidden;
        position: relative;
        height: 100vh;
      }

      /* å·¦ä¾§å¯¼èˆªæ ·å¼ */
      .sidebar {
        width: 300px;
        background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
        z-index: 10;
        position: relative;
      }

      .sidebar::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3Cpattern id='grain' width='100' height='100' patternUnits='userSpaceOnUse'%3E%3Ccircle cx='50' cy='50' r='1' fill='rgba(255,255,255,0.05)'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='100' height='100' fill='url(%23grain)'/%3E%3C/svg%3E");
        pointer-events: none;
      }

      .drag-area {
        width: 100%;
        height: 30px;
        cursor: grab;
        -webkit-app-region: drag;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 100;
      }

      .nav-header {
        padding: 40px 20px 20px 20px;
        text-align: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 20px;
      }

      .nav-header h2 {
        color: white;
        font-size: 22px;
        font-weight: 600;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
      }

      .nav-header h2::before {
        margin-right: 12px;
        font-size: 24px;
      }

      .nav-items {
        padding: 25px 20px;
        flex: 1;
        overflow-y: auto;
        position: relative;
        z-index: 1;
      }

      .nav-items::-webkit-scrollbar {
        width: 6px;
      }

      .nav-items::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
      }

      .nav-items::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
      }

      .nav-items::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
      }

      .nav-item {
        display: flex;
        align-items: center;
        padding: 18px 24px;
        margin: 8px 0;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: rgba(255, 255, 255, 0.8);
        font-size: 15px;
        font-weight: 500;
        position: relative;
        overflow: hidden;
      }

      .nav-item::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        transition: left 0.5s;
      }

      .nav-item:hover::before {
        left: 100%;
      }

      .nav-item:hover {
        background: rgba(255, 255, 255, 0.15);
        color: white;
        transform: translateX(5px);
      }

      .nav-item.active {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transform: translateX(5px);
      }

      .nav-item.active::after {
        content: "";
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 60%;
        background: white;
        border-radius: 2px 0 0 2px;
      }

      .nav-item span:first-child {
        margin-right: 15px;
        font-size: 20px;
        width: 24px;
        text-align: center;
      }

      .nav-item span.menu-text {
        flex: 1;
        text-align: left;
      }

      .arrow-container {
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.3s ease;
      }

      .submenu-arrow {
        font-size: 12px;
        transition: transform 0.3s ease;
      }

      .arrow-container.open .submenu-arrow {
        transform: rotate(90deg);
      }

      /* å³ä¾§å†…å®¹å®¹å™¨ï¼Œç”¨äºåˆ‡æ¢hubå’Œwebview */
      .content-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: white;
        border-radius: 20px 0 0 0;
        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.05);
        position: relative;
        height: 100vh;
      }

      .content-area::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(102, 126, 234, 0.2),
          transparent
        );
      }

      .browser-controls {
        padding: 20px 25px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-top: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
      }

      .browser-controls::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(102, 126, 234, 0.1),
          transparent
        );
      }

      .control-group {
        display: flex;
        gap: 16px;
        align-items: center;
        flex-wrap: wrap;
      }

      .refresh-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 13px;
        font-weight: 500;
        padding: 12px 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        min-width: 100px;
      }

      .refresh-btn::before {
        content: "ğŸ”„";
        font-size: 14px;
      }

      .refresh-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .refresh-btn:active {
        transform: translateY(0);
      }

      .update-auth-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 13px;
        font-weight: 500;
        padding: 12px 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
        min-width: 100px;
      }

      .update-auth-btn::before {
        content: "ğŸ”„";
        font-size: 14px;
      }

      .update-auth-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
      }

      .update-auth-btn:active {
        transform: translateY(0);
      }

      .logout-btn {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 20px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 2px 8px rgba(231, 76, 60, 0.2);
        min-width: 100px;
      }

      .logout-btn::before {
        content: "ğŸšª";
        font-size: 14px;
      }

      .logout-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
      }

      .logout-btn:active {
        transform: translateY(0);
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #666;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #28a745;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }

        50% {
          opacity: 0.5;
        }

        100% {
          opacity: 1;
        }
      }

      .message-box {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        padding: 40px;
        text-align: center;
        min-width: 350px;
        z-index: 1000;
        border: 1px solid rgba(102, 126, 234, 0.1);
        backdrop-filter: blur(10px);
      }

      .message-box h3 {
        color: #667eea;
        margin-bottom: 15px;
        font-size: 20px;
        font-weight: 600;
      }

      .message-box p {
        color: #666;
        margin-bottom: 25px;
        font-size: 15px;
        line-height: 1.5;
      }

      .message-box button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .message-box button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .loading-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .sidebar {
          width: 250px;
        }

        .nav-header h2 {
          font-size: 18px;
        }

        .nav-item {
          padding: 15px 20px;
          font-size: 14px;
        }

        .browser-controls {
          padding: 15px 20px;
          flex-direction: column;
          gap: 15px;
        }

        .control-group {
          justify-content: center;
          gap: 12px;
        }

        .refresh-btn,
        .update-auth-btn,
        .logout-btn {
          padding: 10px 16px;
          font-size: 12px;
          min-width: 90px;
        }
      }

      .nav-item {
        animation: slideInLeft 0.5s ease-out;
      }

      @keyframes slideInLeft {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }

        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .content-area {
        animation: slideInRight 0.5s ease-out;
      }

      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(20px);
        }

        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .version-info {
        margin: 20px 20px 15px 20px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 8px;
        font-weight: 500;
        letter-spacing: 0.5px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(5px);
        text-align: center;
        position: relative;
        z-index: 1;
      }

      /* ä¿®å¤åçš„ view-container æ ·å¼ */
      .view-container {
        flex: 1;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      #hubFrame,
      webview {
        width: 100%;
        height: 100%;
        border: none;
        position: absolute;
        top: 0;
        left: 0;
        z-index: -1;
      }
      
      #hubFrame.active,
      webview.active {
        height: 100%;
        display: block;
        z-index: 1;
      }

      iframe {
        width: 100%;
        height: 100% !important;
        border: none;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <div class="sidebar">
        <div class="drag-area" id="dragArea"></div>
        <div class="nav-header">
          <h2 id="userNameHeader">å¹³å°å¯¼èˆª</h2>
        </div>
        <div class="nav-items" id="navItems"></div>
        <div class="version-info" id="versionInfo">v1.0.0</div>
        <div class="browser-controls">
          <div class="control-group">
            <button class="refresh-btn" id="refreshBtn">åˆ·æ–°é¡µé¢</button>
            <button class="update-auth-btn" id="updateAuthBtn">æ›´æ–°æˆæƒ</button>
          </div>
          <div class="control-group">
            <button class="logout-btn" id="logoutBtn">é€€å‡ºç™»å½•</button>
          </div>
        </div>
      </div>
      <div class="content-area">
        <div class="view-container">
          <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
          </div>
          <!-- ä½¿ç”¨iframeåŠ è½½hubé¡µé¢ï¼Œåˆå§‹æ˜¾ç¤ºä¸»é¡µ webview -->
          <iframe
            style="display:inline-flex; width:100%; height:100%"
            id="hubFrame"
            src="./hub.html"
            allow="camera;microphone"
          ></iframe>
          <!-- å³ä¾§ webview å®¹å™¨ -->
          <webview
            id="browserView"
            style="display:inline-flex; width:100%; height:100%"
            partition="persist:zhongshang"
            disablewebsecurity
            webpreferences="javascript=yes, contextIsolation=yes"
            allowpopups
            useragent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36"
          ></webview>
        </div>
      </div>
    </div>

    <script>
      // ä¿®å¤ï¼šåˆ›å»ºä¸€ä¸ªå…¨æ–°çš„electronAPIå¯¹è±¡ï¼Œè€Œä¸æ˜¯æ‰©å±•å¯èƒ½å·²å­˜åœ¨çš„å¯¹è±¡
      if (typeof window.electronAPI === 'undefined') {
        window.electronAPI = {};
      }

      // æ·»åŠ è¯·æ±‚å»é‡æœºåˆ¶
      const requestTracker = new Map();
      
      function generateRequestId(data) {
        return `${data.currentNavId}_${data.sendId}_${data.position || 0}_${Date.now()}`;
      }
      
      function isRequestPending(requestId) {
        return requestTracker.has(requestId) && requestTracker.get(requestId) === 'pending';
      }
      
      function setRequestStatus(requestId, status) {
        requestTracker.set(requestId, status);
        // 5ç§’åè‡ªåŠ¨æ¸…ç†ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
        setTimeout(() => {
          requestTracker.delete(requestId);
        }, 5000);
      }

      // æ·»åŠ Cookieæ•°æ®è§£æè¾…åŠ©å‡½æ•° - ä¿®å¤ç‰ˆæœ¬
      function parseCookieData(cookieString) {
        let cookiesData = cookieString;
        try {
            //å¾ªç¯è§£æï¼Œç›´åˆ°ä¸å†æ˜¯å­—ç¬¦ä¸²ä¸ºæ­¢
            while (typeof cookiesData === 'string') {
                cookiesData = JSON.parse(cookiesData);
            }
        } catch (e) {
            console.error('Cookieæ•°æ®è§£æå¤±è´¥:', e);
            return null;
        }
        
        // æ£€æŸ¥è§£æç»“æœ
        console.log("è§£æåçš„cookiesDataç±»å‹:", typeof cookiesData, Array.isArray(cookiesData), cookiesData);
        
        // å¦‚æœæ˜¯åµŒå¥—æ•°ç»„æ ¼å¼ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ…å«æœ‰æ•ˆCookieçš„æ•°ç»„
        if (Array.isArray(cookiesData)) {
          console.log("æ£€æµ‹åˆ°æ•°ç»„æ ¼å¼ï¼Œé•¿åº¦:", cookiesData.length);
          
          // éå†æ•°ç»„ï¼ŒæŸ¥æ‰¾åŒ…å«Cookieå¯¹è±¡çš„å­æ•°ç»„
          for (let i = 0; i < cookiesData.length; i++) {
            console.log(`æ£€æŸ¥æ•°ç»„ç´¢å¼• ${i}:`, cookiesData[i]);
            
            if (Array.isArray(cookiesData[i])) {
              console.log(`ç´¢å¼• ${i} æ˜¯æ•°ç»„ï¼Œé•¿åº¦:`, cookiesData[i].length);
              
              // æ£€æŸ¥æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯å¦åŒ…å«Cookieå¯¹è±¡
              if (cookiesData[i].length > 0 && 
                  typeof cookiesData[i][0] === 'object' && 
                  cookiesData[i][0] && 
                  cookiesData[i][0].name) {
                console.log("æ‰¾åˆ°æœ‰æ•ˆçš„Cookieæ•°ç»„:", cookiesData[i]);
                return cookiesData[i]; // è¿”å›ç¬¬ä¸€ä¸ªåŒ…å«Cookieå¯¹è±¡çš„æ•°ç»„
              }
            }
          }
          
          // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ…å«Cookieå¯¹è±¡çš„æ•°ç»„ï¼Œä½†é¡¶å±‚åŒ…å«Cookieå¯¹è±¡ï¼Œç›´æ¥è¿”å›
          if (cookiesData.length > 0 && 
              typeof cookiesData[0] === 'object' && 
              cookiesData[0] && 
              cookiesData[0].name) {
            console.log("é¡¶å±‚æ•°ç»„åŒ…å«æœ‰æ•ˆçš„Cookieå¯¹è±¡:", cookiesData);
            return cookiesData;
          }
          
          // å¦‚æœæ‰€æœ‰å­æ•°ç»„éƒ½æ£€æŸ¥è¿‡äº†ä½†æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„Cookieå¯¹è±¡ï¼Œè¿”å›ç¬¬ä¸€ä¸ªéç©ºæ•°ç»„
          for (let i = 0; i < cookiesData.length; i++) {
            if (Array.isArray(cookiesData[i]) && cookiesData[i].length > 0) {
              console.log("è¿”å›ç¬¬ä¸€ä¸ªéç©ºåµŒå¥—æ•°ç»„:", cookiesData[i]);
              return cookiesData[i];
            }
          }
        }
        
        // å¦‚æœæ˜¯ç®€å•æ•°ç»„æ ¼å¼
        if (Array.isArray(cookiesData) && cookiesData.length > 0) {
          console.log("è¿”å›ç®€å•æ•°ç»„æ ¼å¼:", cookiesData);
          return cookiesData;
        }
        
        console.log("æœªæ‰¾åˆ°æœ‰æ•ˆçš„Cookieæ•°æ®");
        return null;
      }

      // ä¿®å¤ï¼šå®‰å…¨åœ°ä¸ºwindow.electronAPIæ·»åŠ å‡½æ•°ï¼Œé¿å…è¦†ç›–å·²å­˜åœ¨çš„å±æ€§
      function safeAssign(target, source) {
        for (const key in source) {
          if (source.hasOwnProperty(key) && !target.hasOwnProperty(key)) {
            target[key] = source[key];
          }
        }
      }

      // å®šä¹‰APIå‡½æ•°
      const apiFunctions = {
        // æ¨¡æ‹ŸAPIæ¥å£ï¼Œå®é™…åœ¨preload.jsä¸­ä¼šè¢«æ›¿æ¢
        getMenuIsAuth: async (data) => {
          if (window.require) {
            const { ipcRenderer } = require('electron');
            try {
              return await ipcRenderer.invoke('get-menu-is-auth', data);
            } catch (error) {
              console.error('è·å–èœå•æƒé™å¤±è´¥:', error);
              return {};
            }
          } else {
            // æ¨¡æ‹Ÿæ•°æ®ç”¨äºå¼€å‘ç¯å¢ƒ
            return {};
          }
        },
        
        checkUserCookies: async (data) => {
          if (window.require) {
            const { ipcRenderer } = require('electron');
            
            try {
              // ç”Ÿæˆå”¯ä¸€è¯·æ±‚IDä»¥é˜²æ­¢é‡å¤è¯·æ±‚
              const requestId = generateRequestId(data);
              
              // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒçš„è¯·æ±‚åœ¨è¿›è¡Œä¸­
              if (isRequestPending(requestId)) {
                console.log('é‡å¤è¯·æ±‚è¢«é˜»æ­¢:', requestId);
                return { success: true, message: 'è¯·æ±‚å·²åœ¨å¤„ç†ä¸­' };
              }
              
              // æ ‡è®°è¯·æ±‚ä¸ºè¿›è¡Œä¸­
              setRequestStatus(requestId, 'pending');
              
              // ä»webviewè·å–cookies
              const cookies = await ipcRenderer.invoke('get-cookies', getDomainByMenuId(data.currentNavId));
              
              // æ„å»ºè¯·æ±‚æ•°æ®
              const requestData = {
                ...data,
                cookiesList: cookies
              };
              
              // å‘é€åˆ°æœåŠ¡å™¨éªŒè¯
              const result = await ipcRenderer.invoke('check-user-cookies', requestData);
              
              if (result.success) {
                // ä¿å­˜è´¦å·Cookieåˆ°æœåŠ¡å™¨ - æ·»åŠ å»é‡æ£€æŸ¥
                await window.electronAPI.saveAccountCookies({
                  userId: data.sendId,
                  type: data.currentNavId,
                  position: data.position,
                  cookies: cookies,
                  accId: data.acc_id || null
                });
                
                console.log('æˆæƒéªŒè¯æˆåŠŸå¹¶å·²ä¿å­˜Cookie');
              } else {
                console.error('æˆæƒéªŒè¯å¤±è´¥:', result.error);
              }
              
              // æ›´æ–°è¯·æ±‚çŠ¶æ€
              setRequestStatus(requestId, result.success ? 'success' : 'error');
              
              return result;
            } catch (error) {
              console.error('éªŒè¯ç”¨æˆ·Cookieæ—¶å‡ºé”™:', error);
              
              // å‘ç”Ÿé”™è¯¯æ—¶ä¹Ÿæ›´æ–°è¯·æ±‚çŠ¶æ€
              const requestId = generateRequestId(data);
              setRequestStatus(requestId, 'error');
              
              return { success: false, error: error.message };
            }
          } else {
            // æ¨¡æ‹Ÿæ•°æ®ç”¨äºå¼€å‘ç¯å¢ƒ
            return { success: true };
          }
        },
        
        // ä¿®å¤ï¼šæ·»åŠ ä¸“é—¨çš„saveAccountCookieså‡½æ•°ï¼Œå¸¦å»é‡æœºåˆ¶
        saveAccountCookies: async (data) => {
          if (window.require) {
            const { ipcRenderer } = require('electron');
            try {
              // ç”Ÿæˆä¿å­˜è¯·æ±‚çš„å”¯ä¸€ID
              const saveRequestId = `save_${data.userId}_${data.type}_${data.position || 0}`;
              
              // é˜²æ­¢çŸ­æ—¶é—´å†…é‡å¤ä¿å­˜
              if (isRequestPending(saveRequestId)) {
                console.log('é‡å¤ä¿å­˜è¯·æ±‚è¢«é˜»æ­¢:', saveRequestId);
                return { success: true, message: 'ä¿å­˜å·²åœ¨è¿›è¡Œä¸­' };
              }
              
              setRequestStatus(saveRequestId, 'pending');
              
              // è¿‡æ»¤é‡è¦Cookie - ä¿®å¤ï¼šæ­£ç¡®å¤„ç†Cookieæ•°æ®
              let importantCookies = [];
              if (Array.isArray(data.cookies)) {
                // å¦‚æœcookieså·²ç»æ˜¯æ•°ç»„æ ¼å¼
                importantCookies = data.cookies.filter(cookie => {
                  const importantNames = ['BDUSS', 'BDUSS_BFESS', 'BAIDUID', 'BAIDUID_BFESS', 'token', 'session', 'auth'];
                  return importantNames.some(name => cookie.name && cookie.name.includes(name));
                });
              } else if (typeof data.cookies === 'string') {
                // å¦‚æœcookiesæ˜¯å­—ç¬¦ä¸²æ ¼å¼ï¼Œå…ˆè§£æ
                try {
                  const parsedCookies = JSON.parse(data.cookies);
                  if (Array.isArray(parsedCookies)) {
                    importantCookies = parsedCookies[0].filter(cookie => {
                      const importantNames = ['BDUSS', 'BDUSS_BFESS', 'BAIDUID', 'BAIDUID_BFESS', 'token', 'session', 'auth'];
                      return importantNames.some(name => cookie.name && cookie.name.includes(name));
                    });
                  }
                } catch (parseError) {
                  console.error('è§£æCookieæ•°æ®å¤±è´¥:', parseError);
                  importantCookies = [];
                }
              }

              // å‘é€åˆ°æœåŠ¡å™¨ä¿å­˜
              const response = await ipcRenderer.invoke('save-account-cookies', {
                userId: data.userId,
                type: data.type,
                position: data.position,
                cookies: JSON.stringify([importantCookies]), // åŒ…è£…æˆæ•°ç»„æ ¼å¼
                acc_id: data.accId
              });
              
              setRequestStatus(saveRequestId, 'success');
              return response;
            } catch (error) {
              console.error('ä¿å­˜è´¦å·Cookieå¤±è´¥:', error);
              const saveRequestId = `save_${data.userId}_${data.type}_${data.position || 0}`;
              setRequestStatus(saveRequestId, 'error');
              return { success: false, error: error.message };
            }
          } else {
            // æ¨¡æ‹Ÿæ•°æ®ç”¨äºå¼€å‘ç¯å¢ƒ
            return { success: true };
          }
        },
        
        getCookies: async (domain, partition = "persist:zhongshang") => {
          if (window.require) {
            const { ipcRenderer } = require('electron');
            try {
              return await ipcRenderer.invoke('get-cookies', domain, partition);
            } catch (error) {
              console.error(`è·å– ${domain} çš„Cookieå¤±è´¥:`, error);
              return [];
            }
          } else {
            // æ¨¡æ‹Ÿæ•°æ®ç”¨äºå¼€å‘ç¯å¢ƒ
            return [];
          }
        },
        
        logout: () => {
          if (window.require) {
            const { ipcRenderer } = require('electron');
            ipcRenderer.invoke('logout');
          }
        },
        
        setUserData: (callback) => {
          if (window.require) {
            const { ipcRenderer } = require('electron');
            ipcRenderer.on('set-user-data-response', (event, data) => {
              callback(data);
            });
          }
        },
        
        moveWindow: (deltaX, deltaY) => {
          if (window.require) {
            const { ipcRenderer } = require('electron');
            ipcRenderer.send('move-window', { deltaX, deltaY });
          }
        },
        
        setWebViewUserAgent: (userAgent) => {
          if (window.require) {
            const { ipcRenderer } = require('electron');
            ipcRenderer.send('set-webview-user-agent', userAgent);
          }
        },
        
        // ä¿®å¤ï¼šç¡®ä¿enterWebviewå‡½æ•°å­˜åœ¨
        enterWebview: (data) => {
          if (window.require) {
            const { ipcRenderer } = require('electron');
            try {
              console.log('è°ƒç”¨enterWebviewå‘é€æ•°æ®:', data);
              ipcRenderer.send('enter-webview', data);
            } catch (error) {
              console.error('è°ƒç”¨enterWebviewå¤±è´¥:', error);
            }
          } else {
            // åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­æ¨¡æ‹Ÿ
            console.log('æ¨¡æ‹ŸenterWebviewè°ƒç”¨:', data);
          }
        },
        
        openUrlInNewWindow: async (data) => {
          if (window.require) {
            const { ipcRenderer } = require('electron');
            try {
              return await ipcRenderer.invoke('open-url-in-new-window', data);
            } catch (error) {
              console.error('æ‰“å¼€æ–°çª—å£å¤±è´¥:', error);
              return { success: false, error: error.message };
            }
          } else {
            // æ¨¡æ‹Ÿæ•°æ®ç”¨äºå¼€å‘ç¯å¢ƒ
            return { success: true };
          }
        },
        
        migrateCookies: async (data) => {
          if (window.require) {
            const { ipcRenderer } = require('electron');
            try {
              // ç¡®ä¿cookieDataæ˜¯æ•°ç»„æ ¼å¼
              let processedCookieData = data.cookieData;
              
              if (typeof data.cookieData === 'string') {
                try {
                  const parsed = JSON.parse(data.cookieData);
                  // å¦‚æœæ˜¯åµŒå¥—æ•°ç»„ï¼Œå–ç¬¬ä¸€ä¸ªéç©ºæ•°ç»„
                  if (Array.isArray(parsed)) {
                    for (let i = 0; i < parsed.length; i++) {
                      if (Array.isArray(parsed[i]) && parsed[i].length > 0) {
                        processedCookieData = parsed[i];
                        break;
                      }
                    }
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°éç©ºæ•°ç»„ï¼Œä½¿ç”¨åŸæ•°ç»„
                    if (!processedCookieData || processedCookieData.length === 0) {
                      processedCookieData = parsed;
                    }
                  }
                } catch (e) {
                  console.error('è§£æCookieå­—ç¬¦ä¸²å¤±è´¥:', e);
                  return { success: false, error: e.message };
                }
              }
              
              return await ipcRenderer.invoke('migrate-cookies', {
                sourcePartition: data.sourcePartition,
                targetPartition: data.targetPartition,
                domain: data.domain,
                cookieData: processedCookieData
              });
            } catch (error) {
              console.error('Cookieè¿ç§»å¤±è´¥:', error);
              return { success: false, error: error.message };
            }
          } else {
            // æ¨¡æ‹Ÿæ•°æ®ç”¨äºå¼€å‘ç¯å¢ƒ
            return { success: true };
          }
        },
        
        getAccountStatus: async (data) => {
          if (window.require) {
            const { ipcRenderer } = require('electron');
            try {
              return await ipcRenderer.invoke('get-account-status', data);
            } catch (error) {
              console.error('è·å–è´¦å·çŠ¶æ€å¤±è´¥:', error);
              return { success: false, accounts: [] };
            }
          } else {
            // æ¨¡æ‹Ÿæ•°æ®ç”¨äºå¼€å‘ç¯å¢ƒ
            return { success: true, accounts: [] };
          }
        },
        
        // å…¼å®¹åŸç‰ˆæœ¬çš„åŠŸèƒ½
        getAgentCookies: async () => {
          if (window.require) {
            const { ipcRenderer } = require('electron');
            try {
              return await ipcRenderer.invoke('get-agent-cookies');
            } catch (error) {
              console.error('è·å–æ™ºèƒ½ä½“Cookieå¤±è´¥:', error);
              return [];
            }
          } else {
            return [];
          }
        },
        
        setCookies: async (data) => {
          if (window.require) {
            const { ipcRenderer } = require('electron');
            try {
              return await ipcRenderer.invoke('set-cookies', data);
            } catch (error) {
              console.error('è®¾ç½®Cookieå¤±è´¥:', error);
              return { success: false };
            }
          } else {
            return { success: true };
          }
        }
      };

      // å®‰å…¨åœ°æ·»åŠ APIå‡½æ•°åˆ°electronAPIå¯¹è±¡
      safeAssign(window.electronAPI, apiFunctions);

      // è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®èœå•IDè·å–åŸŸå
      function getDomainByMenuId(menuId) {
        switch(menuId) {
          case 1: return "https://baijiahao.baidu.com";
          case 2: return "https://mp.sohu.com";
          case 3: return "https://mp.toutiao.com";
          case 4: return "http://zs.open.chuangmaedu.com";
          case 5: return "https://mp.sina.com.cn";
          case 6: return "https://om.qq.com";
          case 7: return "https://mp.163.com";
          case 8: return "https://post.smzdm.com";
          case 9: return "https://agents.baidu.com";
          default: return null;
        }
      }
    </script>
    
    <script src="./main.js"></script>
    <script>
      const userAgents = [
        "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36",
        "Mozilla/5.0 (Macintosh; Intel Mac OS X 13_4) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.4 Safari/605.1.15",
        "Mozilla/5.0 (iPhone; CPU iPhone OS 16_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.4 Mobile/15E148 Safari/604.1",
        "Mozilla/5.0 (Linux; Android 13; SM-S901U) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Mobile Safari/537.36",
      ];

      function getRandomUserAgent() {
        return userAgents[Math.floor(Math.random() * userAgents.length)];
      }

      const navItems = [
        {
          id: 0,
          name: "ä¸»é¡µ",
          url: "./welcome.html",
          icon: "ğŸ ",
          flag: false,
          show: true,
        },
        {
          id: 1,
          name: "ç™¾å®¶å·",
          url: "https://baijiahao.baidu.com/",
          icon: "ğŸ“",
          flag: false,
          show: true,
        },
        {
          id: 2,
          name: "æœç‹",
          url: "https://mp.sohu.com/mpfe/v4/login",
          icon: "ğŸ¦Š",
          flag: false,
          show: true,
        },
        {
          id: 6,
          name: "è…¾è®¯åˆ›ä½œ",
          url: "https://om.qq.com/main",
          icon: "ğŸ§",
          flag: false,
          show: true,
        },
        {
          id: 4,
          name: "å¾®ä¿¡å…¬ä¼—å·",
          url: "http://zs.open.chuangmaedu.com/openPlatform/preAuthCodeHtml/open?id=",
          icon: "ğŸ’¬",
          flag: false,
          show: true,
        },
        {
          id: 3,
          name: "ä»Šæ—¥å¤´æ¡",
          url: "https://mp.toutiao.com/auth/page/login",
          icon: "ğŸ“°",
          flag: false,
          show: false,
        },
        {
          id: 5,
          name: "æ–°æµª",
          url: "https://mp.sina.com.cn/",
          icon: "ğŸ•Šï¸",
          flag: false,
          show: false,
        },
        {
          id: 8,
          name: "ç½‘æ˜“",
          url: "https://mp.163.com/login.html#/",
          icon: "ğŸŒ",
          flag: false,
          show: false,
        },
      ];

      let token = "";
      let sendId = "";
      let currentNavId = 0;
      let sendFlag = false;
      let userName = "";
      let cookiesList = [];
      let agentCookies = []; // æ·»åŠ æ™ºèƒ½ä½“cookieå˜é‡
      let isCollectingLoginSequence = false; // æ·»åŠ è‡ªåŠ¨åŒ–æµç¨‹æ ‡å¿—
      let currentViewMode = "home"; // åˆå§‹åŒ–ä¸ºä¸»é¡µæ¨¡å¼

      // æ·»åŠ ä¸€ä¸ªå…¨å±€å˜é‡æ¥è·Ÿè¸ªå½“å‰è´¦å·ä¿¡æ¯
      let currentAccountInfo = null;
      
      window.electronAPI.setUserData((event, data) => {
        token = data.token;
        sendId = data.sendId;
        userName = data.userName;
        console.log("=======userName", userName);
        const userNameHeader = document.getElementById("userNameHeader");
        if (userNameHeader && userName) {
          userNameHeader.textContent = userName;
        }
        window.electronAPI
          .getMenuIsAuth({
            id: sendId,
            _type: "zmt_wy",
          })
          .then((result) => {
            console.log("æƒé™è°ƒç”¨ç»“æœ:", result);
            navItems.forEach((item) => {
              if (result.hasOwnProperty(item.id) && result[item.id]) {
                item.show = result[item.id];
              }
            });
            initApp();
          })
          .catch((error) => {
            console.error("æƒé™è°ƒç”¨å¤±è´¥:", error);
            initApp();
          });
      });

      function initDragAndDrop() {
        const dragArea = document.getElementById("dragArea");
        let isDragging = false;
        let startX, startY;

        dragArea.addEventListener("mousedown", (e) => {
          isDragging = true;
          startX = e.clientX;
          startY = e.clientY;
          dragArea.style.cursor = "grabbing";
        });

        document.addEventListener("mousemove", (e) => {
          if (!isDragging) return;
          const deltaX = e.clientX - startX;
          const deltaY = e.clientY - startY;
          window.electronAPI.moveWindow(deltaX, deltaY);
          startX = e.clientX;
          startY = e.clientY;
        });

        document.addEventListener("mouseup", () => {
          isDragging = false;
          dragArea.style.cursor = "grab";
        });
      }

      function initApp() {
        initDragAndDrop();
        cookiesList = [];
        const navItemsCo = document.getElementById("navItems");
        const versionInfo = document.getElementById("versionInfo");
        const params = new URLSearchParams(window.location.search);
        const version = params.get("version");
        if (version) {
          versionInfo.textContent = `Â© 2025 æˆæƒå·¥å…· v${version}`;
        }

        navItems.forEach((item, index) => {
          if (item.id != 5 && item.id != 3 && item.show) {
            const navItem = document.createElement("div");
            navItem.className = "nav-item";
            if (item.id === currentNavId) navItem.classList.add("active");
            navItem.dataset.id = item.id;
            navItem.style.animationDelay = `${index * 0.1}s`;

            if (item.id === 1) {
              navItem.innerHTML = `
                            <span>${item.icon}</span>
                            <span class="menu-text">${item.name}</span>
                            <div class="arrow-container" id="arrowContainer">
                                <span class="submenu-arrow">â–¶</span>
                            </div>
                        `;
            } else {
              navItem.innerHTML = `
                            <span>${item.icon}</span>
                            <span class="menu-text">${item.name}</span>
                        `;
            }

            navItem.addEventListener("click", (e) => {
              if (
                e.target.classList.contains("submenu-arrow") ||
                e.target.parentElement.classList.contains("arrow-container")
              ) {
                e.stopPropagation();
                const subMenu = document.getElementById("wenxinSubMenu");
                const arrowContainer =
                  document.getElementById("arrowContainer");

                if (
                  subMenu.style.display === "none" ||
                  !subMenu.style.display
                ) {
                  subMenu.style.display = "flex";
                  arrowContainer.classList.add("open");
                } else {
                  subMenu.style.display = "none";
                  arrowContainer.classList.remove("open");
                }
                return;
              }

              document
                .querySelector(".nav-item.active")
                .classList.remove("active");
              navItem.classList.add("active");
              currentNavId = item.id;

              const hubFrame = document.getElementById("hubFrame");
              const webview = document.getElementById("browserView");

              if (item.id === 0) {
                // ä¸»é¡µï¼šæ˜¾ç¤ºåŸæ¥çš„ webview
                currentViewMode = "home";
                webview.classList.add("active");
                hubFrame.classList.remove("active");
                console.log(
                  "[v0] Switched to HOME - webview.active:",
                  webview.classList.contains("active"),
                  "hubFrame.active:",
                  hubFrame.classList.contains("active")
                );
                webview.src = item.url;
              } else {
                // å…¶ä»–èœå•ï¼šæ˜¾ç¤ºhubä¸­è½¬é¡µé¢
                currentViewMode = "hub";
                hubFrame.classList.add("active");
                webview.classList.remove("active");
                console.log(
                  "[v0] Switched to HUB - webview.active:",
                  webview.classList.contains("active"),
                  "hubFrame.active:",
                  hubFrame.classList.contains("active")
                );

                setTimeout(() => {
                  console.log(
                    "[v0] Sending selectMenu to hub, menuId:",
                    item.id,
                    "navItems:",
                    navItems
                  );
                  const hubContent = hubFrame.contentWindow;
                  if (hubContent) {
                    hubContent.postMessage(
                      {
                        type: "selectMenu",
                        menuId: item.id,
                        navItems: navItems,
                        userData: {sendId: sendId}
                      },
                      "*"
                    );
                  }
                }, 300);
              }

              cookiesList = [];
            });

            navItemsCo.appendChild(navItem);

            if (item.id === 1) {
              const subMenu = document.createElement("div");
              subMenu.className = "nav-item";
              subMenu.id = "wenxinSubMenu";
              subMenu.style.paddingLeft = "48px";
              subMenu.style.fontSize = "14px";
              subMenu.style.opacity = "0.85";
              subMenu.style.display = "none";
              subMenu.innerHTML = `<span>ğŸ¤–</span><span class="menu-text">æ–‡å¿ƒæ™ºèƒ½ä½“</span>`;
              
              // å…¼å®¹ä¸¤ç§ç‰ˆæœ¬çš„æ–‡å¿ƒæ™ºèƒ½ä½“ç‚¹å‡»äº‹ä»¶
              subMenu.addEventListener("click", async () => {
                document.querySelector(".nav-item.active").classList.remove("active");
                subMenu.classList.add("active");
                
                // åˆ‡æ¢åˆ°è´¦å·ç®¡ç†è§†å›¾
                currentViewMode = "hub";
                currentNavId = 1; // ä¸ç™¾å®¶å·ä½¿ç”¨ç›¸åŒçš„menuId
                const hubFrame = document.getElementById("hubFrame");
                const webview = document.getElementById("browserView");
                
                hubFrame.classList.add("active");
                webview.classList.remove("active");
                
                // é€šçŸ¥hubé¡µé¢åˆ‡æ¢åˆ°æ–‡å¿ƒæ™ºèƒ½ä½“è´¦å·ç®¡ç†
                // ä¼ å‚ä¸ç™¾å®¶å·ç›¸åŒï¼ˆmenuId: 1ï¼‰ï¼Œä½†æ·»åŠ actualTypeæ ‡è¯†å®é™…ç±»å‹ä¸º9
                hubFrame.contentWindow.postMessage({
                  type: "selectMenu",
                  menuId: 1, // ä¸ç™¾å®¶å·ä¼ å‚ç›¸åŒ
                  actualType: 9, // å®é™…ç±»å‹æ ‡è¯†ï¼Œç”¨äºæ¥å£è°ƒç”¨
                  navItems: [...navItems, {
                    id: 1,
                    name: "æ–‡å¿ƒæ™ºèƒ½ä½“",
                    url: "https://agents.baidu.com/center",
                    icon: "ğŸ¤–",
                    flag: false,
                    show: true
                  }],
                  userData: {sendId: sendId}
                }, "*");
              });
              navItemsCo.appendChild(subMenu);
            }
          }
        });

        // åˆå§‹æ˜¾ç¤ºä¸»é¡µ
        const homeNavItem = navItems.find((item) => item.id === 0);
        if (homeNavItem) {
          currentNavId = 0;
          currentViewMode = "home";
          const webview = document.getElementById("browserView");
          const hubFrame = document.getElementById("hubFrame");
          webview.classList.add("active");
          hubFrame.classList.remove("active");
          webview.src = homeNavItem.url;

          // æ ‡è®°ä¸»é¡µèœå•ä¸ºæ´»è·ƒçŠ¶æ€
          const homeMenuItem = navItemsCo.querySelector('[data-id="0"]');
          if (homeMenuItem) {
            homeMenuItem.classList.add("active");
          }
        }
      }

      document.getElementById("refreshBtn").addEventListener("click", () => {
        const webview = document.getElementById("browserView");
        showLoading();
        if (currentViewMode === "hub") {
          hideLoading();
          return;
        }
        if (currentNavId === 8 || currentNavId === 4) {
          const a = navItems.find((item) => item.id === currentNavId);
          webview.src = a.url + sendId;
        } else {
          webview.reload();
        }
      });

      document.getElementById("updateAuthBtn").addEventListener("click", () => {
        if (currentViewMode === "hub") {
          showSuccessMessage("è¯·å…ˆé€‰æ‹©è´¦å·è¿›å…¥ç¼–è¾‘");
          return;
        }
        updateAuthorization();
      });

      document.getElementById("logoutBtn").addEventListener("click", () => {
        window.electronAPI.logout();
      });

      const webview = document.getElementById("browserView");

      webview.addEventListener("did-start-loading", () => {
        showLoading();
      });

      webview.addEventListener("did-stop-loading", () => {
        hideLoading();
      });

      webview.addEventListener("did-finish-load", async () => {
        hideLoading();
        const currentUrl = webview.getURL();
        console.log("WebviewåŠ è½½å®Œæˆï¼Œå½“å‰url:", currentUrl);
        if (
          currentUrl.includes("https://mp.toutiao.com/profile_v4/index") ||
          "/profile_v4/index".includes(currentUrl)
        ) {
          checkLoginStatus(currentUrl);
        }
        if (
          currentUrl.includes(
            "http://zs.open.chuangmaedu.com/openPlatform/callback"
          )
        ) {
          checkLoginStatus(currentUrl);
        }
        if (
          currentUrl.includes("https://post.smzdm.com/tougao") &&
          !currentUrl.includes("login")
        ) {
          checkLoginStatus(currentUrl);
        }
        if (currentUrl.includes("https://om.qq.com/main")) {
          checkLoginStatus(currentUrl);
        }
        // å…¼å®¹åŸç‰ˆæœ¬çš„æ™ºèƒ½ä½“cookieè·å–
        agentCookies = await window.electronAPI.getAgentCookies();
        console.log('å½“å‰æ™ºèƒ½ä½“çš„cookies:', agentCookies);
      });

      webview.addEventListener("did-fail-load", (event) => {
        const { errorCode, errorDescription, validatedURL } = event;
        // å¿½ç•¥ä¸€äº›å¸¸è§çš„éå…³é”®é”™è¯¯ç ï¼Œé¿å…æ—¥å¿—åˆ·å±
        if (errorCode !== -3 && errorCode !== -27) {
          console.error(
            `WebviewåŠ è½½å¤±è´¥: ${errorCode} - ${errorDescription} - URL: ${validatedURL}`
          );
        }
        // éšè—åŠ è½½åŠ¨ç”»
        hideLoading();
      });

      webview.addEventListener("did-navigate-in-page", (event) => {
        console.log(event);
        const currentUrl = event.url || webview.getURL();
        console.log("é¡µé¢å†…URLå˜åŒ–:", currentUrl);
        checkLoginStatus(currentUrl);
      });

      window.addEventListener("message", (event) => {
        if (event.data.type === "enterWebview") {
          // æ¥è‡ªhubé¡µé¢ï¼šç”¨æˆ·ç‚¹å‡»äº†è´¦å·å¡ç‰‡ï¼Œè¿›å…¥webview
          currentViewMode = "webview";
          const hubFrame = document.getElementById("hubFrame");
          const containerView = document.querySelector('.view-container');
          
          // æ›´æ–°å½“å‰è´¦å·ä¿¡æ¯
          currentAccountInfo = {
            id: event.data.id,
            name: event.data.name,
            acc_id: event.data.acc_id,
            position: event.data.position,
            menuId: event.data.menuId
          };
          
          console.log("å½“å‰è´¦æˆ·ä¿¡æ¯ä¸ºï¼š", currentAccountInfo);
          console.log("å½“å‰è´¦æˆ·IDï¼ˆacc_idï¼‰:", currentAccountInfo.acc_id);

          // è·å–é¢å¤–å‚æ•°
          const isMain = event.data.isMain || 0;
          const position = event.data.position || 1;
          const accId = event.data.acc_id || null;

          // å°†positionå‚æ•°ä¿å­˜åˆ°windowå¯¹è±¡ä¸­ï¼Œä»¥ä¾¿åœ¨checkLoginStatuså‡½æ•°ä¸­ä½¿ç”¨
          window.currentAccountPosition = position;

          // ç§»é™¤æ—§çš„ webview
          const oldWebview = document.getElementById("browserView");
          if (oldWebview) {
            oldWebview.remove();
          }
          
          // åˆ›å»ºæ–°çš„ webview å¹¶è®¾ç½®ç‹¬ç«‹åˆ†åŒº
          const newWebview = document.createElement('webview');
          newWebview.id = "browserView";
          newWebview.style.cssText = "display:inline-flex; width:100%; height:100%";
          
          // ä¸ºä¸åŒè´¦å·åˆ›å»ºç‹¬ç«‹çš„åˆ†åŒº
          // æ ¹æ®è´¦å·çŠ¶æ€å†³å®šä½¿ç”¨å“ªä¸ªåˆ†åŒº
          let partition;
          if (accId && accId !== null) {
            // å·²æˆæƒè´¦å·ä½¿ç”¨ç‹¬ç«‹åˆ†åŒº
            partition = `persist:account_acc_${accId}_pos_${position}`;
          } else {
            // æœªæˆæƒè´¦å·ä½¿ç”¨ä¸´æ—¶åˆ†åŒº
            partition = `persist:temp_${event.data.menuId}_${position}_${Date.now()}`;
          }
          
          newWebview.partition = partition;
          newWebview.setAttribute("disablewebsecurity", "");
          newWebview.setAttribute("webpreferences", "javascript=yes, contextIsolation=yes");
          newWebview.setAttribute("allowpopups", "");
          newWebview.setAttribute("useragent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36");
          
          // å¦‚æœæ˜¯å·²æˆæƒè´¦å·ï¼Œé¢„å…ˆè®¾ç½®cookie
          if (accId && accId !== null && event.data.accountIndex) {
            // å…ˆä¸ç«‹å³æ·»åŠ webviewï¼Œè€Œæ˜¯å…ˆè®¾ç½®cookie
            setAccountCookies(partition, event.data.menuId, accId, position).then(() => {
              // Cookieè®¾ç½®å®Œæˆåï¼Œå†æ·»åŠ webviewå¹¶åŠ è½½é¡µé¢
              finishWebviewSetup(newWebview, hubFrame, containerView, event.data, partition);
            });
          } else {
            // æœªæˆæƒè´¦å·ç›´æ¥æ·»åŠ webview
            finishWebviewSetup(newWebview, hubFrame, containerView, event.data, partition);
          }

          // æ·»åŠ åˆ°å®¹å™¨ä¸­
          containerView.appendChild(newWebview);

          hubFrame.classList.remove("active");
          newWebview.classList.add("active");
        }
        
        if (event.data.type === "openWenxinAuth") {
          // æ‰“å¼€æ–‡å¿ƒæ™ºèƒ½ä½“æˆæƒé¡µé¢
          if (window.electronAPI && typeof window.electronAPI.openUrlInNewWindow === 'function') {
            window.electronAPI.openUrlInNewWindow({
              url: event.data.url,
              partition: `persist:wenxin_${event.data.accountId}`,
              acc_id: event.data.accountId,
            });
          } else {
            console.error("window.electronAPI.openUrlInNewWindow is not a function");
          }
        }
      });

      // æ–°å¢å‡½æ•°ï¼šå®Œæˆwebviewè®¾ç½®
      function finishWebviewSetup(newWebview, hubFrame, containerView, data, partition) {
        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        newWebview.addEventListener("did-start-loading", () => {
          showLoading();
        });
        
        newWebview.addEventListener("did-stop-loading", () => {
          hideLoading();
        });

        newWebview.addEventListener("did-fail-load", (event) => {
          const { errorCode, errorDescription, validatedURL } = event;
          // å¿½ç•¥ä¸€äº›å¸¸è§çš„éå…³é”®é”™è¯¯ç ï¼Œé¿å…æ—¥å¿—åˆ·å±
          if (errorCode !== -3 && errorCode !== -27) {
            console.error(
              `WebviewåŠ è½½å¤±è´¥: ${errorCode} - ${errorDescription} - URL: ${validatedURL}`
            );
          }
          // éšè—åŠ è½½åŠ¨ç”»
          hideLoading();
        });
        
        newWebview.addEventListener("did-finish-load", async () => {
          hideLoading();
          const currentUrl = newWebview.getURL();
          console.log("WebviewåŠ è½½å®Œæˆï¼Œå½“å‰url:", currentUrl);
          if (
            currentUrl.includes("https://mp.toutiao.com/profile_v4/index") ||
            "/profile_v4/index".includes(currentUrl)
          ) {
            checkLoginStatus(currentUrl);
          }
          if (
            currentUrl.includes(
              "http://zs.open.chuangmaedu.com/openPlatform/callback"
            )
          ) {
            checkLoginStatus(currentUrl);
          }
          if (
            currentUrl.includes("https://post.smzdm.com/tougao") &&
            !currentUrl.includes("login")
          ) {
            checkLoginStatus(currentUrl);
          }
          if (currentUrl.includes("https://om.qq.com/main")) {
            checkLoginStatus(currentUrl);
          }
          // å…¼å®¹åŸç‰ˆæœ¬çš„æ™ºèƒ½ä½“cookieè·å–
          agentCookies = await window.electronAPI.getAgentCookies();
          console.log('å½“å‰æ™ºèƒ½ä½“çš„cookies:', agentCookies);
        });
        
        newWebview.addEventListener("did-navigate-in-page", (event) => {
          const currentUrl = event.url || newWebview.getURL();
          console.log("é¡µé¢å†…URLå˜åŒ–:", currentUrl);
          checkLoginStatus(currentUrl);
        });

        // æ·»åŠ åˆ°å®¹å™¨ä¸­
        containerView.appendChild(newWebview);

        hubFrame.classList.remove("active");
        newWebview.classList.add("active");

        showLoading();
        const randomUA = getRandomUserAgent();
        if (window.electronAPI && window.electronAPI.setWebViewUserAgent) {
          window.electronAPI.setWebViewUserAgent(randomUA);
        }

        // ä»navItemsä¸­è·å–å¯¹åº”çš„url
        const menuItem = navItems.find(
          (item) => item.id === data.menuId
        );
        if (menuItem) {
          let targetUrl = menuItem.url;
          
          // æ ¹æ®è´¦å·çŠ¶æ€å†³å®šåŠ è½½çš„URL
          // å¦‚æœè´¦å·å·²æˆæƒä¸”æœ‰æœåŠ¡å™¨æ•°æ®ï¼Œç›´æ¥åŠ è½½å¹³å°ä¸»é¡µ
          if (data.acc_id && data.acc_id !== null) {
            // å·²æˆæƒè´¦å·ï¼ŒåŠ è½½å¹³å°ä¸»é¡µ
            switch(data.menuId) {
              case 1: // ç™¾å®¶å·
                targetUrl = "https://baijiahao.baidu.com/builder/rc/home";
                break;
              case 2: // æœç‹å·
                targetUrl = "https://mp.sohu.com/mpfe/v3/main";
                break;
              case 3: // å¤´æ¡å·
                targetUrl = "https://mp.toutiao.com/profile_v4/index";
                break;
              case 5: // æ–°æµªçœ‹ç‚¹
                targetUrl = "https://mp.sina.com.cn/main/articleList";
                break;
              case 6: // ä¼é¹…å·
                targetUrl = "https://om.qq.com/main";
                break;
              case 7: // ç½‘æ˜“å·
                targetUrl = "https://mp.163.com/index.html";
                break;
              case 8: // ä»€ä¹ˆå€¼å¾—ä¹°
                targetUrl = "https://post.smzdm.com/tougao";
                break;
              case 9: // æ–‡å¿ƒæ™ºèƒ½ä½“
                targetUrl = "https://agents.baidu.com/center";
                break;
              // å…¶ä»–å¹³å°ä¿æŒé»˜è®¤URL
            }
          } else {
            // æœªæˆæƒè´¦å·ï¼ŒåŠ è½½ç™»å½•é¡µé¢
            switch(data.menuId) {
              case 1: // ç™¾å®¶å·
                targetUrl = "https://baijiahao.baidu.com/";
                break;
              case 2: // æœç‹å·
                targetUrl = "https://mp.sohu.com/mpfe/v4/login";
                break;
              case 3: // å¤´æ¡å·
                targetUrl = "https://mp.toutiao.com/auth/page/login";
                break;
              case 4: // å¾®ä¿¡å…¬ä¼—å·
                targetUrl = menuItem.url + sendId;
                break;
              case 5: // æ–°æµªçœ‹ç‚¹
                targetUrl = "https://mp.sina.com.cn/";
                break;
              case 6: // ä¼é¹…å·
                targetUrl = "https://om.qq.com/main";
                break;
              case 8: // ç½‘æ˜“å·
                targetUrl = "https://mp.163.com/login.html#/";
                break;
              case 9: // æ–‡å¿ƒæ™ºèƒ½ä½“
                targetUrl = "https://agents.baidu.com/center";
                break;
            }
          }
          
          if (data.menuId === 4) {
            newWebview.src = targetUrl + sendId;
          } else if (data.menuId === 8) {
            newWebview.src = targetUrl + sendId;
          } else {
            newWebview.src = targetUrl;
          }
          console.log(`åŠ è½½URL:${newWebview.src}, åˆ†åŒº:${partition}`);
        }
        
        // å‘é€æ¶ˆæ¯ç»™ä¸»çª—å£
        console.log("å‘é€è¿›å…¥webviewæ¶ˆæ¯ç»™ä¸»çª—å£");
        if (window.electronAPI && typeof window.electronAPI.enterWebview === 'function') {
          window.electronAPI.enterWebview({
            accountId: `acc_${data.acc_id}_pos_${data.position}`,
            position: data.position,
            menuId: data.menuId,
            accId: data.acc_id
          });
          console.log("æ¶ˆæ¯å·²å‘é€ï¼ŒaccountId:", `acc_${data.acc_id}_pos_${data.position}`, "position:", data.position);
        } else {
          console.error("window.electronAPI.enterWebview is not a function");
        }
      }

      // æ–°å¢å‡½æ•°ï¼šè®¾ç½®è´¦å·cookie
      async function setAccountCookies(partition, menuId, accId, position) {
        try {
          console.log("å¼€å§‹ä¸ºåˆ†åŒºè®¾ç½®cookie:", partition);
          // è°ƒç”¨ä¸»è¿›ç¨‹è·å–å·²ä¿å­˜çš„è´¦å·çŠ¶æ€ä¿¡æ¯
          const accountStatusData = await window.electronAPI.getAccountStatus({
            userId: sendId,
            type: menuId
          });
          
          if (accountStatusData.success) {
            // æŸ¥æ‰¾æŒ‡å®šä½ç½®çš„è´¦å·
            const account = accountStatusData.accounts.find(acc => acc.acc_id === accId && acc.position === position);
            
            if (account && account.cookies) {
              console.log("æ‰¾åˆ°è´¦å·cookieæ•°æ®ï¼Œå‡†å¤‡è®¾ç½®åˆ°åˆ†åŒº");
              console.log("cookies:", account.cookies);
              
              // ä½¿ç”¨ä¿®å¤åçš„è§£æå‡½æ•°
              const cookiesData = parseCookieData(account.cookies);
              console.log("è§£æåçš„cookiesData:", cookiesData);
              
              if (cookiesData && Array.isArray(cookiesData) && cookiesData.length > 0) {
                // è·å–ç›®æ ‡åŸŸå
                const domain = getDomainByMenuId(menuId);
                if (domain) {
                  // ä½¿ç”¨cookieè¿ç§»åŠŸèƒ½å°†cookieè®¾ç½®åˆ°ç›®æ ‡åˆ†åŒº
                  const migrateResult = await window.electronAPI.migrateCookies({
                    sourcePartition: "persist:zhongshang",
                    targetPartition: partition,
                    domain: domain,
                    cookieData: cookiesData
                  });
                  console.log("Cookieè¿ç§»ç»“æœ:", migrateResult);
                  return migrateResult.success;
                }
              } else {
                console.log("æœªæ‰¾åˆ°æœ‰æ•ˆçš„cookieæ•°æ®æˆ–cookieæ•°æ®ä¸ºç©º");
                console.log("è§£æåçš„cookiesData:", cookiesData);
              }
            } else {
              console.log("æœªæ‰¾åˆ°è´¦å·æˆ–cookieæ•°æ®", { account: !!account, hasCookies: account && !!account.cookies });
            }
          } else {
            console.log("è·å–è´¦å·çŠ¶æ€å¤±è´¥");
          }
        } catch (error) {
          console.error("è®¾ç½®è´¦å·cookieæ—¶å‡ºé”™:", error);
        }
        return false;
      }

      function showLoading() {
        const loadingOverlay = document.getElementById("loadingOverlay");
        loadingOverlay.classList.add("show");
      }

      function hideLoading() {
        const loadingOverlay = document.getElementById("loadingOverlay");
        loadingOverlay.classList.remove("show");
      }

      // å®šä¹‰ä¸€ä¸ªè¾…åŠ©å‡½æ•°æ¥è·å–å½“å‰ webview åˆ†åŒºçš„ cookies
      async function getCurrentWebviewCookies(domain, partition) {
        try {
          // ä½¿ç”¨ä¼ å…¥çš„åˆ†åŒºï¼Œè€Œä¸æ˜¯é»˜è®¤åˆ†åŒº
          const cookies = await window.electronAPI.getCookies(domain, partition);
          console.log(`è·å–åˆ†åŒº ${partition} çš„ cookies for domain: ${domain}`, cookies);
          return cookies;
        } catch (error) {
          console.error(`è·å–åˆ†åŒº ${partition} çš„ cookies å¤±è´¥:`, error);
          return [];
        }
      }

      // å…¼å®¹åŸç‰ˆæœ¬çš„è‡ªåŠ¨æŒ‰é¡ºåºè®¿é—®ç™¾åº¦ä¸‰ä¸ªé¡µé¢å¹¶æ”¶é›† cookie çš„è¾…åŠ©å‡½æ•°
      async function updateLoginStatus() {
        cookiesList = [];
        isCollectingLoginSequence = true;
        showLoading();
        const webview = document.getElementById("browserView");
        const steps = [
          { url: 'https://baijiahao.baidu.com/builder/rc/home', domain: 'https://baijiahao.baidu.com' },
          { url: 'https://passport.baidu.com/v6/ucente', domain: 'https://passport.baidu.com' },
          { url: 'https://agents.baidu.com/center', domain: 'https://agents.baidu.com' }
        ];
        
        function waitForWebviewLoadOnce() {
          return new Promise((resolve) => {
            const onFinish = () => {
              try { webview.removeEventListener('did-finish-load', onFinish); } catch (e) {}
              setTimeout(resolve, 2000);
            };
            webview.addEventListener('did-finish-load', onFinish);
          });
        }

        try {
          for (let i = 0; i < steps.length; i++) {
            const step = steps[i];
            try {
              webview.src = step.url;
              await waitForWebviewLoadOnce();
              window.electronAPI.getCookies(step.domain).then((result)=>{
                cookiesList.push(result);
                console.log('Collected cookies for', step.domain, result);
                if (step.url.includes('passport.baidu.com')) {
                  console.log('å†™å…¥åå‘ç™»å½•çš„æ™ºèƒ½ä½“cookie');
                  window.electronAPI.setCookies({
                    targetUrl: 'https://agents.baidu.com',
                    cookies: agentCookies,
                    domain: '.baidu.com'
                  }).then(() => {
                    console.log("æ™ºèƒ½ä½“ Cookie å·²è®¾ç½®");
                    setTimeout(() => {
                      webview.src = "https://agents.baidu.com/center";
                    }, 3000); 
                  });
                }
                if (step.domain.includes('agents.baidu.com')) {
                  window.electronAPI.checkUserCookies({ currentNavId, cookiesList, token, sendId }).then(()=>{
                    console.log("è·³å› https://baijiahao.baidu.com/builder/rc/home");
                    setTimeout(() => {
                      webview.src = "https://baijiahao.baidu.com/builder/rc/home";
                    }, 2000);
                    setTimeout(() => {
                      isCollectingLoginSequence = false;
                    }, 3000);
                    showSuccessMessage("æ›´æ–°æˆæƒæˆåŠŸ");
                  });
                }
              });
            } catch (err) {
              console.error('Error collecting cookies for', step.domain, err);
            }
          }
        } finally {
          hideLoading();
        }
      }

      async function checkLoginStatus(url) {
        // å¦‚æœè‡ªåŠ¨åŒ–æµç¨‹åœ¨è¿è¡Œï¼Œè·³è¿‡é¡µé¢ç›‘æ§çš„è‡ªåŠ¨åˆ‡æ¢/æ”¶é›†é€»è¾‘ï¼Œé¿å…é‡å¤/å†²çª
        if (isCollectingLoginSequence) {
          console.log('checkLoginStatus skipped (automation in progress)');
          return;
        }
        
        console.log("---éªŒè¯url", url);
        console.log("è·å–åˆ°çš„æ•°æ®æ˜¯ï¼š", navItems);
        const menuItem = navItems.find((item) => item.id === currentNavId);
        console.log("-----menuItem------", menuItem);

        const currentPosition = window.currentAccountPosition || 1;

        // è·å–å½“å‰ webview çš„åˆ†åŒº
        const currentWebview = document.getElementById("browserView");
        const currentPartition = currentWebview ? currentWebview.partition : "persist:zhongshang";
        console.log("å½“å‰ webview åˆ†åŒº:", currentPartition);

        // ç™¾å®¶å·ç™»å½•æ£€æŸ¥ - å…¼å®¹ä¸¤ç§ç‰ˆæœ¬çš„é€»è¾‘
        if (url.includes("baijiahao.baidu.com/builder/rc/home") && menuItem && !menuItem.flag) {
          try {
            console.log("ä»å½“å‰webviewåˆ†åŒºè·å–cookie for domain:", "https://baijiahao.baidu.com", "åˆ†åŒº:", currentPartition);
            const result = await getCurrentWebviewCookies("https://baijiahao.baidu.com", currentPartition);
            cookiesList = result;
            
            if (!cookiesList || cookiesList.length === 0) {
              console.log("æœªè·å–åˆ°æœ‰æ•ˆçš„ç™¾å®¶å·cookieï¼Œç™»å½•éªŒè¯å¤±è´¥");
              showSuccessMessage("ç™»å½•éªŒè¯å¤±è´¥: æœªè·å–åˆ°æœ‰æ•ˆçš„ç™»å½•çŠ¶æ€");
              return;
            }

            let formattedCookies;
            if (Array.isArray(cookiesList)) {
              formattedCookies = [cookiesList]; // åŒ…è£…æˆåµŒå¥—æ•°ç»„æ ¼å¼
            } else {
              formattedCookies = [[cookiesList]]; // åŒé‡åŒ…è£…
            }
            console.log("æ ¼å¼åŒ–åçš„cookies:", formattedCookies);
            
            const checkResult = await window.electronAPI.checkUserCookies({
              currentNavId,
              cookiesList: formattedCookies,
              token,
              sendId,
              position: currentPosition,
              is_main: currentPosition === 1 ? 1 : 0
            });

            if (checkResult.success) {
              menuItem.flag = true;
              showSuccessMessage("ç™»å½•æˆåŠŸ");
              const hubFrame = document.getElementById("hubFrame");
              if (hubFrame && hubFrame.contentWindow) {
                hubFrame.contentWindow.postMessage({ type: "accountAuthorized", menuId: currentNavId, userId: sendId }, "*");
              }
            } else {
              showSuccessMessage("ç™»å½•éªŒè¯å¤±è´¥: " + (checkResult.message || "æœªçŸ¥é”™è¯¯"));
            }
          } catch (error) {
            console.error("æ£€æŸ¥ç™¾å®¶å·ç™»å½•çŠ¶æ€å¤±è´¥:", error);
            showSuccessMessage("ç™»å½•éªŒè¯å‡ºé”™: " + error.message);
          }
        }
        
        // å…¼å®¹åŸç‰ˆæœ¬çš„passporté¡µé¢é€»è¾‘
        if (url.includes("passport.baidu.com/v6/ucente") && menuItem && !menuItem.flag) {
          res = window.electronAPI.getCookies("https://passport.baidu.com");
          res.then((result) => {
            cookiesList.push(result);
            const webview = document.getElementById("browserView");
            setTimeout(() => {
              webview.src = "https://agents.baidu.com/";
            }, 2000);
          });
        }
        
        // å…¼å®¹åŸç‰ˆæœ¬çš„æ™ºèƒ½ä½“ä¸­å¿ƒé€»è¾‘
        if (url.includes("agents.baidu.com/center") && menuItem && !menuItem.flag) {
          res = window.electronAPI.getCookies("https://agents.baidu.com");
          res.then((result) => {
            cookiesList.push(result);

            console.log("hubè§¦å‘è°ƒç”¨mainè¿›ç¨‹");
            // ä» iframe è·å–ä¼ é€’è¿‡æ¥çš„ acc_id
            const iframe = document.getElementById("hubFrame");
            let acc_id = null;
            let position = 1;
            let isMain = 0;
            try {
              const hubContent = iframe.contentWindow;
              if (hubContent && hubContent.currentAccountId) acc_id = hubContent.currentAccountId;
              if (hubContent && hubContent.currentAccount) {
                position = hubContent.currentAccount.position || 1;
                isMain = hubContent.currentAccount.isMain || 0;
              }
            } catch (e) {
              console.log("æ— æ³•ä»hubè·å–è´¦æˆ·ä¿¡æ¯");
            }

            window.electronAPI.checkUserCookies({
              currentNavId,
              cookiesList: cookiesList,
              token,
              sendId,
              acc_id: acc_id,
              position: currentPosition,
              is_main: isMain,
            });
            menuItem.flag = true;
            setTimeout(() => {
              console.log("è·³è½¬å›ç™¾å®¶å·é¦–é¡µ");
              const webview = document.getElementById("browserView");
              webview.src = "https://baijiahao.baidu.com/builder/rc/home";
            }, 2000);
            showSuccessMessage("ç™»å½•æˆåŠŸ");

            if (currentViewMode === "webview" && currentNavId === 1) {
              // ç™¾å®¶å·æˆæƒæˆåŠŸï¼Œé€šçŸ¥ hub é¡µé¢åˆ·æ–°
              const hubFrame = document.getElementById("hubFrame");
              if (hubFrame && hubFrame.contentWindow) {
                hubFrame.contentWindow.postMessage({
                  type: "accountAuthorized",
                  menuId: currentNavId,
                  userId: sendId
                }, "*");
              }
            }
          });
        }
        
        // æœç‹å·ç™»å½•æ£€æŸ¥
        if (
          url.includes(
            "https://mp.sohu.com/mpfe/v4/contentManagement/first/page"
          ) &&
          menuItem &&
          !menuItem.flag
        ) {
          res = window.electronAPI.getCookies("https://mp.sohu.com");
          res.then((result) => {
            cookiesList = [];
            cookiesList.push(...result);
            const result2 = window.electronAPI.checkUserCookies({
              currentNavId,
              cookiesList,
              token,
              sendId,
              position: currentPosition
            });
            menuItem.flag = true;
          });
          showSuccessMessage("ç™»å½•æˆåŠŸ");
        }
        
        // å¤´æ¡å·ç™»å½•æ£€æŸ¥
        if (
          (url.includes("https://mp.toutiao.com/profile_v4/index") ||
            "profile_v4/index".includes(url)) &&
          menuItem &&
          !menuItem.flag
        ) {
          res = window.electronAPI.getCookies("https://mp.toutiao.com");
          res.then((result) => {
            cookiesList = [];
            cookiesList.push(...result);
            const result2 = window.electronAPI.checkUserCookies({
              currentNavId,
              cookiesList,
              token,
              sendId,
              position: currentPosition
            });
            menuItem.flag = true;
          });
          showSuccessMessage("ç™»å½•æˆåŠŸ");
        }
        
        // æ–°æµªçœ‹ç‚¹ç™»å½•æ£€æŸ¥
        if (url.includes("https://mp.sina.com.cn/#") && menuItem && !menuItem.flag) {
          res = window.electronAPI.getCookies("https://mp.sina.com.cn");
          res.then((result) => {
            cookiesList = [];
            cookiesList.push(...result);
            const result2 = window.electronAPI.checkUserCookies({
              currentNavId,
              cookiesList,
              token,
              sendId,
              position: currentPosition
            });
            menuItem.flag = true;
          });
          showSuccessMessage("ç™»å½•æˆåŠŸ");
        }
        
        // ä¼é¹…å·ç™»å½•æ£€æŸ¥
        if (url.includes("https://om.qq.com/main") && menuItem && !menuItem.flag) {
          res = window.electronAPI.getCookies("https://om.qq.com");
          res.then((result) => {
            cookiesList = [];
            cookiesList.push(...result);
            const result2 = window.electronAPI.checkUserCookies({
              currentNavId,
              cookiesList,
              token,
              sendId,
              position: currentPosition
            });
            menuItem.flag = true;
          });
          showSuccessMessage("ç™»å½•æˆåŠŸ");
        }
        
        // å¾®ä¿¡å…¬ä¼—å·ç™»å½•æ£€æŸ¥
        if (
          url.includes(
            "http://zs.open.chuangmaedu.com/openPlatform/callback"
          ) &&
          menuItem &&
          !menuItem.flag
        ) {
          const data = {
            type: currentNavId,
            json_str: sendId,
            time: Math.floor(Date.now() / 1000).toString(),
            send_id: sendId,
          };
          const headers = {
            "Content-Type": "application/json",
          };
          fetch("http://zs.open.chuangmaedu.com/openPlatform/checkAuth", {
            method: "POST",
            body: JSON.stringify(data),
            headers: headers,
          })
            .then((res) => res.json())
            .then((resultData) => {
              res = window.electronAPI.getCookies(
                "http://zs.open.chuangmaedu.com"
              );
              res.then((result) => {
                cookiesList = [];
                cookiesList.push(...result);
                const result2 = window.electronAPI.checkUserCookies({
                  currentNavId,
                  cookiesList,
                  token,
                  sendId,
                  position: currentPosition
                });
                menuItem.flag = true;
              });
              showSuccessMessage("ç™»å½•æˆåŠŸ");
            });
        }
        
        // ä»€ä¹ˆå€¼å¾—ä¹°ç™»å½•æ£€æŸ¥
        if (url.includes("https://post.smzdm.com/tougao/") && menuItem && !menuItem.flag) {
          res = window.electronAPI.getCookies("https://post.smzdm.com");
          console.log(window.electronAPI.getCookies("https://zhiyou.smzdm.com"));
          cookiesList = [];
          res.then((result) => {
            cookiesList.push(...result);
            console.log("å½“å‰é¡µé¢çš„æ‰€æœ‰cookie:", cookiesList);
            const result2 = window.electronAPI.checkUserCookies({
              currentNavId,
              cookiesList,
              token,
              sendId,
              position: currentPosition
            });
            menuItem.flag = true;
          });
          showSuccessMessage("ç™»å½•æˆåŠŸ");
        }
        
        // ç½‘æ˜“å·ç™»å½•æ£€æŸ¥
        if (url.includes("http://mp.163.com/subscribe_v4/index.html#/") && menuItem && !menuItem.flag) {
          res = window.electronAPI.getCookies("http://mp.163.com");
          res.then((result) => {
            cookiesList = [];
            cookiesList.push(...result);
            console.log("å½“å‰é¡µé¢çš„æ‰€æœ‰cookie:", cookiesList);
            const result2 = window.electronAPI.checkUserCookies({
              currentNavId,
              cookiesList,
              token,
              sendId,
              position: currentPosition
            });
            menuItem.flag = true;
          });
          showSuccessMessage("ç™»å½•æˆåŠŸ");
        }
      }

      function updateAuthorization() {
        console.log("å¼€å§‹æ›´æ–°æˆæƒ...");
        showLoading();
        const webview = document.getElementById("browserView");
        const currentUrl = webview.getURL();
        
        // è·å–å½“å‰ä½ç½®ä¿¡æ¯
        const currentPosition = window.currentAccountPosition || 1;
        let domain = "";
        
        // å…¼å®¹åŸç‰ˆæœ¬çš„ç™¾å®¶å·ç‰¹æ®Šå¤„ç†
        if (currentUrl.includes("baijiahao.baidu.com")) {
          domain = "https://baijiahao.baidu.com";
          try {
            updateLoginStatus();
          } catch (e) {
            console.error("è°ƒç”¨ updateLoginStatus å¤±è´¥:", e);
            // å¦‚æœè‡ªåŠ¨åŒ–æµç¨‹å¤±è´¥ï¼Œä½¿ç”¨é€šç”¨æ–¹æ³•
            performGenericAuthUpdate(domain, currentPosition);
          }
          return;
        }
        
        // å…¶ä»–å¹³å°çš„é€šç”¨å¤„ç†
        if (currentUrl.includes("mp.sohu.com")) {
          domain = "https://mp.sohu.com";
        } else if (currentUrl.includes("mp.toutiao.com")) {
          domain = "https://mp.toutiao.com";
        } else if (currentUrl.includes("mp.sina.com.cn")) {
          domain = "https://mp.sina.com.cn";
        } else if (currentUrl.includes("om.qq.com")) {
          domain = "https://om.qq.com";
        } else if (currentUrl.includes("post.smzdm.com")) {
          domain = "https://post.smzdm.com";
        } else if (currentUrl.includes("mp.163.com")) {
          domain = "https://mp.163.com";
        } else {
          hideLoading();
          showSuccessMessage("å½“å‰é¡µé¢ä¸æ”¯æŒæ›´æ–°æˆæƒ");
          return;
        }
        
        performGenericAuthUpdate(domain, currentPosition);
      }
      
      // é€šç”¨æˆæƒæ›´æ–°å‡½æ•°
      function performGenericAuthUpdate(domain, currentPosition) {
        window.electronAPI
          .getCookies(domain)
          .then((result) => {
            console.log("è·å–åˆ°çš„cookies:", result);
            const result2 = window.electronAPI.checkUserCookies({
              currentNavId,
              cookiesList: result,
              token,
              sendId,
              position: currentPosition
            });
            hideLoading();
            showSuccessMessage("æˆæƒæ›´æ–°æˆåŠŸ");
          })
          .catch((error) => {
            console.error("æ›´æ–°æˆæƒå¤±è´¥:", error);
            hideLoading();
            showSuccessMessage("æˆæƒæ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•");
          });
      }

      // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯çš„å‡½æ•°
      function showSuccessMessage(message) {
        console.log("=====å¼¹æ¡†==", message);
        try {
          // ä½¿ç”¨alertä½œä¸ºç®€å•å®ç°ï¼Œå®é™…é¡¹ç›®ä¸­å¯ä»¥æ›¿æ¢ä¸ºæ›´ä¼˜é›…çš„é€šçŸ¥ç»„ä»¶
          alert(message);
        } catch (error) {
          console.error("æ˜¾ç¤ºæ¶ˆæ¯å¤±è´¥:", error);
        }
      }
    </script>
  </body>
</html>