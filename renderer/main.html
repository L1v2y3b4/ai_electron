<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æˆæƒå·¥å…·</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Microsoft YaHei", "PingFang SC", "Helvetica Neue", Arial,
          sans-serif;
      }

      body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
        color: #333;
      }

      #app {
        display: flex;
        flex: 1;
        overflow: hidden;
        position: relative;
        height: 100vh;
      }

      /* å·¦ä¾§å¯¼èˆªæ ·å¼ */
      .sidebar {
        width: 300px;
        background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
        z-index: 10;
        position: relative;
      }

      .sidebar::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3Cpattern id='grain' width='100' height='100' patternUnits='userSpaceOnUse'%3E%3Ccircle cx='50' cy='50' r='1' fill='rgba(255,255,255,0.05)'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='100' height='100' fill='url(%23grain)'/%3E%3C/svg%3E");
        pointer-events: none;
      }

      .drag-area {
        width: 100%;
        height: 30px;
        cursor: grab;
        -webkit-app-region: drag;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 100;
      }

      .nav-header {
        padding: 40px 20px 20px 20px;
        text-align: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 20px;
      }

      .nav-header h2 {
        color: white;
        font-size: 22px;
        font-weight: 600;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
      }

      .nav-header h2::before {
        margin-right: 12px;
        font-size: 24px;
      }

      .nav-items {
        padding: 25px 20px;
        flex: 1;
        overflow-y: auto;
        position: relative;
        z-index: 1;
      }

      .nav-items::-webkit-scrollbar {
        width: 6px;
      }

      .nav-items::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
      }

      .nav-items::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
      }

      .nav-items::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
      }

      .nav-item {
        display: flex;
        align-items: center;
        padding: 18px 24px;
        margin: 8px 0;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: rgba(255, 255, 255, 0.8);
        font-size: 15px;
        font-weight: 500;
        position: relative;
        overflow: hidden;
      }

      .nav-item::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        transition: left 0.5s;
      }

      .nav-item:hover::before {
        left: 100%;
      }

      .nav-item:hover {
        background: rgba(255, 255, 255, 0.15);
        color: white;
        transform: translateX(5px);
      }

      .nav-item.active {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transform: translateX(5px);
      }

      .nav-item.active::after {
        content: "";
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 60%;
        background: white;
        border-radius: 2px 0 0 2px;
      }

      .nav-item span:first-child {
        margin-right: 15px;
        font-size: 20px;
        width: 24px;
        text-align: center;
      }

      .nav-item span.menu-text {
        flex: 1;
        text-align: left;
      }

      .arrow-container {
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.3s ease;
      }

      .submenu-arrow {
        font-size: 12px;
        transition: transform 0.3s ease;
      }

      .arrow-container.open .submenu-arrow {
        transform: rotate(90deg);
      }

      /* å³ä¾§å†…å®¹å®¹å™¨ï¼Œç”¨äºåˆ‡æ¢hubå’Œwebview */
      .content-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: white;
        border-radius: 20px 0 0 0;
        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.05);
        position: relative;
        height: 100vh;
      }

      .content-area::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(102, 126, 234, 0.2),
          transparent
        );
      }

      .browser-controls {
        padding: 20px 25px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-top: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
      }

      .browser-controls::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(102, 126, 234, 0.1),
          transparent
        );
      }

      .control-group {
        display: flex;
        gap: 16px;
        align-items: center;
        flex-wrap: wrap;
      }

      .refresh-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 13px;
        font-weight: 500;
        padding: 12px 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        min-width: 100px;
      }

      .refresh-btn::before {
        content: "ğŸ”„";
        font-size: 14px;
      }

      .refresh-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .refresh-btn:active {
        transform: translateY(0);
      }

      .update-auth-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 13px;
        font-weight: 500;
        padding: 12px 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
        min-width: 100px;
      }

      .update-auth-btn::before {
        content: "ğŸ”„";
        font-size: 14px;
      }

      .update-auth-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
      }

      .update-auth-btn:active {
        transform: translateY(0);
      }

      .logout-btn {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 20px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 2px 8px rgba(231, 76, 60, 0.2);
        min-width: 100px;
      }

      .logout-btn::before {
        content: "ğŸšª";
        font-size: 14px;
      }

      .logout-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
      }

      .logout-btn:active {
        transform: translateY(0);
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #666;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #28a745;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }

        50% {
          opacity: 0.5;
        }

        100% {
          opacity: 1;
        }
      }

      .message-box {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        padding: 40px;
        text-align: center;
        min-width: 350px;
        z-index: 1000;
        border: 1px solid rgba(102, 126, 234, 0.1);
        backdrop-filter: blur(10px);
      }

      .message-box h3 {
        color: #667eea;
        margin-bottom: 15px;
        font-size: 20px;
        font-weight: 600;
      }

      .message-box p {
        color: #666;
        margin-bottom: 25px;
        font-size: 15px;
        line-height: 1.5;
      }

      .message-box button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .message-box button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .loading-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .sidebar {
          width: 250px;
        }

        .nav-header h2 {
          font-size: 18px;
        }

        .nav-item {
          padding: 15px 20px;
          font-size: 14px;
        }

        .browser-controls {
          padding: 15px 20px;
          flex-direction: column;
          gap: 15px;
        }

        .control-group {
          justify-content: center;
          gap: 12px;
        }

        .refresh-btn,
        .update-auth-btn,
        .logout-btn {
          padding: 10px 16px;
          font-size: 12px;
          min-width: 90px;
        }
      }

      .nav-item {
        animation: slideInLeft 0.5s ease-out;
      }

      @keyframes slideInLeft {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }

        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .content-area {
        animation: slideInRight 0.5s ease-out;
      }

      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(20px);
        }

        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .version-info {
        margin: 20px 20px 15px 20px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 8px;
        font-weight: 500;
        letter-spacing: 0.5px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(5px);
        text-align: center;
        position: relative;
        z-index: 1;
      }

      /* ä¿®å¤åçš„ view-container æ ·å¼ */
      .view-container {
        flex: 1;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        /* height: calc(100vh - 80px); å‡å»åº•éƒ¨æ§åˆ¶æ é«˜åº¦ */
      }

      #hubFrame {
        width: 100%;
        height: 100%;
        border: none;
        display: none;
      }

      #hubFrame.active {
        display: block;
      }

      webview {
        width: 100%;
        height: 100%;
        display: none;
      }
      #hubFrame,
      webview {
        width: 100%;
        height: 100%;
        border: none;
        position: absolute;
        top: 0;
        left: 0;
        z-index: -1;
      }
      #hubFrame.active,
      webview.active {
        height: 100%;
        display: block;
        z-index: 1;
      }

      iframe {
        width: 100%;
        height: 100% !important;
        border: none;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <div class="sidebar">
        <div class="drag-area" id="dragArea"></div>
        <div class="nav-header">
          <h2 id="userNameHeader">å¹³å°å¯¼èˆª</h2>
        </div>
        <div class="nav-items" id="navItems"></div>
        <div class="version-info" id="versionInfo">v1.0.0</div>
        <div class="browser-controls">
          <div class="control-group">
            <button class="refresh-btn" id="refreshBtn">åˆ·æ–°é¡µé¢</button>
            <button class="update-auth-btn" id="updateAuthBtn">æ›´æ–°æˆæƒ</button>
          </div>
          <div class="control-group">
            <button class="logout-btn" id="logoutBtn">é€€å‡ºç™»å½•</button>
          </div>
        </div>
      </div>
      <div class="content-area">
        <div class="view-container">
          <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
          </div>
          <!-- ä½¿ç”¨iframeåŠ è½½hubé¡µé¢ï¼Œåˆå§‹æ˜¾ç¤ºä¸»é¡µ webview -->
          <iframe
		  	style="display:inline-flex; width:100%; height:100%"
            id="hubFrame"
            src="./hub.html"
            allow="camera;microphone"
          ></iframe>
          <!-- å³ä¾§ webview å®¹å™¨ -->
          <webview
            id="browserView"
			style="display:inline-flex; width:100%; height:100%"
            partition="persist:zhongshang"
            disablewebsecurity
            webpreferences="javascript=yes, contextIsolation=yes"
            allowpopups
            useragent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36"
          >
          </webview>
        </div>
      </div>
    </div>

    <script src="./main.js"></script>
    <script>
      const userAgents = [
        "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36",
        "Mozilla/5.0 (Macintosh; Intel Mac OS X 13_4) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.4 Safari/605.1.15",
        "Mozilla/5.0 (iPhone; CPU iPhone OS 16_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.4 Mobile/15E148 Safari/604.1",
        "Mozilla/5.0 (Linux; Android 13; SM-S901U) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Mobile Safari/537.36",
      ];

      function getRandomUserAgent() {
        return userAgents[Math.floor(Math.random() * userAgents.length)];
      }

      const navItems = [
        {
          id: 0,
          name: "ä¸»é¡µ",
          url: "./welcome.html",
          icon: "ğŸ ",
          flag: false,
          show: true,
        },
        {
          id: 1,
          name: "ç™¾å®¶å·",
          url: "https://baijiahao.baidu.com/",
          icon: "ğŸ“",
          flag: false,
          show: true,
        },
        {
          id: 2,
          name: "æœç‹",
          url: "https://mp.sohu.com/mpfe/v4/login",
          icon: "ğŸ¦Š",
          flag: false,
          show: true,
        },
        {
          id: 6,
          name: "è…¾è®¯åˆ›ä½œ",
          url: "https://om.qq.com/main",
          icon: "ğŸ§",
          flag: false,
          show: true,
        },
        {
          id: 4,
          name: "å¾®ä¿¡å…¬ä¼—å·",
          url: "http://zs.open.chuangmaedu.com/openPlatform/preAuthCodeHtml/open?id=",
          icon: "ğŸ’¬",
          flag: false,
          show: true,
        },
        {
          id: 3,
          name: "ä»Šæ—¥å¤´æ¡",
          url: "https://mp.toutiao.com/auth/page/login",
          icon: "ğŸ“°",
          flag: false,
          show: false,
        },
        {
          id: 5,
          name: "æ–°æµª",
          url: "https://mp.sina.com.cn/",
          icon: "ğŸ•Šï¸",
          flag: false,
          show: false,
        },
        {
          id: 8,
          name: "ç½‘æ˜“",
          url: "https://mp.163.com/login.html#/",
          icon: "ğŸŒ",
          flag: false,
          show: false,
        },
      ];

      let token = "";
      let sendId = "";
      let currentNavId = 0;
      let sendFlag = false;
      let userName = "";
      let cookiesList = [];
      let currentViewMode = "home"; // åˆå§‹åŒ–ä¸ºä¸»é¡µæ¨¡å¼

      window.electronAPI.setUserData((event, data) => {
        token = data.token;
        sendId = data.sendId;
        userName = data.userName;
        console.log("=======userName", userName);
        const userNameHeader = document.getElementById("userNameHeader");
        if (userNameHeader && userName) {
          userNameHeader.textContent = userName;
        }
        window.electronAPI
          .getMenuIsAuth({
            id: sendId,
            _type: "zmt_wy",
          })
          .then((result) => {
            console.log("render_æƒé™è°ƒç”¨ç»“æœ:", result);
            navItems.forEach((item) => {
              if (result.hasOwnProperty(item.id) && result[item.id]) {
                item.show = result[item.id];
              }
            });
            initApp();
          })
          .catch((error) => {
            console.error("æƒé™è°ƒç”¨å¤±è´¥:", error);
            initApp();
          });
      });

      function initDragAndDrop() {
        const dragArea = document.getElementById("dragArea");
        let isDragging = false;
        let startX, startY;

        dragArea.addEventListener("mousedown", (e) => {
          isDragging = true;
          startX = e.clientX;
          startY = e.clientY;
          dragArea.style.cursor = "grabbing";
        });

        document.addEventListener("mousemove", (e) => {
          if (!isDragging) return;
          const deltaX = e.clientX - startX;
          const deltaY = e.clientY - startY;
          window.electronAPI.moveWindow({ deltaX, deltaY });
        });

        document.addEventListener("mouseup", () => {
          isDragging = false;
          dragArea.style.cursor = "grab";
        });
      }

      function initApp() {
        initDragAndDrop();
        cookiesList = [];
        const navItemsCo = document.getElementById("navItems");
        const versionInfo = document.getElementById("versionInfo");
        const params = new URLSearchParams(window.location.search);
        const version = params.get("version");
        if (version) {
          versionInfo.textContent = `Â© 2025 æˆæƒå·¥å…· v${version}`;
        }

        navItems.forEach((item, index) => {
          if (item.id != 5 && item.id != 3 && item.show) {
            const navItem = document.createElement("div");
            navItem.className = "nav-item";
            if (item.id === currentNavId) navItem.classList.add("active");
            navItem.dataset.id = item.id;
            navItem.style.animationDelay = `${index * 0.1}s`;

            if (item.id === 1) {
              navItem.innerHTML = `
                            <span>${item.icon}</span>
                            <span class="menu-text">${item.name}</span>
                            <div class="arrow-container" id="arrowContainer">
                                <span class="submenu-arrow">â–¶</span>
                            </div>
                        `;
            } else {
              navItem.innerHTML = `
                            <span>${item.icon}</span>
                            <span class="menu-text">${item.name}</span>
                        `;
            }

            navItem.addEventListener("click", (e) => {
              if (
                e.target.classList.contains("submenu-arrow") ||
                e.target.parentElement.classList.contains("arrow-container")
              ) {
                e.stopPropagation();
                const subMenu = document.getElementById("wenxinSubMenu");
                const arrowContainer =
                  document.getElementById("arrowContainer");

                if (
                  subMenu.style.display === "none" ||
                  !subMenu.style.display
                ) {
                  subMenu.style.display = "flex";
                  arrowContainer.classList.add("open");
                } else {
                  subMenu.style.display = "none";
                  arrowContainer.classList.remove("open");
                }
                return;
              }

              document
                .querySelector(".nav-item.active")
                .classList.remove("active");
              navItem.classList.add("active");
              currentNavId = item.id;

              const hubFrame = document.getElementById("hubFrame");
              const webview = document.getElementById("browserView");

              if (item.id === 0) {
                // ä¸»é¡µï¼šæ˜¾ç¤ºåŸæ¥çš„ webview
                currentViewMode = "home";
                webview.classList.add("active");
                hubFrame.classList.remove("active");
                console.log(
                  "[v0] Switched to HOME - webview.active:",
                  webview.classList.contains("active"),
                  "hubFrame.active:",
                  hubFrame.classList.contains("active")
                );
                webview.src = item.url;
              } else {
                // å…¶ä»–èœå•ï¼šæ˜¾ç¤ºhubä¸­è½¬é¡µé¢
                currentViewMode = "hub";
                hubFrame.classList.add("active");
                webview.classList.remove("active");
                console.log(
                  "[v0] Switched to HUB - webview.active:",
                  webview.classList.contains("active"),
                  "hubFrame.active:",
                  hubFrame.classList.contains("active")
                );

                setTimeout(() => {
                  console.log(
                    "[v0] Sending selectMenu to hub, menuId:",
                    item.id,
                    "navItems:",
                    navItems
                  );
                  const hubContent = hubFrame.contentWindow;
                  if (hubContent) {
                    hubContent.postMessage(
                      {
                        type: "selectMenu",
                        menuId: item.id,
                        navItems: navItems,
                        userData: {sendId: sendId}
                      },
                      "*"
                    );
                  }
                }, 300);
              }

              cookiesList = [];
            });

            navItemsCo.appendChild(navItem);

            if (item.id === 1) {
              const subMenu = document.createElement("div");
              subMenu.className = "nav-item";
              subMenu.id = "wenxinSubMenu";
              subMenu.style.paddingLeft = "48px";
              subMenu.style.fontSize = "14px";
              subMenu.style.opacity = "0.85";
              subMenu.style.display = "none";
              subMenu.innerHTML = `<span>ğŸ¤–</span><span class="menu-text">æ–‡å¿ƒæ™ºèƒ½ä½“</span>`;
             // ä¿®æ”¹ renderer/main.html ä¸­å…³äºæ–‡å¿ƒæ™ºèƒ½ä½“çš„ç‚¹å‡»äº‹ä»¶
              subMenu.addEventListener("click", async () => {
                document.querySelector(".nav-item.active").classList.remove("active");
                subMenu.classList.add("active");
                
                // åˆ‡æ¢åˆ°è´¦å·ç®¡ç†è§†å›¾
                currentViewMode = "hub";
                currentNavId = 9; // ä¸ºæ–‡å¿ƒæ™ºèƒ½ä½“åˆ†é…ä¸€ä¸ªæ–°çš„ID
                const hubFrame = document.getElementById("hubFrame");
                const webview = document.getElementById("browserView");
                
                hubFrame.classList.add("active");
                webview.classList.remove("active");
                
                // é€šçŸ¥hubé¡µé¢åˆ‡æ¢åˆ°æ–‡å¿ƒæ™ºèƒ½ä½“è´¦å·ç®¡ç†
                hubFrame.contentWindow.postMessage({
                  type: "selectMenu",
                  menuId: 9,
                  navItems: [...navItems, {
                    id: 9,
                    name: "æ–‡å¿ƒæ™ºèƒ½ä½“",
                    url: "https://agents.baidu.com/center",
                    icon: "ğŸ¤–",
                    flag: false,
                    show: true
                  }],
                  userData: {sendId: sendId}
                }, "*");
                // hubFrame.contentWindow.postMessage({
                //   type: "selectMenu",
                //   menuId: item.id,
                //   navItems: navItems,
                //   userData: {sendId: sendId}  // ç¡®ä¿è¿™é‡Œçš„ sendId æ˜¯æ­£ç¡®çš„å½“å‰ç”¨æˆ·ID
                // }, "*");
              });
              navItemsCo.appendChild(subMenu);
            }
          }
        });

        // åˆå§‹æ˜¾ç¤ºä¸»é¡µ
        const homeNavItem = navItems.find((item) => item.id === 0);
        if (homeNavItem) {
          currentNavId = 0;
          currentViewMode = "home";
          const webview = document.getElementById("browserView");
          const hubFrame = document.getElementById("hubFrame");
          webview.classList.add("active");
          hubFrame.classList.remove("active");
          webview.src = homeNavItem.url;

          // æ ‡è®°ä¸»é¡µèœå•ä¸ºæ´»è·ƒçŠ¶æ€
          const homeMenuItem = navItemsCo.querySelector('[data-id="0"]');
          if (homeMenuItem) {
            homeMenuItem.classList.add("active");
          }
        }
      }

      document.getElementById("refreshBtn").addEventListener("click", () => {
        const webview = document.getElementById("browserView");
        showLoading();
        if (currentViewMode === "hub") {
          hideLoading();
          return;
        }
        if (currentNavId === 8 || currentNavId === 4) {
          const a = navItems.find((item) => item.id === currentNavId);
          webview.src = a.url + sendId;
        } else {
          webview.reload();
        }
      });

      document.getElementById("updateAuthBtn").addEventListener("click", () => {
        if (currentViewMode === "hub") {
          showSuccessMessage("è¯·å…ˆé€‰æ‹©è´¦å·è¿›å…¥ç¼–è¾‘");
          return;
        }
        updateAuthorization();
      });

      document.getElementById("logoutBtn").addEventListener("click", () => {
        window.electronAPI.logout();
      });

      const webview = document.getElementById("browserView");

      webview.addEventListener("did-start-loading", () => {
        showLoading();
      });

      webview.addEventListener("did-stop-loading", () => {
        hideLoading();
      });

      webview.addEventListener("did-finish-load", async () => {
        webview.executeJavaScript(`
				// æŸ¥æ‰¾ç›®æ ‡iframeï¼ˆæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹é€‰æ‹©å™¨ï¼‰
				const targetIframe = document.querySelector('iframe'); // æ›¿æ¢ä¸ºå®é™…çš„iframeé€‰æ‹©å™¨
				
				if (targetIframe) {
				// ç­‰å¾…iframeåŠ è½½å®Œæˆ
				targetIframe.addEventListener('load', () => {
					try {
					// è·å–iframeçš„æ–‡æ¡£å¯¹è±¡
					const iframeDoc = targetIframe.contentDocument || targetIframe.contentWindow.document;
					
					// æŸ¥æ‰¾shadow rootï¼ˆæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹é€‰æ‹©å™¨ï¼‰
					const shadowHost = iframeDoc.querySelector('#shadowHost'); // æ›¿æ¢ä¸ºå®é™…çš„shadowå®¿ä¸»é€‰æ‹©å™¨
					if (shadowHost && shadowHost.shadowRoot) {
						const shadowRoot = shadowHost.shadowRoot;
						
						// åˆ›å»ºæ ·å¼å…ƒç´ å¹¶æ·»åŠ æ ·å¼è§„åˆ™
						const style = document.createElement('style');
						style.textContent = \`
						/* åœ¨è¿™é‡Œæ·»åŠ ä½ çš„æ ·å¼è§„åˆ™ */
						.some-class { color: red; }
						#some-id { background: blue; }
						body { font-size: 14px; }
						\`;
						
						// å°†æ ·å¼æ·»åŠ åˆ°shadow root
						shadowRoot.appendChild(style);
						
						console.log('æ ·å¼å·²æˆåŠŸæ³¨å…¥åˆ°shadow DOM');
					} else {
						console.log('æœªæ‰¾åˆ°shadow root');
					}
					} catch (e) {
					console.error('ä¿®æ”¹æ ·å¼æ—¶å‡ºé”™:', e);
					}
				});
				} else {
				console.log('æœªæ‰¾åˆ°ç›®æ ‡iframe');
				}
			`);
        hideLoading();
        const currentUrl = webview.getURL();
        const url = new URL(currentUrl);
        console.log("renderer_å½“å‰ç½‘å€:", url);
        if (
          currentUrl.includes("https://mp.toutiao.com/profile_v4/index") ||
          "/profile_v4/index".includes(currentUrl)
        ) {
          checkLoginStatus(currentUrl);
        }
        if (
          currentUrl.includes(
            "http://zs.open.chuangmaedu.com/openPlatform/callback"
          )
        ) {
          checkLoginStatus(currentUrl);
        }
        if (
          currentUrl.includes("https://post.smzdm.com/tougao") &&
          !currentUrl.includes("login")
        ) {
          checkLoginStatus(currentUrl);
        }
        if (currentUrl.includes("https://om.qq.com/main")) {
          checkLoginStatus(currentUrl);
        }
      });

      webview.addEventListener("did-fail-load", (event) => {
      const { errorCode, errorDescription, validatedURL } = event;
      // å¿½ç•¥ä¸€äº›å¸¸è§çš„éå…³é”®é”™è¯¯ç ï¼Œé¿å…æ—¥å¿—åˆ·å±
      if (errorCode !== -3 && errorCode !== -27) {
        console.error(
          `WebviewåŠ è½½å¤±è´¥: ${errorCode} - ${errorDescription} - URL: ${validatedURL}`
        );
      }
      // éšè—åŠ è½½åŠ¨ç”»
      hideLoading();
      });

      webview.addEventListener("did-navigate-in-page", (event) => {
        console.log(event);
        const currentUrl = event.url || webview.getURL();
        console.log("é¡µé¢å†…URLå˜åŒ–:", currentUrl);
        checkLoginStatus(currentUrl);
      });

      window.addEventListener("message", async (event) => {
        if (event.data.type === "enterWebview") {
          // æ¥è‡ªhubé¡µé¢ï¼šç”¨æˆ·ç‚¹å‡»äº†è´¦å·å¡ç‰‡ï¼Œè¿›å…¥webview
          currentViewMode = "webview";
          const hubFrame = document.getElementById("hubFrame");
          const containerView = document.querySelector('.view-container');
          

          // è·å–é¢å¤–å‚æ•°
          const isMain = event.data.isMain || 0;
          const position = event.data.position || 1;
          const menuId = event.data.menuId;

          // å°†positionå’ŒisMainå‚æ•°ä¿å­˜åˆ°windowå¯¹è±¡ä¸­ï¼Œä»¥ä¾¿åœ¨checkLoginStatuså‡½æ•°ä¸­ä½¿ç”¨
          window.currentAccountPosition = position;
          window.currentAccountIsMain = isMain;
          console.log(`å½“å‰è´¦å·ä½ç½®: ${position}, isMain: ${isMain}`);
          // window.currentAccountId = accountId;
          // ä¿å­˜accountIdåˆ°webviewçš„dataå±æ€§ä¸­ï¼Œä»¥ä¾¿åç»­è·å–
          // newWebview.setAttribute('data-account-id', accountId);
          // ç§»é™¤æ—§çš„ webview
          const oldWebview = document.getElementById("browserView");
          if (oldWebview) {
            oldWebview.remove();
          }
          
          // é‡ç½®å¯¹åº”å¹³å°çš„flagä¸ºfalseï¼Œç¡®ä¿æ¯æ¬¡è¿›å…¥éƒ½èƒ½é‡æ–°è·å–cookie
          const platformIndex = navItems.findIndex(item => item.id === menuId);
          if (platformIndex !== -1) {
            navItems[platformIndex].flag = false;
            console.log(`é‡ç½®å¹³å° ${navItems[platformIndex].name} çš„flagä¸ºfalse`);
          }
          
          // ç¡®å®špartitionåç§°
          const partitionName = `persist:account_${event.data.accountId}`;
          console.log(`å‡†å¤‡ä½¿ç”¨partition: ${partitionName}`);
          
          // å¦‚æœæ˜¯æœªæˆæƒè´¦å·ï¼ˆpendingå¼€å¤´ï¼‰ï¼Œå…ˆæ¸…é™¤è¯¥partitionçš„ç¼“å­˜
          if (event.data.accountId && event.data.accountId.toString().startsWith('pending')) {
            console.log(`æ£€æµ‹åˆ°æœªæˆæƒè´¦å·ï¼Œæ¸…é™¤ ${partitionName} çš„ç¼“å­˜`);
            try {
              await window.electronAPI.clearCookies({ partition: partitionName });
              console.log(`å·²æ¸…é™¤ ${partitionName} çš„ç¼“å­˜`);
            } catch (clearError) {
              console.error(`æ¸…é™¤ ${partitionName} ç¼“å­˜å¤±è´¥:`, clearError);
            }
          }
          
          // åˆ›å»ºæ–°çš„ webview å¹¶è®¾ç½®ç‹¬ç«‹åˆ†åŒº
          const newWebview = document.createElement('webview');
          newWebview.id = "browserView";
          newWebview.style.cssText = "display:inline-flex; width:100%; height:100%";
          // ä¸ºä¸åŒè´¦å·åˆ›å»ºç‹¬ç«‹çš„åˆ†åŒº
          newWebview.partition = partitionName;
          newWebview.setAttribute('data-account-id', event.data.accountId);
          newWebview.setAttribute("disablewebsecurity", "");
          newWebview.setAttribute("webpreferences", "javascript=yes, contextIsolation=yes");
          newWebview.setAttribute("allowpopups", "");
          newWebview.setAttribute("useragent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36");
          
          // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
          newWebview.addEventListener("did-start-loading", () => {
            showLoading();
          });
          
          newWebview.addEventListener("did-stop-loading", () => {
            hideLoading();
          });
          
          newWebview.addEventListener("did-finish-load", async () => {
            hideLoading();
            const currentUrl = newWebview.getURL();
            if (
              currentUrl.includes("https://mp.toutiao.com/profile_v4/index") ||
              "/profile_v4/index".includes(currentUrl)
            ) {
              checkLoginStatus(currentUrl);
            }
            if (
              currentUrl.includes(
                "http://zs.open.chuangmaedu.com/openPlatform/callback"
              )
            ) {
              checkLoginStatus(currentUrl);
            }
            if (
              currentUrl.includes("https://post.smzdm.com/tougao") &&
              !currentUrl.includes("login")
            ) {
              checkLoginStatus(currentUrl);
            }
            if (currentUrl.includes("https://om.qq.com/main")) {
              checkLoginStatus(currentUrl);
            }
          });
          
          newWebview.addEventListener("did-navigate-in-page", (event) => {
            const currentUrl = event.url || newWebview.getURL();
            checkLoginStatus(currentUrl);
          });

          // æ·»åŠ åˆ°å®¹å™¨ä¸­
          containerView.appendChild(newWebview);

          hubFrame.classList.remove("active");
          newWebview.classList.add("active");

          // ä»navItemsä¸­è·å–å¯¹åº”çš„url
          const menuItem = navItems.find(
            (item) => item.id === event.data.menuId
          );
          
          if (menuItem) {
            // è·å–ç›®æ ‡URL
            let targetUrl;
            if (event.data.menuId === 4) {
              targetUrl = menuItem.url + sendId;
            } else if (event.data.menuId === 8) {
              targetUrl = menuItem.url + sendId;
            } else {
              targetUrl = menuItem.url;
            }
            
            // å®ç°æ›´å¥å£®çš„cookieæ³¨å…¥é€»è¾‘ï¼Œå¤„ç†å¤æ‚çš„è½¬ä¹‰å­—ç¬¦å’ŒJSONæ ¼å¼é—®é¢˜
            let cookiePromise;
            
            // 1. é¦–å…ˆå°è¯•ä½¿ç”¨event.data.cookiesï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (event.data.cookies) {
                cookiePromise = new Promise((resolve, reject) => {
                    try {
                        let cookiesList;
                        if (typeof event.data.cookies === 'string') {
                            console.log('å¤„ç†å­—ç¬¦ä¸²æ ¼å¼çš„cookiesæ•°æ®');
                            
                            // ç§»é™¤å¤–éƒ¨å¼•å·
                            let cookieStr = event.data.cookies.replace(/^"|"$/g, '');
                            
                            // å¤„ç†è½¬ä¹‰å­—ç¬¦ - æ›´å…¨é¢çš„è½¬ä¹‰å¤„ç†
                            cookieStr = cookieStr.replace(/\\\\"/g, '\\"'); // å¤„ç†åŒé‡è½¬ä¹‰
                            cookieStr = cookieStr.replace(/\\"/g, '"'); // å¤„ç†è½¬ä¹‰å¼•å·
                            
                            // å°è¯•æ‰¾åˆ°æœ‰æ•ˆçš„JSONç»“æŸä½ç½®ï¼ˆå¤„ç†å¯èƒ½çš„æˆªæ–­ï¼‰
                            try {
                                cookiesList = JSON.parse(cookieStr);
                            } catch (parseError) {
                                console.error('é¦–æ¬¡JSONè§£æå¤±è´¥ï¼Œå°è¯•ä¿®å¤æ ¼å¼:', parseError);
                                
                                // å°è¯•ç®€åŒ–å¤„ç†ï¼šåªæå–ç¬¬ä¸€ä¸ªæ•°ç»„å…ƒç´ æˆ–ä½¿ç”¨æ­£åˆ™æå–cookieæ•°æ®
                                // ä¾‹å¦‚ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªå®Œæ•´çš„æ•°ç»„å¯¹
                                const arrayMatch = cookieStr.match(/\[\[.*?\]\]/s);
                                if (arrayMatch) {
                                    console.log('å°è¯•ä½¿ç”¨æ­£åˆ™æå–çš„æ•°ç»„éƒ¨åˆ†è¿›è¡Œè§£æ');
                                    cookiesList = JSON.parse(arrayMatch[0]);
                                } else {
                                    throw new Error('æ— æ³•æå–æœ‰æ•ˆçš„JSONæ•°ç»„');
                                }
                            }
                        } else {
                            cookiesList = event.data.cookies;
                        }
                        
                        // ç¡®ä¿cookiesListæ˜¯æ•°ç»„
                        if (!Array.isArray(cookiesList)) {
                            cookiesList = [cookiesList];
                        }
                        
                        // æ‰å¹³åŒ–cookieæ•°ç»„
                        const flatCookies = cookiesList.flat();
                        console.log('æˆåŠŸè§£æå¹¶æ‰å¹³åŒ–cookieï¼Œæ•°é‡:', flatCookies.length);
                        
                        // åªä¿ç•™æœ‰æ•ˆçš„cookieå¯¹è±¡
                        const validCookies = flatCookies.filter(cookie => 
                            cookie && typeof cookie === 'object' && cookie.name && cookie.value
                        );
                        
                        if (validCookies.length > 0) {
                                const targetDomain = new URL(targetUrl).hostname;
                                
                                // æ ¹æ®ä¸åŒå¹³å°ä½¿ç”¨ä¸åŒçš„domainç­–ç•¥
                                let cookieDomain;
                                let cookieTargetUrl;
                                
                                // ç™¾åº¦ç³»å¹³å°ï¼ˆç™¾å®¶å·ç­‰ï¼‰
                                if (targetDomain.includes('baidu.com') || targetDomain.includes('baijiahao.baidu.com')) {
                                    cookieDomain = 'baidu.com'; // ç™¾åº¦ç³»ä½¿ç”¨baidu.comä½œä¸ºä¸»è¦domain
                                    cookieTargetUrl = `https://baijiahao.baidu.com`;
                                } else {
                                    // å…¶ä»–å¹³å°ä½¿ç”¨è‡ªèº«åŸŸå
                                    cookieDomain = targetDomain;
                                    cookieTargetUrl = targetUrl;
                                }
                                
                                return window.electronAPI.setCookies({
                                    targetUrl: cookieTargetUrl,
                                    cookies: validCookies,
                                    domain: cookieDomain,
                                    partition: `persist:account_${event.data.accountId}`
                                }).then(resolve).catch(reject);
                            } else {
                                console.warn('æœªæ‰¾åˆ°æœ‰æ•ˆçš„cookieå¯¹è±¡ï¼Œè·³è¿‡æ³¨å…¥');
                                resolve();
                            }
                    } catch (error) {
                        console.error('è§£æevent.data.cookieså¤±è´¥:', error);
                        resolve(); // è§£æå¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ
                    }
                });
            } 
            // 2. å¦‚æœevent.data.cookiesä¸å­˜åœ¨æˆ–è§£æå¤±è´¥ï¼Œå°è¯•è·å–å·²ä¿å­˜çš„è´¦å·cookie
            else {
                console.log('%cgetAccountStatus->>>>', 'color: red; font-weight: bold;', event.data)
                cookiePromise = window.electronAPI.getAccountStatus({
                    userId: event.data.sendId,
                    type: event.data.menuId
                }).then(result => {
                    console.log("%cgetAccountStatusçš„ç»“æœ:", 'color: green; font-weight: bold;')
                    console.log(result)
                    if (result.success && result.accounts && result.accounts.length > 0) {
                        // æŸ¥æ‰¾åŒ¹é…çš„è´¦å·
                        const matchedAccount = result.accounts.find(acc => {
                            // æ ¹æ®positionåŒ¹é…è´¦å·
                            return acc.position === event.data.position;
                        });
                        
                        if (matchedAccount) {
                            try {
                                const savedCookies = JSON.parse(matchedAccount.cookies);
                                if (savedCookies && savedCookies.length > 0) {
                                    console.log('ä»auth/accountsè·å–åˆ°cookieï¼Œæ•°é‡:', savedCookies.length);
                                    const domain = new URL(targetUrl).hostname;
                                    return window.electronAPI.setCookies({
                                        targetUrl: targetUrl,
                                        cookies: savedCookies,
                                        domain: domain,
                                        partition: `persist:account_${event.data.accountId}`
                                    });
                                }else{
                                    console.log("%cæœªæ‹¿åˆ°cookie,æ¸…ç©ºç¼“å­˜", 'color: red; font-weight: bold;')
                                    window.electronAPI.clearCookies({
                                        partition: `persist:account_${event.data.accountId}`
                                    });
                                    return
                                }
                            } catch (parseError) {
                                console.error('è§£æcookieå¤±è´¥:', parseError);
                            }
                        }
                    }
                    return Promise.resolve();
                }).catch(error => {
                    console.error('ä»auth/accountsè·å–è´¦å·ä¿¡æ¯å¤±è´¥:', error);
                    return Promise.resolve();
                });
            }
            
            // 3. æ‰§è¡Œcookieæ³¨å…¥å¹¶åŠ è½½URL
            cookiePromise.then(() => {
                console.log('cookieå¤„ç†å®Œæˆï¼Œå‡†å¤‡åŠ è½½URL');
                
                // é‡ç‚¹ï¼šç¡®ä¿cookieåœ¨webviewåŠ è½½URLä¹‹å‰å®Œæˆæ³¨å…¥
                // 1. é¦–å…ˆè·å–å…³é”®cookieï¼ŒéªŒè¯æ˜¯å¦æˆåŠŸæ³¨å…¥
                
                // æ ¹æ®ä¸åŒå¹³å°ä½¿ç”¨ä¸åŒçš„å…³é”®cookie
                let keyCookies;
                let cookieDomains = [];
                const targetDomain = new URL(targetUrl).hostname;
                
                // ç™¾åº¦ç³»å¹³å°ï¼ˆç™¾å®¶å·ç­‰ï¼‰
                if (targetDomain.includes('baidu.com') || targetDomain.includes('baijiahao.baidu.com')) {
                    keyCookies = ['BDUSS', 'BDUSS_BFESS', 'BAIDUID', 'BAIDUID_BFESS', 'bjhStoken'];
                    cookieDomains = ['https://baijiahao.baidu.com', 'https://baidu.com'];
                } 
                // æœç‹å¹³å°
                else if (targetDomain.includes('mp.sohu.com')) {
                    keyCookies = ['userid', 'token', 'sessionid'];
                    cookieDomains = ['https://mp.sohu.com'];
                }
                // ç½‘æ˜“å¹³å°
                else if (targetDomain.includes('mp.163.com')) {
                    keyCookies = ['userInfo', 'sessionToken', 'cookieToken'];
                    cookieDomains = ['https://mp.163.com'];
                }
                // å…¶ä»–å¹³å°å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ 
                else {
                    keyCookies = []; // é»˜è®¤ä¸æ£€æŸ¥å…³é”®cookie
                    cookieDomains = [targetUrl];
                }
                
                // è·å–å¯¹åº”åŸŸåä¸‹çš„æ‰€æœ‰cookie
                const cookiePromises = cookieDomains.map(domain => 
                    window.electronAPI.getCookies(domain, `persist:account_${event.data.accountId}`)
                );
                
                Promise.all(cookiePromises).then(results => {
                    // åˆå¹¶æ‰€æœ‰cookieå¹¶å»é‡
                    const allCookies = results.flat().filter((cookie, index, self) => 
                        index === self.findIndex((c) => c.name === cookie.name && c.domain === cookie.domain)
                    );
                    
                    console.log('æ³¨å…¥åè·å–åˆ°çš„å…¨éƒ¨cookie:', allCookies.length);
                    console.log('æ‰€æœ‰cookieè¯¦æƒ…:', allCookies);
                    
                    // å¦‚æœæœ‰å…³é”®cookieéœ€è¦æ£€æŸ¥
                    if (keyCookies.length > 0) {
                        // æ£€æŸ¥å…³é”®cookieæ˜¯å¦å­˜åœ¨
                        const foundKeyCookies = keyCookies.filter(key => 
                            allCookies.some(cookie => cookie.name === key)
                        );
                        console.log('æˆåŠŸæ³¨å…¥çš„å…³é”®cookie:', foundKeyCookies);
                        
                        // æ£€æŸ¥ç¼ºå¤±çš„å…³é”®cookie
                        const missingKeyCookies = keyCookies.filter(key => 
                            !allCookies.some(cookie => cookie.name === key)
                        );
                        if (missingKeyCookies.length > 0) {
                            console.log('ç¼ºå¤±çš„å…³é”®cookie:', missingKeyCookies);
                        }
                    }
                    
                    // 2. ç°åœ¨åŠ è½½URL
                    newWebview.src = targetUrl;
                }).catch(error => {
                    console.error('è·å–æ³¨å…¥åçš„cookieå¤±è´¥:', error);
                    // å³ä½¿è·å–cookieå¤±è´¥ï¼Œä»ç»§ç»­åŠ è½½URL
                    newWebview.src = targetUrl;
                });
            }).catch(error => {
                console.error('cookieæ³¨å…¥è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error);
                newWebview.src = targetUrl; // ä»»ä½•é”™è¯¯éƒ½ç»§ç»­åŠ è½½URL
            });
          }
        }
        if (event.data.type === "openWenxinAuth") {
          // æ‰“å¼€æ–‡å¿ƒæ™ºèƒ½ä½“æˆæƒé¡µé¢
          console.log("æ™ºèƒ½ä½“æ–°é¡µé¢æ”¶åˆ°çš„æ¶ˆæ¯:", event.data)
          console.log("æ‰“å¼€æ–‡å¿ƒæ™ºèƒ½ä½“æˆæƒé¡µé¢")
          window.electronAPI.openUrlInNewWindow({
            url: event.data.url,
            partition: `persist:wenxin_${event.data.accountId}`,
            acc_id: event.data.accountId,
            sendId: event.data.send_id,
            position: event.data.position,
            _type: 1, // ç™¾åº¦ç³»
            current_cookie: event.data.current_cookies
          });
          
        }
      });

      function showLoading() {
        // const loadingOverlay = document.getElementById("loadingOverlay");
        // loadingOverlay.classList.add("show");
        window.electronAPI.showGlobalLoading()
      }

      function hideLoading() {
        // const loadingOverlay = document.getElementById("loadingOverlay");
        // loadingOverlay.classList.remove("show");
        window.electronAPI.hideGlobalLoading()
      }
      
      

      function checkLoginStatus(url) {
        console.log("---éªŒè¯url", url);
        // console.log("è·å–åˆ°çš„æ•°æ®æ˜¯ï¼š", navItems);
        const a = navItems.find((item) => item.id === currentNavId);
        console.log("-----a------", a);
        
        // è·å–å½“å‰è´¦å·ä½ç½®ä¿¡æ¯ï¼ˆé»˜è®¤ä»windowå¯¹è±¡è·å–ï¼Œç”±hubé¡µé¢ä¼ é€’ï¼‰
        const currentPosition = window.currentAccountPosition || 1;
        // è·å–å½“å‰webviewçš„partition
        const webview = document.getElementById("browserView");
        const accountId = window.currentAccountId || webview.getAttribute('data-account-id');
        const partition = accountId ? `persist:account_${accountId}` : null;
        
        // ç™¾å®¶å·ç™»å½•æµç¨‹ï¼šä¾æ¬¡è®¿é—®ä¸‰ä¸ªå…³é”®åŸŸåè·å–å®Œæ•´cookie
        // 1. ç¬¬ä¸€æ­¥ï¼šç™¾å®¶å·é¦–é¡µ
        if (url.includes('baijiahao.baidu.com/builder/rc/home') && a && !a.flag) {
          // åˆå§‹åŒ–cookiesListä¸ºç©ºæ•°ç»„
          cookiesList = [];
          try {
            res = window.electronAPI.getCookies('https://baijiahao.baidu.com', partition);
            res.then((result) => {
              cookiesList.push(result);
              console.log('%cç™¾å®¶å·->>>>', 'color: red; font-weight: bold;', cookiesList);
              const webview = document.getElementById('browserView');
              setTimeout(() => {
                webview.src = "https://passport.baidu.com/";
              }, 2000);
            });
          } catch (error) {
            console.error('è·å–ç™¾å®¶å·é¦–é¡µcookieå¤±è´¥:', error);
          }
        }
        
        // 2. ç¬¬äºŒæ­¥ï¼šç™¾åº¦ç™»å½•é¡µ
        if (url.includes('https://passport.baidu.com/v6/ucenter') && a && !a.flag) {
          try {
            res = window.electronAPI.getCookies('https://passport.baidu.com', partition);
            res.then((result) => {
              cookiesList.push(result);
              console.log('%cç™¾åº¦->>>>', 'color: red; font-weight: bold;', cookiesList);
              const webview = document.getElementById('browserView');
              setTimeout(() => {
                webview.src = "https://agents.baidu.com/";
              }, 2000);
            });
          } catch (error) {
            console.error('è·å–ç™¾åº¦ç™»å½•é¡µcookieå¤±è´¥:', error);
          }
        }
        
        // 3. ç¬¬ä¸‰æ­¥ï¼šç™¾åº¦æ™ºèƒ½ä½“å¹³å°ï¼ˆæœ€ç»ˆç™»å½•æˆåŠŸï¼‰
        if (url.includes('agents.baidu.com/center') && a && !a.flag) {
            console.log("hubè§¦å‘è°ƒç”¨mainè¿›ç¨‹");
            // ä» iframe è·å–ä¼ é€’è¿‡æ¥çš„ acc_id
            const iframe = document.getElementById("hubFrame");
            let acc_id = null;
            try {
              const hubContent = iframe.contentWindow;
              if (hubContent && hubContent.currentAccountId) acc_id = hubContent.currentAccountId;
            } catch (e) {
              console.log("æ— æ³•ä»hubè·å–è´¦æˆ·ä¿¡æ¯");
            }
            // ä½¿ç”¨ä¹‹å‰ä¿å­˜çš„isMainå€¼ï¼Œç¡®ä¿ä¸»è´¦å·æ ‡è¯†æ­£ç¡®
            let isMain = window.currentAccountIsMain || 0;
            console.log('ä½¿ç”¨çš„å‚æ•°typeä¸º', currentNavId);
            console.log('ä½¿ç”¨çš„currentPositionä¸º', currentPosition);
            res = window.electronAPI.getCookies('https://agents.baidu.com/', partition);
            res.then((result) => {
              cookiesList.push(result);
              console.log('%cæ™ºèƒ½ä½“->>>>', 'color: red; font-weight: bold;', cookiesList);
              const result1 = window.electronAPI.saveUserCookies({
                    currentNavId,
                    cookiesList,
                    token,
                    sendId,
                    position: currentPosition,
                    isMain: isMain
                });
                // éªŒè¯cookieä¿¡æ¯
                const result2 = window.electronAPI.checkUserCookies({
                    currentNavId,
                    cookiesList,
                    token,
                    sendId,
                    acc_id: acc_id,
                    position: currentPosition,
                    is_main: isMain,
                    // type: currentNavId // æ·»åŠ ç¼ºå°‘çš„typeå­—æ®µï¼Œä½¿ç”¨currentNavIdä½œä¸ºtypeå€¼
                });
            });
            // ä¿å­˜cookieä¿¡æ¯ - ä½¿ç”¨ä¹‹å‰æ­£ç¡®è®¾ç½®çš„currentPositionï¼Œè€Œä¸æ˜¯ä»hubFrameé‡æ–°è·å–
            
            a.flag = true;
            setTimeout(() => {
              console.log("è·³è½¬å›ç™¾å®¶å·é¦–é¡µ");
              webview.src = "https://baijiahao.baidu.com/builder/rc/home";
            }, 5000);
            showSuccessMessage("ç™»å½•æˆåŠŸ");
            // });

            // æ‰€æœ‰å¹³å°æˆæƒæˆåŠŸï¼Œé€šçŸ¥ hub é¡µé¢åˆ·æ–°
            const hubFrame = document.getElementById("hubFrame");
            if (hubFrame && hubFrame.contentWindow) {
              hubFrame.contentWindow.postMessage({
                type: "accountAuthorized",
                menuId: currentNavId,
                userId: sendId
              }, "*");
            }
          // });
        }
        if (url.includes("https://mp.sohu.com/mpfe/v4/contentManagement/first/page") &&a && !a.flag ) {
          res = window.electronAPI.getCookies("https://mp.sohu.com", partition);
          res.then((result) => {
            cookiesList = [];
            cookiesList.push(...result);
            // ä¿å­˜cookieä¿¡æ¯
            const result1 = window.electronAPI.saveUserCookies({
              currentNavId,
              cookiesList,
              token,
              sendId,
              // acc_id: getCurrentAccountId()
              position: currentPosition,
              isMain: window.currentAccountIsMain || 0,
              // type: currentNavId // æ·»åŠ ç¼ºå°‘çš„typeå­—æ®µï¼Œä½¿ç”¨currentNavIdä½œä¸ºtypeå€¼
            });
            // éªŒè¯cookieä¿¡æ¯
            const result2 = window.electronAPI.checkUserCookies({
              currentNavId,
              cookiesList,
              token,
              sendId,
              // acc_id: getCurrentAccountId()
              position: currentPosition,
              isMain: window.currentAccountIsMain || 0,
              // type: currentNavId // æ·»åŠ ç¼ºå°‘çš„typeå­—æ®µï¼Œä½¿ç”¨currentNavIdä½œä¸ºtypeå€¼
            });
            a.flag = true;
          });
          showSuccessMessage("ç™»å½•æˆåŠŸ");
          
        }
        if ((url.includes("https://mp.toutiao.com/profile_v4/index") ||"profile_v4/index".includes(url)) &&a &&!a.flag) {
          res = window.electronAPI.getCookies("https://mp.toutiao.com", partition);
          res.then((result) => {
            cookiesList = [];
            cookiesList.push(...result);
            // ä¿å­˜cookieä¿¡æ¯
            const result1 = window.electronAPI.saveUserCookies({
              currentNavId,
              cookiesList,
              token,
              sendId,
              position: currentPosition,
              // type: currentNavId // æ·»åŠ ç¼ºå°‘çš„typeå­—æ®µï¼Œä½¿ç”¨currentNavIdä½œä¸ºtypeå€¼
            });
            // éªŒè¯cookieä¿¡æ¯
            const result2 = window.electronAPI.checkUserCookies({
              currentNavId,
              cookiesList,
              token,
              sendId,
              position: currentPosition,
              // type: currentNavId // æ·»åŠ ç¼ºå°‘çš„typeå­—æ®µï¼Œä½¿ç”¨currentNavIdä½œä¸ºtypeå€¼
            });
            a.flag = true;
          });
          showSuccessMessage("ç™»å½•æˆåŠŸ");
        }
        if (url.includes("https://mp.sina.com.cn/#") && a && !a.flag) {
          res = window.electronAPI.getCookies("https://mp.sina.com.cn", partition);
          res.then((result) => {
            cookiesList = [];
            cookiesList.push(...result);

            // ä¿å­˜cookieä¿¡æ¯
            const result1 = window.electronAPI.saveUserCookies({
              currentNavId,
              cookiesList,
              token,
              sendId,
              position: currentPosition,
              // type: currentNavId // æ·»åŠ ç¼ºå°‘çš„typeå­—æ®µï¼Œä½¿ç”¨currentNavIdä½œä¸ºtypeå€¼
            });
            const result2 = window.electronAPI.checkUserCookies({
              currentNavId,
              cookiesList,
              token,
              sendId,
              position: currentPosition,
              // type: currentNavId // æ·»åŠ ç¼ºå°‘çš„typeå­—æ®µï¼Œä½¿ç”¨currentNavIdä½œä¸ºtypeå€¼
            });
            a.flag = true;
          });
          showSuccessMessage("ç™»å½•æˆåŠŸ");
        }
        if (url.includes("https://om.qq.com/main") && a && !a.flag) {
          res = window.electronAPI.getCookies("https://om.qq.com", partition);
          res.then((result) => {
            cookiesList = [];
            cookiesList.push(...result);
            // ä¿å­˜cookieä¿¡æ¯
            const result1 = window.electronAPI.saveUserCookies({
              currentNavId,
              cookiesList,
              token,
              sendId,
              position: currentPosition,
              // type: currentNavId // æ·»åŠ ç¼ºå°‘çš„typeå­—æ®µï¼Œä½¿ç”¨currentNavIdä½œä¸ºtypeå€¼
            });
            const result2 = window.electronAPI.checkUserCookies({
              currentNavId,
              cookiesList,
              token,
              sendId,
              position: currentPosition,
              isMain: window.currentAccountIsMain || 0
            });
            
            // ä½¿ç”¨Promise.allè·Ÿè¸ªç»“æœ
            Promise.all([result1, result2]).then((results) => {
              console.log('saveUserCookiesç»“æœ:', results[0]);
              console.log('checkUserCookiesç»“æœ:', results[1]);
            });
            
            a.flag = true;
            a.flag = true;
          });
          showSuccessMessage("ç™»å½•æˆåŠŸ");
        }
        // ç½‘æ˜“å¹³å°ç™»å½•æˆåŠŸå¤„ç†
        // if (url.includes("https://mp.163.com/login.html#/") && a && !a.flag) {
        if (url.includes("mp.163.com") && !url.includes("login.html") && a && !a.flag){
          res = window.electronAPI.getCookies("https://mp.163.com/#/", partition);
          console.log("è¿›å…¥åˆ°ç½‘æ˜“å¹³å°ç™»å½•æˆåŠŸå¤„ç†");
          res.then((result) => {
            cookiesList = [];
            console.log("è·å–åˆ°çš„cookies:", result);
            // if (result && Array.isArray(result)) {
            cookiesList.push(...result); // ä½¿ç”¨spreadè¿ç®—ç¬¦æ‰å¹³åŒ–æ•°ç»„
            // }
            
            // cookiesList.push(result);
            // ä¿å­˜cookieä¿¡æ¯
            const result1 = window.electronAPI.saveUserCookies({
              currentNavId,
              cookiesList,
              token,
              sendId,
              position: currentPosition,
              // type: currentNavId // æ·»åŠ ç¼ºå°‘çš„typeå­—æ®µï¼Œä½¿ç”¨currentNavIdä½œä¸ºtypeå€¼
            });
            const result2 = window.electronAPI.checkUserCookies({
              currentNavId,
              cookiesList,
              token,
              sendId,
              position: currentPosition,
              isMain: window.currentAccountIsMain || 0
            });
            
            a.flag = true;
            showSuccessMessage("ç™»å½•æˆåŠŸ");
            
            // é€šçŸ¥ hub é¡µé¢åˆ·æ–°è´¦å·çŠ¶æ€
            const hubFrame = document.getElementById("hubFrame");
            if (hubFrame && hubFrame.contentWindow) {
              hubFrame.contentWindow.postMessage({
                type: "accountAuthorized",
                menuId: currentNavId,
                userId: sendId
              }, "*");
            }
          });
        }
        if (url.includes("http://zs.open.chuangmaedu.com/openPlatform/callback") && a && !a.flag ) {
            const data = {
                'type': currentNavId,
                'json_str': sendId,
                'time': Math.floor(Date.now() / 1000).toString(),
                'send_id': sendId,
                'position': currentPosition
            };
            const headers = {
                'Content-Type': 'application/json',
            };
            fetch('http:///47.93.80.212:8000/api/desktop/check/sign/', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(data)
            }).then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            }).then(data => {
                // è¯·æ±‚æˆåŠŸæ—¶å¤„ç†å“åº”æ•°æ®
                console.log('å¾®ä¿¡å…¬ä¼—å·å“åº”æ•°æ®:', data.data);
                const cookiesList = {'appid': data.data };
                // const result1 = window.electronAPI.saveUserCookies({ currentNavId, cookiesList, token, sendId });
                return data; // è¿”å›å¤„ç†åçš„æ•°æ®
            }).catch(error => {
                // è¯·æ±‚å¤±è´¥æ—¶å¤„ç†é”™è¯¯
                console.error('HTTP error! status:', error);
                return null;
            });
            // é€šçŸ¥ hub é¡µé¢åˆ·æ–°è´¦å·çŠ¶æ€
            const hubFrame = document.getElementById("hubFrame");
            if (hubFrame && hubFrame.contentWindow) {
              hubFrame.contentWindow.postMessage({
                type: "accountAuthorized",
                menuId: currentNavId,
                userId: sendId
              }, "*");
            }
            a.flag = true;
            showSuccessMessage("ç™»å½•æˆåŠŸ");
        }
      }

      function showSuccessMessage(message) {
        const messageBox = document.createElement("div");
        messageBox.className = "message-box";
        messageBox.innerHTML = `
                <h3>âœ“ æˆåŠŸ</h3>
                <p>${message}</p>
                <button onclick="this.parentElement.remove()">ç¡®å®š</button>
            `;
        document.body.appendChild(messageBox);

        setTimeout(() => {
          if (messageBox.parentElement) {
            messageBox.remove();
          }
        }, 3000);
      }

      function updateAuthorization() {
        console.log("å¼€å§‹æ›´æ–°æˆæƒ...");
        // ç¡®ä¿ currentPosition å·²å®šä¹‰
        let currentPosition;
        if (typeof window.currentAccountPosition !== 'undefined') {
          currentPosition = window.currentAccountPosition;
        } else {
          currentPosition = 0; // è®¾ç½®é»˜è®¤å€¼
        }
        console.log("å½“å‰è´¦å·ä½ç½®:", currentPosition);
        showLoading();
        
        const webview = document.getElementById("browserView");
        const currentUrl = webview.getURL();
        
        // è·å–å½“å‰å¯¼èˆªé¡¹ï¼Œé‡ç½®flagä»¥ä¾¿é‡æ–°æ‰§è¡Œæˆæƒæµç¨‹
        const a = navItems.find((item) => item.id === currentNavId);
        if (a) {
          a.flag = false; // é‡ç½®flagï¼Œå…è®¸é‡æ–°æ‰§è¡Œæˆæƒæµç¨‹
          console.log("å·²é‡ç½®å¯¼èˆªé¡¹flagä¸ºfalse:", a);
        }
        
        // å¤„ç†ç™¾å®¶å·ç‰¹æ®Šæˆæƒæµç¨‹ï¼Œéœ€è¦è·³è½¬ä¸‰ä¸ªé¡µé¢
        if (currentUrl.includes("baijiahao.baidu.com")) {
          // ç›´æ¥è·³è½¬åˆ°ç™¾åº¦ç™»å½•é¡µï¼Œå¯åŠ¨å®Œæ•´çš„ä¸‰é¡µé¢æˆæƒæµç¨‹
           // è§¦å‘è·å–é¦–é¡µcookie
          console.log("å¯åŠ¨ç™¾å®¶å·å®Œæ•´æˆæƒæµç¨‹");
          // webview.src = "https://passport.baidu.com/";
          cookiesList = [];
          webview.src = "https://baijiahao.baidu.com/builder/rc/home";
          // webview.src = "https://agents.baidu.com/";
          // checkLoginStatus(currentUrl);
          hideLoading();
          showSuccessMessage("å·²å¯åŠ¨æˆæƒæµç¨‹ï¼Œè¯·ç­‰å¾…é¡µé¢è·³è½¬å®Œæˆ");
          return;
        } 
        
        // å…¶ä»–å¹³å°ä¿æŒåŸæœ‰é€»è¾‘ï¼Œç›´æ¥è·å–å½“å‰é¡µé¢cookie
        let domain = "";
        if (currentUrl.includes("mp.sohu.com")) {
          domain = "https://mp.sohu.com";
        } else if (currentUrl.includes("mp.toutiao.com")) {
          domain = "https://mp.toutiao.com";
        } else if (currentUrl.includes("mp.sina.com.cn")) {
          domain = "https://mp.sina.com.cn";
        } else if (currentUrl.includes("om.qq.com")) {
          domain = "https://om.qq.com";
        } else if (currentUrl.includes("post.smzdm.com")) {
          domain = "https://post.smzdm.com";
        } else if (currentUrl.includes("mp.163.com")) {
          domain = "https://mp.163.com";
        } else {
          hideLoading();
          showSuccessMessage("å½“å‰é¡µé¢ä¸æ”¯æŒæ›´æ–°æˆæƒ");
          return;
        }
        
        // è·å–å½“å‰è´¦å·ä¿¡æ¯ï¼Œç”¨äºæ„å»ºpartition
        const accountId = window.currentAccountId || webview.getAttribute('data-account-id');
        const partition = accountId ? `persist:account_${accountId}` : null;
        console.log("ä½¿ç”¨çš„partition:", partition, "accountId:", accountId);
        
        window.electronAPI
          .getCookies(domain, partition)
          .then((result) => {
            console.log("è·å–åˆ°çš„cookies:", result);
            // const result2 = window.electronAPI.checkUserCookies({
            //   currentNavId,
            //   cookiesList: result,
            //   token,
            //   sendId,
            //   position: currentPosition,
            //   // type: currentNavId // æ·»åŠ ç¼ºå°‘çš„typeå­—æ®µï¼Œä½¿ç”¨currentNavIdä½œä¸ºtypeå€¼
            // });
            
            // åˆå§‹åŒ–cookiesListå˜é‡
            // const cookiesList = result
            // ä¿å­˜cookieä¿¡æ¯
            const result1 = window.electronAPI.saveUserCookies({
              currentNavId,
              cookiesList: result,
              token,
              sendId,
              acc_id: accountId,
              position: currentPosition,
              // is_main: window.currentAccountIsMain || 0
            });
            
            
            // éªŒè¯cookieä¿¡æ¯
            const result2 = window.electronAPI.checkUserCookies({
              currentNavId,
              cookiesList: result,
              token,
              sendId,
              acc_id: accountId,
              position: currentPosition,
              is_main: window.currentAccountIsMain || 0
            });
            console.log("checkUserCookiesç»“æœ:", result2);
            hideLoading();
            showSuccessMessage("æˆæƒæ›´æ–°æˆåŠŸ");
          })
          .catch((error) => {
            console.error("æ›´æ–°æˆæƒå¤±è´¥:", error);
            hideLoading();
            showSuccessMessage("æˆæƒæ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•");
          });
      }

      function setupNavigationListener(callback) {
        window.addEventListener("hashchange", () =>
          callback({
            type: "hashchange",
            url: window.location.href,
          })
        );
        window.addEventListener("locationchange", (e) =>
          callback({
            type: e.detail.method,
            url: e.detail.url,
          })
        );
        window.addEventListener("load", () =>
          callback({
            type: "load",
            url: window.location.href,
          })
        );
      }

      setupNavigationListener((event) => {
        console.log("Navigation event:", event);
      });

      function sendUrl() {
        const data = {
          type: currentNavId,
          json_str: JSON.stringify(cookiesList),
          time: Math.floor(Date.now() / 1000).toString(),
          send_id: sendId,
        };
        const headers = {
          "Content-Type": "application/json",
        };
        fetch(checkUrl + "/desktop/check/sign/", {
          method: "POST",
          headers: headers,
          body: JSON.stringify(data),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            console.log("data:", data);
            return data;
          })
          .catch((error) => {
            console.error("è¯·æ±‚å¤±è´¥:", error);
            return null;
          });
      }
    </script>
  </body>
</html>